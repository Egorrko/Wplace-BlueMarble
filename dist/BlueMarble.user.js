// ==UserScript==
// @name         Freakland
// @namespace    https://github.com/Egorrko/Wplace-Freakland
// @version      0.86.0
// @icon         https://raw.githubusercontent.com/Egorrko/Wplace-Freakland/refs/heads/main/favicon.png
// @match        https://wplace.live/*
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @grant        GM.setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @connect      freakland.egorrko.ru
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/
(()=>{var Ye=o=>{throw TypeError(o)};var Ft=(o,e,t)=>e.has(o)||Ye("Cannot "+t);var Y=(o,e,t)=>e.has(o)?Ye("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(o):e.set(o,t);var L=(o,e,t)=>(Ft(o,e,"access private method"),t);var D,N,J=class{constructor(e,t){Y(this,D);this.name=e,this.version=t,this.apiManager=null,this.outputStatusId="bm-output-status",this.overlay=null,this.currentParent=null,this.parentStack=[]}setApiManager(e){this.apiManager=e}buildElement(){return this.parentStack.length>0&&(this.currentParent=this.parentStack.pop()),this}buildOverlay(e){e?.appendChild(this.overlay),this.overlay=null,this.currentParent=null,this.parentStack=[]}addDiv(e={},t=()=>{}){let i={},s=L(this,D,N).call(this,"div",i,e);return t(this,s),this}addP(e={},t=()=>{}){let i={},s=L(this,D,N).call(this,"p",i,e);return t(this,s),this}addSmall(e={},t=()=>{}){let i={},s=L(this,D,N).call(this,"small",i,e);return t(this,s),this}addHyperLink(e={},t=()=>{}){let i={},s=L(this,D,N).call(this,"a",i,e);return t(this,s),this}addImg(e={},t=()=>{}){let i={},s=L(this,D,N).call(this,"img",i,e);return t(this,s),this}addHeader(e,t={},i=()=>{}){let s={},n=L(this,D,N).call(this,"h"+e,s,t);return i(this,n),this}addHr(e={},t=()=>{}){let i={},s=L(this,D,N).call(this,"hr",i,e);return t(this,s),this}addBr(e={},t=()=>{}){let i={},s=L(this,D,N).call(this,"br",i,e);return t(this,s),this}addCheckbox(e={},t=()=>{}){let i={type:"checkbox"},s=L(this,D,N).call(this,"label",{textContent:e.textContent??""});delete e.textContent;let n=L(this,D,N).call(this,"input",i,e);return s.insertBefore(n,s.firstChild),this.buildElement(),t(this,s,n),this}addButton(e={},t=()=>{}){let i={},s=L(this,D,N).call(this,"button",i,e);return t(this,s),this}addButtonHelp(e={},t=()=>{}){let i=e.title??e.textContent??"Help: No info";delete e.textContent,e.title=`Help: ${i}`;let s={textContent:"?",className:"bm-help",onclick:()=>{this.updateInnerHTML(this.outputStatusId,i)}},n=L(this,D,N).call(this,"button",s,e);return t(this,n),this}addInput(e={},t=()=>{}){let i={},s=L(this,D,N).call(this,"input",i,e);return t(this,s),this}addSelector(e={},t=()=>{}){console.log("additionalProperties",e);let i={},s=L(this,D,N).call(this,"select",i,e);return t(this,s),this}addInputFile(e={},t=()=>{}){let i={type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},s=e.textContent??"";delete e.textContent;let n=L(this,D,N).call(this,"div"),r=L(this,D,N).call(this,"input",i,e);this.buildElement();let a=L(this,D,N).call(this,"button",{textContent:s});return this.buildElement(),this.buildElement(),r.setAttribute("tabindex","-1"),r.setAttribute("aria-hidden","true"),a.addEventListener("click",()=>{r.click()}),r.addEventListener("change",()=>{a.style.maxWidth=`${a.offsetWidth}px`,r.files.length>0?a.textContent=r.files[0].name:a.textContent=s}),t(this,n,r,a),this}addTextarea(e={},t=()=>{}){let i={},s=L(this,D,N).call(this,"textarea",i,e);return t(this,s),this}updateInnerHTML(e,t,i=!1){let s=document.getElementById(e.replace(/^#/,""));if(s){if(s instanceof HTMLInputElement){s.value=t;return}i?s.textContent=t:s.innerHTML=t}}handleDrag(e,t){let i=!1,s,n=0,r=null,a=0,l=0,c=0,h=0;if(e=document.querySelector(e?.[0]=="#"?e:"#"+e),t=document.querySelector(t?.[0]=="#"?t:"#"+t),!e||!t){this.handleDisplayError(`Can not drag! ${e?"":"moveMe"} ${!e&&!t?"and ":""}${t?"":"iMoveThings "}was not found!`);return}let p=()=>{if(i){let u=Math.abs(a-c),m=Math.abs(l-h);(u>.5||m>.5)&&(a=c,l=h,e.style.transform=`translate(${a}px, ${l}px)`,e.style.left="0px",e.style.top="0px",e.style.right=""),r=requestAnimationFrame(p)}},d=null,g=(u,m)=>{i=!0,d=e.getBoundingClientRect(),s=u-d.left,n=m-d.top;let y=window.getComputedStyle(e).transform;if(y&&y!=="none"){let v=new DOMMatrix(y);a=v.m41,l=v.m42}else a=d.left,l=d.top;c=a,h=l,document.body.style.userSelect="none",t.classList.add("dragging"),r&&cancelAnimationFrame(r),p()},f=()=>{i=!1,r&&(cancelAnimationFrame(r),r=null),document.body.style.userSelect="",t.classList.remove("dragging")};t.addEventListener("mousedown",function(u){u.preventDefault(),g(u.clientX,u.clientY)}),t.addEventListener("touchstart",function(u){let m=u?.touches?.[0];m&&(g(m.clientX,m.clientY),u.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(u){i&&d&&(c=u.clientX-s,h=u.clientY-n)},{passive:!0}),document.addEventListener("touchmove",function(u){if(i&&d){let m=u?.touches?.[0];if(!m)return;c=m.clientX-s,h=m.clientY-n,u.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",f),document.addEventListener("touchend",f),document.addEventListener("touchcancel",f)}handleDisplayStatus(e){let t=console.info;t(`${this.name}: ${e}`),this.updateInnerHTML(this.outputStatusId,"Status: "+e,!0)}handleDisplayError(e){let t=console.error;t(`${this.name}: ${e}`),this.updateInnerHTML(this.outputStatusId,"Error: "+e,!0)}handleSelectorStatus(e){let t=document.querySelector("#bm-selector-templates");t.innerHTML="";for(let i of e){let s=document.createElement("option");s.value=JSON.stringify(i.value),s.textContent=i.label,t.appendChild(s)}}};D=new WeakSet,N=function(e,t={},i={}){let s=document.createElement(e);this.overlay?(this.currentParent?.appendChild(s),this.parentStack.push(this.currentParent),this.currentParent=s):(this.overlay=s,this.currentParent=s);for(let[n,r]of Object.entries(t))s[n]=r;for(let[n,r]of Object.entries(i))s[n]=r;return s};var ee=class{constructor(){this.observerBody=null,this.observerBodyTarget=null,this.targetDisplayCoords="#bm-display-coords"}createObserverBody(e){return this.observerBodyTarget=e,this.observerBody=new MutationObserver(t=>{for(let i of t)for(let s of i.addedNodes)s instanceof HTMLElement&&s.matches?.(this.targetDisplayCoords)}),this}getObserverBody(){return this.observerBody}observe(e,t=!1,i=!1){e.observe(this.observerBodyTarget,{childList:t,subtree:i})}};function Je(o){let e=document.createElement("div");return e.textContent=o,e.innerHTML}function ze(o,e){return[parseInt(o[0])%4*1e3+parseInt(e[0]),parseInt(o[1])%4*1e3+parseInt(e[1])]}function Xe(...o){(e=>e(...o))(console.log)}function te(...o){(e=>e(...o))(console.error)}function Ze(...o){(e=>e(...o))(console.warn)}function de(o,e){if(o===0)return e[0];let t="",i=e.length;for(;o>0;)t=e[o%i]+t,o=Math.floor(o/i);return t}function Qe(o){let e="";for(let t=0;t<o.length;t++)e+=String.fromCharCode(o[t]);return btoa(e)}function et(o){let e=atob(o),t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}var xe=[{id:0,premium:!1,name:"Transparent",rgb:[0,0,0]},{id:1,premium:!1,name:"Black",rgb:[0,0,0]},{id:2,premium:!1,name:"Dark Gray",rgb:[60,60,60]},{id:3,premium:!1,name:"Gray",rgb:[120,120,120]},{id:4,premium:!1,name:"Light Gray",rgb:[210,210,210]},{id:5,premium:!1,name:"White",rgb:[255,255,255]},{id:6,premium:!1,name:"Deep Red",rgb:[96,0,24]},{id:7,premium:!1,name:"Red",rgb:[237,28,36]},{id:8,premium:!1,name:"Orange",rgb:[255,127,39]},{id:9,premium:!1,name:"Gold",rgb:[246,170,9]},{id:10,premium:!1,name:"Yellow",rgb:[249,221,59]},{id:11,premium:!1,name:"Light Yellow",rgb:[255,250,188]},{id:12,premium:!1,name:"Dark Green",rgb:[14,185,104]},{id:13,premium:!1,name:"Green",rgb:[19,230,123]},{id:14,premium:!1,name:"Light Green",rgb:[135,255,94]},{id:15,premium:!1,name:"Dark Teal",rgb:[12,129,110]},{id:16,premium:!1,name:"Teal",rgb:[16,174,166]},{id:17,premium:!1,name:"Light Teal",rgb:[19,225,190]},{id:18,premium:!1,name:"Dark Blue",rgb:[40,80,158]},{id:19,premium:!1,name:"Blue",rgb:[64,147,228]},{id:20,premium:!1,name:"Cyan",rgb:[96,247,242]},{id:21,premium:!1,name:"Indigo",rgb:[107,80,246]},{id:22,premium:!1,name:"Light Indigo",rgb:[153,177,251]},{id:23,premium:!1,name:"Dark Purple",rgb:[120,12,153]},{id:24,premium:!1,name:"Purple",rgb:[170,56,185]},{id:25,premium:!1,name:"Light Purple",rgb:[224,159,249]},{id:26,premium:!1,name:"Dark Pink",rgb:[203,0,122]},{id:27,premium:!1,name:"Pink",rgb:[236,31,128]},{id:28,premium:!1,name:"Light Pink",rgb:[243,141,169]},{id:29,premium:!1,name:"Dark Brown",rgb:[104,70,52]},{id:30,premium:!1,name:"Brown",rgb:[149,104,42]},{id:31,premium:!1,name:"Beige",rgb:[248,178,119]},{id:32,premium:!0,name:"Medium Gray",rgb:[170,170,170]},{id:33,premium:!0,name:"Dark Red",rgb:[165,14,30]},{id:34,premium:!0,name:"Light Red",rgb:[250,128,114]},{id:35,premium:!0,name:"Dark Orange",rgb:[228,92,26]},{id:36,premium:!0,name:"Light Tan",rgb:[214,181,148]},{id:37,premium:!0,name:"Dark Goldenrod",rgb:[156,132,49]},{id:38,premium:!0,name:"Goldenrod",rgb:[197,173,49]},{id:39,premium:!0,name:"Light Goldenrod",rgb:[232,212,95]},{id:40,premium:!0,name:"Dark Olive",rgb:[74,107,58]},{id:41,premium:!0,name:"Olive",rgb:[90,148,74]},{id:42,premium:!0,name:"Light Olive",rgb:[132,197,115]},{id:43,premium:!0,name:"Dark Cyan",rgb:[15,121,159]},{id:44,premium:!0,name:"Light Cyan",rgb:[187,250,242]},{id:45,premium:!0,name:"Light Blue",rgb:[125,199,255]},{id:46,premium:!0,name:"Dark Indigo",rgb:[77,49,184]},{id:47,premium:!0,name:"Dark Slate Blue",rgb:[74,66,132]},{id:48,premium:!0,name:"Slate Blue",rgb:[122,113,196]},{id:49,premium:!0,name:"Light Slate Blue",rgb:[181,174,241]},{id:50,premium:!0,name:"Light Brown",rgb:[219,164,99]},{id:51,premium:!0,name:"Dark Beige",rgb:[209,128,81]},{id:52,premium:!0,name:"Light Beige",rgb:[255,197,165]},{id:53,premium:!0,name:"Dark Peach",rgb:[155,82,73]},{id:54,premium:!0,name:"Peach",rgb:[209,128,120]},{id:55,premium:!0,name:"Light Peach",rgb:[250,182,164]},{id:56,premium:!0,name:"Dark Tan",rgb:[123,99,82]},{id:57,premium:!0,name:"Tan",rgb:[156,132,107]},{id:58,premium:!0,name:"Dark Slate",rgb:[51,57,65]},{id:59,premium:!0,name:"Slate",rgb:[109,117,141]},{id:60,premium:!0,name:"Light Slate",rgb:[179,185,209]},{id:61,premium:!0,name:"Dark Stone",rgb:[109,100,63]},{id:62,premium:!0,name:"Stone",rgb:[148,140,107]},{id:63,premium:!0,name:"Light Stone",rgb:[205,197,158]}];var z=class{constructor({displayName:e="My template",sortID:t=0,authorID:i="",url:s="",file:n=null,coords:r=null,chunked:a=null,tileSize:l=1e3}={}){this.displayName=e,this.sortID=t,this.authorID=i,this.url=s,this.file=n,this.coords=r,this.chunked=a,this.tileSize=l,this.pixelCount=0,this.requiredPixelCount=0,this.defacePixelCount=0,this.colorPalette={},this.tilePrefixes=new Set,this.storageKey=null;let c=Array.isArray(xe)?xe:[];this.allowedColorsSet=new Set(c.filter(d=>(d?.name||"").toLowerCase()!=="transparent"&&Array.isArray(d?.rgb)).map(d=>`${d.rgb[0]},${d.rgb[1]},${d.rgb[2]}`));let h="222,250,206";this.allowedColorsSet.add(h);let p="other";this.allowedColorsSet.add(p),this.rgbToMeta=new Map(c.filter(d=>Array.isArray(d?.rgb)).map(d=>[`${d.rgb[0]},${d.rgb[1]},${d.rgb[2]}`,{id:d.id,premium:!!d.premium,name:d.name}]));try{let d=c.find(g=>(g?.name||"").toLowerCase()==="transparent");d&&Array.isArray(d.rgb)&&this.rgbToMeta.set(h,{id:d.id,premium:!!d.premium,name:d.name})}catch{}try{this.rgbToMeta.set(p,{id:"other",premium:!1,name:"Other"})}catch{}console.log("Allowed colors for template:",this.allowedColorsSet)}async createTemplateTiles(){console.log("Template coordinates:",this.coords);let e=3,t=await createImageBitmap(this.file),i=t.width,s=t.height,n=i*s;console.log(`Template pixel analysis - Dimensions: ${i}\xD7${s} = ${n.toLocaleString()} pixels`),this.pixelCount=n;try{let p=new OffscreenCanvas(i,s).getContext("2d",{willReadFrequently:!0});p.imageSmoothingEnabled=!1,p.clearRect(0,0,i,s),p.drawImage(t,0,0);let d=p.getImageData(0,0,i,s).data,g=0,f=0,u=new Map;for(let b=0;b<s;b++)for(let y=0;y<i;y++){let v=(b*i+y)*4,w=d[v],S=d[v+1],I=d[v+2];if(d[v+3]===0)continue;w===222&&S===250&&I===206&&f++;let E=this.allowedColorsSet.has(`${w},${S},${I}`)?`${w},${S},${I}`:"other";g++,u.set(E,(u.get(E)||0)+1)}this.requiredPixelCount=g,this.defacePixelCount=f;let m={};for(let[b,y]of u.entries())m[b]={count:y,enabled:!0};this.colorPalette=m}catch(h){this.requiredPixelCount=Math.max(0,this.pixelCount),this.defacePixelCount=0,console.warn("Failed to compute required/deface counts. Falling back to total pixels.",h)}let r={},a={},l=new OffscreenCanvas(this.tileSize,this.tileSize),c=l.getContext("2d",{willReadFrequently:!0});for(let h=this.coords[3];h<s+this.coords[3];){let p=Math.min(this.tileSize-h%this.tileSize,s-(h-this.coords[3]));console.log(`Math.min(${this.tileSize} - (${h} % ${this.tileSize}), ${s} - (${h-this.coords[3]}))`);for(let d=this.coords[2];d<i+this.coords[2];){console.log(`Pixel X: ${d}
Pixel Y: ${h}`);let g=Math.min(this.tileSize-d%this.tileSize,i-(d-this.coords[2]));console.log(`Math.min(${this.tileSize} - (${d} % ${this.tileSize}), ${i} - (${d-this.coords[2]}))`),console.log(`Draw Size X: ${g}
Draw Size Y: ${p}`);let f=g*e,u=p*e;l.width=f,l.height=u,console.log(`Draw X: ${g}
Draw Y: ${p}
Canvas Width: ${f}
Canvas Height: ${u}`),c.imageSmoothingEnabled=!1,console.log(`Getting X ${d}-${d+g}
Getting Y ${h}-${h+p}`),c.clearRect(0,0,f,u),c.drawImage(t,d-this.coords[2],h-this.coords[3],g,p,0,0,g*e,p*e);let m=c.getImageData(0,0,f,u);for(let S=0;S<u;S++)for(let I=0;I<f;I++){let x=(S*f+I)*4;if(m.data[x]===222&&m.data[x+1]===250&&m.data[x+2]===206)(I+S)%2===0?(m.data[x]=0,m.data[x+1]=0,m.data[x+2]=0):(m.data[x]=255,m.data[x+1]=255,m.data[x+2]=255),m.data[x+3]=32;else if(I%e!==1||S%e!==1)m.data[x+3]=0;else{let E=m.data[x],C=m.data[x+1],M=m.data[x+2];this.allowedColorsSet.has(`${E},${C},${M}`)}}console.log(`Shreaded pixels for ${d}, ${h}`,m),c.putImageData(m,0,0);let b=`${(this.coords[0]+Math.floor(d/1e3)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(h/1e3)).toString().padStart(4,"0")},${(d%1e3).toString().padStart(3,"0")},${(h%1e3).toString().padStart(3,"0")}`;r[b]=await createImageBitmap(l),this.tilePrefixes.add(b.split(",").slice(0,2).join(","));let v=await(await l.convertToBlob()).arrayBuffer(),w=Array.from(new Uint8Array(v));a[b]=Qe(w),console.log(r),d+=g}h+=p}return console.log("Template Tiles: ",r),console.log("Template Tiles Buffers: ",a),{templateTiles:r,templateTilesBuffers:a}}};var W,Rt,tt,it,Ht,ie=class{constructor(e,t,i){Y(this,W);this.name=e,this.version=t,this.overlay=i,this.templatesVersion="1.0.0",this.userID=null,this.encodingBase="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.tileSize=1e3,this.drawMult=3,this.canvasTemplate=null,this.canvasTemplateZoomed=null,this.canvasTemplateID="bm-canvas",this.canvasMainID="div#map canvas.maplibregl-canvas",this.template=null,this.templateState="",this.templatesArray=[],this.templatesJSON=null,this.templatesShouldBeDrawn=!0,this.tileProgress=new Map}getCanvas(){if(document.body.contains(this.canvasTemplate))return this.canvasTemplate;document.getElementById(this.canvasTemplateID)?.remove();let e=document.querySelector(this.canvasMainID),t=document.createElement("canvas");return t.id=this.canvasTemplateID,t.className="maplibregl-canvas",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.height=`${e?.clientHeight*(window.devicePixelRatio||1)}px`,t.style.width=`${e?.clientWidth*(window.devicePixelRatio||1)}px`,t.height=e?.clientHeight*(window.devicePixelRatio||1),t.width=e?.clientWidth*(window.devicePixelRatio||1),t.style.zIndex="8999",t.style.pointerEvents="none",e?.parentElement?.appendChild(t),this.canvasTemplate=t,window.addEventListener("move",this.onMove),window.addEventListener("zoom",this.onZoom),window.addEventListener("resize",this.onResize),this.canvasTemplate}async createJSON(){return{whoami:this.name.replace(" ",""),scriptVersion:this.version,schemaVersion:this.templatesVersion,templates:{}}}async createTemplate(e,t,i,s){this.templatesJSON||(this.templatesJSON=await this.createJSON(),console.log("Creating JSON...")),this.overlay.handleDisplayStatus(`\u0413\u0435\u043D\u0435\u0440\u0430\u0446\u0438\u044F \u0448\u0430\u0431\u043B\u043E\u043D\u0430 \u043D\u0430 ${s.join(", ")}...`);let n=new z({displayName:i,sortID:0,authorID:de(this.userID||0,this.encodingBase),file:e,coords:s}),{templateTiles:r,templateTilesBuffers:a}=await n.createTemplateTiles(this.tileSize);n.chunked=r;let l=`${n.sortID} ${n.authorID}`;n.storageKey=l,this.templatesJSON.templates[l]={name:n.displayName,template_id:t,coords:s.join(", "),enabled:!0,tiles:a,palette:n.colorPalette},this.templatesArray=[],this.templatesArray.push(n);let c=new Intl.NumberFormat().format(n.pixelCount);this.overlay.handleDisplayStatus(`\u0413\u0435\u043D\u0435\u0440\u0430\u0446\u0438\u044F \u0448\u0430\u0431\u043B\u043E\u043D\u0430 \u043D\u0430 ${s.join(", ")}! \u041E\u0431\u0449\u0435\u0435 \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u043F\u0438\u043A\u0441\u0435\u043B\u0435\u0439: ${c}`);try{let h=document.querySelector("#bm-contain-colorfilter");h&&(h.style.display=""),window.postMessage({source:"blue-marble",bmEvent:"bm-rebuild-color-list"},"*")}catch{}console.log(Object.keys(this.templatesJSON.templates).length),console.log(this.templatesJSON),console.log(this.templatesArray),console.log(JSON.stringify(this.templatesJSON)),await L(this,W,tt).call(this)}deleteTemplate(){}async disableTemplate(){this.templatesJSON||(this.templatesJSON=await this.createJSON(),console.log("Creating JSON..."))}async drawTemplateOnTile(e,t){if(!this.templatesShouldBeDrawn)return e;let i=this.tileSize*this.drawMult;t=t[0].toString().padStart(4,"0")+","+t[1].toString().padStart(4,"0"),console.log(`Searching for templates in tile: "${t}"`);let s=this.templatesArray;if(console.log(s),s.sort((u,m)=>u.sortID-m.sortID),console.log(s),!s.some(u=>u?.chunked?u.tilePrefixes&&u.tilePrefixes.size>0?u.tilePrefixes.has(t):Object.keys(u.chunked).some(m=>m.startsWith(t)):!1))return e;let r=s.map(u=>{let m=Object.keys(u.chunked).filter(y=>y.startsWith(t));return m.length===0?null:m.map(y=>{let v=y.split(",");return{bitmap:u.chunked[y],tileCoords:[v[0],v[1]],pixelCoords:[v[2],v[3]]}})?.[0]}).filter(Boolean);console.log(r);let a=r?.length||0;console.log(`templateCount = ${a}`);let l=0,c=0,h=0,p=await createImageBitmap(e),d=new OffscreenCanvas(i,i),g=d.getContext("2d");g.imageSmoothingEnabled=!1,g.beginPath(),g.rect(0,0,i,i),g.clip(),g.clearRect(0,0,i,i),g.drawImage(p,0,0,i,i);let f=null;try{f=g.getImageData(0,0,i,i).data}catch{}for(let u of r){if(console.log("Template:"),console.log(u),f)try{let m=u.bitmap.width,b=u.bitmap.height,v=new OffscreenCanvas(m,b).getContext("2d",{willReadFrequently:!0});v.imageSmoothingEnabled=!1,v.clearRect(0,0,m,b),v.drawImage(u.bitmap,0,0);let S=v.getImageData(0,0,m,b).data,I=Number(u.pixelCoords[0])*this.drawMult,x=Number(u.pixelCoords[1])*this.drawMult;for(let E=0;E<b;E++)for(let C=0;C<m;C++){if(C%this.drawMult!==1||E%this.drawMult!==1)continue;let M=C+I,T=E+x;if(M<0||T<0||M>=i||T>=i)continue;let A=(E*m+C)*4,O=S[A],$=S[A+1],B=S[A+2];if(S[A+3]<64){try{let ce=this.templatesArray?.[0],he=(T*i+M)*4,Ve=f[he],We=f[he+1],Ue=f[he+2],Pt=f[he+3],kt=ce.allowedColorsSet.has(`${Ve},${We},${Ue}`)?`${Ve},${We},${Ue}`:"other",Bt=ce?.allowedColorsSet?ce.allowedColorsSet.has(kt):!1;Pt>=64&&Bt&&c++}catch{}continue}h++;let K=(T*i+M)*4,we=f[K],Nt=f[K+1],$t=f[K+2];f[K+3]<64||(we===O&&Nt===$&&$t===B?l++:c++)}}catch(m){console.warn("Failed to compute per-tile painted/wrong stats:",m)}try{let m=this.templatesArray?.[0],b=m?.colorPalette||{};if(!Object.values(b).some(v=>v?.enabled===!1))g.drawImage(u.bitmap,Number(u.pixelCoords[0])*this.drawMult,Number(u.pixelCoords[1])*this.drawMult);else{console.log("Applying color filter...");let v=u.bitmap.width,w=u.bitmap.height,S=new OffscreenCanvas(v,w),I=S.getContext("2d",{willReadFrequently:!0});I.imageSmoothingEnabled=!1,I.clearRect(0,0,v,w),I.drawImage(u.bitmap,0,0);let x=I.getImageData(0,0,v,w),E=x.data;for(let C=0;C<w;C++)for(let M=0;M<v;M++){if(M%this.drawMult!==1||C%this.drawMult!==1)continue;let T=(C*v+M)*4,A=E[T],O=E[T+1],$=E[T+2];if(E[T+3]<1)continue;let le=m.allowedColorsSet.has(`${A},${O},${$}`)?`${A},${O},${$}`:"other",K=m?.allowedColorsSet?m.allowedColorsSet.has(le):!0,we=b?.[le]?.enabled!==!1;(!K||!we)&&(E[T+3]=0)}I.putImageData(x,0,0),g.drawImage(S,Number(u.pixelCoords[0])*this.drawMult,Number(u.pixelCoords[1])*this.drawMult)}}catch(m){console.warn("Failed to apply color filter:",m),g.drawImage(u.bitmap,Number(u.pixelCoords[0])*this.drawMult,Number(u.pixelCoords[1])*this.drawMult)}}if(a>0){let u=t;this.tileProgress.set(u,{painted:l,required:h,wrong:c});let m=0,b=0,y=0;for(let E of this.tileProgress.values())m+=E.painted||0,b+=E.required||0,y+=E.wrong||0;let v=this.templatesArray.reduce((E,C)=>E+(C.requiredPixelCount||C.pixelCount||0),0),w=v>0?v:b,S=new Intl.NumberFormat().format(m),I=new Intl.NumberFormat().format(w),x=new Intl.NumberFormat().format(w-m);this.overlay.handleDisplayStatus(`\u041E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 ${a} \u0448\u0430\u0431\u043B\u043E\u043D\u0430${a==1?"":"\u043E\u0432"}.
\u041D\u0430\u0440\u0438\u0441\u043E\u0432\u0430\u043D\u043E ${S} / ${I} \u2022 \u041D\u0435\u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u043E ${x}`)}else this.overlay.handleDisplayStatus(`\u041E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 ${a} \u0448\u0430\u0431\u043B\u043E\u043D\u0430${a==1?"":"\u043E\u0432"}.`);return await d.convertToBlob({type:"image/png"})}importJSON(e){console.log("Importing JSON..."),console.log(e),e?.whoami=="BlueMarble"&&L(this,W,it).call(this,e)}setTemplatesShouldBeDrawn(e){this.templatesShouldBeDrawn=e}};W=new WeakSet,Rt=function(){},tt=async function(){GM.setValue("bmTemplates",JSON.stringify(this.templatesJSON))},it=async function(e){console.log("Parsing BlueMarble...");let t=e.templates;if(console.log(`BlueMarble length: ${Object.keys(t).length}`),Object.keys(t).length>0){for(let i in t){let s=i,n=t[i];if(console.log(s),t.hasOwnProperty(i)){let r=s.split(" "),a=Number(r?.[0]),l=r?.[1]||"0",c=n.name||`Template ${a||""}`,h=n.tiles,p={},d=0,g=new Map;for(let m in h)if(console.log(m),h.hasOwnProperty(m)){let b=h[m],y=et(b),v=new Blob([y],{type:"image/png"}),w=await createImageBitmap(v);p[m]=w;try{let S=w.width,I=w.height,E=new OffscreenCanvas(S,I).getContext("2d",{willReadFrequently:!0});E.imageSmoothingEnabled=!1,E.clearRect(0,0,S,I),E.drawImage(w,0,0);let C=E.getImageData(0,0,S,I).data;for(let M=0;M<I;M++)for(let T=0;T<S;T++){if(T%this.drawMult!==1||M%this.drawMult!==1)continue;let A=(M*S+T)*4,O=C[A],$=C[A+1],B=C[A+2];if(C[A+3]<64||O===222&&$===250&&B===206)continue;d++;let K=activeTemplate.allowedColorsSet.has(`${O},${$},${B}`)?`${O},${$},${B}`:"other";g.set(K,(g.get(K)||0)+1)}}catch(S){console.warn("Failed to count required pixels for imported tile",S)}}let f=new z({displayName:c,sortID:a||this.templatesArray?.length||0,authorID:l||""});f.chunked=p,f.requiredPixelCount=d;let u={};for(let[m,b]of g.entries())u[m]={count:b,enabled:!0};f.colorPalette=u;try{Object.keys(p).forEach(m=>{f.tilePrefixes?.add(m.split(",").slice(0,2).join(","))})}catch{}try{let m=t?.[s]?.palette;if(m)for(let[b,y]of Object.entries(m))f.colorPalette[b]?f.colorPalette[b].enabled=!!y?.enabled:f.colorPalette[b]={count:y?.count||0,enabled:!!y?.enabled}}catch{}f.storageKey=s,this.templatesArray.push(f),console.log(this.templatesArray),console.log("^^^ This ^^^")}}try{let i=document.querySelector("#bm-contain-colorfilter");i&&(i.style.display=""),window.postMessage({source:"blue-marble",bmEvent:"bm-rebuild-color-list"},"*")}catch{}}},Ht=function(){};var X,st,nt,se=class{constructor(e){Y(this,X);this.templateManager=e,this.disableAll=!1,this.coordsTilePixel=[],this.templateCoordsTilePixel=[]}spontaneousResponseListener(e){window.addEventListener("message",async t=>{let i=t.data,s=i.jsonData;if(!(i&&i.source==="blue-marble")||!i.endpoint)return;let n=i.endpoint?.split("?")[0].split("/").filter(r=>r&&isNaN(Number(r))).filter(r=>r&&!r.includes(".")).pop();switch(console.log('%cBlue Marble%c: Recieved message about "%s"',"color: cornflowerblue;","",n),n){case"me":if(s.status&&s.status?.toString()[0]!="2"){e.handleDisplayError(`You are not logged in!
Could not fetch userdata.`);return}let r=Math.ceil(Math.pow(Math.floor(s.level)*Math.pow(30,.65),1/.65)-s.pixelsPainted);console.log(s.id),(s.id||s.id===0)&&console.log(de(s.id,"!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~")),this.templateManager.userID=s.id,e.updateInnerHTML("bm-user-name",`\u042E\u0437\u0435\u0440\u043D\u0435\u0439\u043C: <b>${Je(s.name)}</b>`),e.updateInnerHTML("bm-user-droplets",`\u041A\u0430\u043F\u0435\u043B\u044C: <b>${new Intl.NumberFormat().format(s.droplets)}</b>`),e.updateInnerHTML("bm-user-nextlevel",`\u0421\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0439 \u0443\u0440\u043E\u0432\u0435\u043D\u044C \u0447\u0435\u0440\u0435\u0437: <b>${new Intl.NumberFormat().format(r)}</b> \u043F\u0438\u043A\u0441\u0435\u043B${r==1?"\u044C":"\u0435\u0439"}`),GM_setValue("bmUserPixels",JSON.stringify({count:s.charges.count,max:s.charges.max,cooldownMs:s.charges.cooldownMs})),e.updateInnerHTML("bm-user-reload","\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0437\u0430\u0440\u044F\u0434\u043E\u0432 \u0447\u0435\u0440\u0435\u0437: <b>"+Math.ceil(s.charges.cooldownMs*(s.charges.max-s.charges.count)/1e3/60)+"</b> \u043C\u0438\u043D"),this.sendOnlineStatus(e,s);break;case"pixel":let a=i.endpoint.split("?")[0].split("/").filter(m=>m&&!isNaN(Number(m))),l=new URLSearchParams(i.endpoint.split("?")[1]),c=[l.get("x"),l.get("y")];if(this.coordsTilePixel.length&&(!a.length||!c.length)){e.handleDisplayError(`Coordinates are malformed!
Did you try clicking the canvas first?`);return}this.coordsTilePixel=[...a,...c];let h=ze(a,c),p=document.querySelectorAll("span");for(let m of p)if(m.textContent.trim().includes(`${h[0]}, ${h[1]}`)){let b=document.querySelector("#bm-display-coords"),y=`(Tl X: ${a[0]}, Tl Y: ${a[1]}, Px X: ${c[0]}, Px Y: ${c[1]})`;b?b.textContent=y:(b=document.createElement("span"),b.id="bm-display-coords",b.textContent=y,b.style="margin-left: calc(var(--spacing)*3); font-size: small;",m.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",b))}break;case"tiles":let d=i.endpoint.split("/");d=[parseInt(d[d.length-2]),parseInt(d[d.length-1].replace(".png",""))];let g=i.blobID,f=i.blobData,u=await this.templateManager.drawTemplateOnTile(f,d);window.postMessage({source:"blue-marble",blobID:g,blobData:u,blink:i.blink});break;case"robots":this.disableAll=s.userscript?.toString().toLowerCase()=="false";break}})}async sendOnlineStatus(e,t){let s=JSON.parse(GM_getValue("bmUserSettings","{}")).uuid,n=JSON.stringify({count:Math.floor(t.charges.count),max:Math.floor(t.charges.max),uuid:s,template_id:this.templateManager.templatesArray[0].template_id});console.log("data",n),GM_xmlhttpRequest({method:"POST",url:`${Ce}/wplace-api/online`,headers:{"Content-Type":"application/json"},data:n,onload:r=>{if(r.status!==200){te("Failed to send online status:",r.statusText);return}let a=JSON.parse(r.responseText);e.updateInnerHTML("bm-user-online",`\u0412 \u043A\u043B\u0430\u043D\u0435 <b>${a.online_count}</b> \u0447\u0435\u043B\u043E\u0432\u0435\u043A \u043E\u043D\u043B\u0430\u0439\u043D.<br> \u0423 \u043A\u043B\u0430\u043D\u0430 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E <b>${a.count}</b> \u043F\u0438\u043A\u0441\u0435\u043B\u0435\u0439 \u0438\u0437 <b>${a.max}</b> \u043C\u0430\u043A\u0441.`)},onerror:r=>{te("Error sending online status:",r)}})}async sendHeartbeat(e){console.log("Sending heartbeat to telemetry server...");let t=GM_getValue("bmUserSettings","{}");if(t=JSON.parse(t),!t||!t.telemetry||!t.uuid){console.log("Telemetry is disabled, not sending heartbeat.");return}let i=navigator.userAgent,s=await L(this,X,st).call(this,i),n=L(this,X,nt).call(this,i);GM_xmlhttpRequest({method:"POST",url:`${Ce}/heartbeat`,headers:{"Content-Type":"application/json"},data:JSON.stringify({uuid:t.uuid,version:e,browser:s,os:n}),onload:r=>{r.status!==200&&te("Failed to send heartbeat:",r.statusText)},onerror:r=>{te("Error sending heartbeat:",r)}})}};X=new WeakSet,st=async function(e=navigator.userAgent){return e=e||"",e.includes("OPR/")||e.includes("Opera")?"Opera":e.includes("Edg/")?"Edge":e.includes("Vivaldi")?"Vivaldi":e.includes("YaBrowser")?"Yandex":e.includes("Kiwi")?"Kiwi":e.includes("Brave")?"Brave":e.includes("Firefox/")?"Firefox":e.includes("Chrome/")?"Chrome":e.includes("Safari/")?"Safari":navigator.brave&&typeof navigator.brave.isBrave=="function"&&await navigator.brave.isBrave()?"Brave":"Unknown"},nt=function(e=navigator.userAgent){return e=e||"",/Windows NT 11/i.test(e)?"Windows 11":/Windows NT 10/i.test(e)?"Windows 10":/Windows NT 6\.3/i.test(e)?"Windows 8.1":/Windows NT 6\.2/i.test(e)?"Windows 8":/Windows NT 6\.1/i.test(e)?"Windows 7":/Windows NT 6\.0/i.test(e)?"Windows Vista":/Windows NT 5\.1|Windows XP/i.test(e)?"Windows XP":/Mac OS X 10[_\.]15/i.test(e)?"macOS Catalina":/Mac OS X 10[_\.]14/i.test(e)?"macOS Mojave":/Mac OS X 10[_\.]13/i.test(e)?"macOS High Sierra":/Mac OS X 10[_\.]12/i.test(e)?"macOS Sierra":/Mac OS X 10[_\.]11/i.test(e)?"OS X El Capitan":/Mac OS X 10[_\.]10/i.test(e)?"OS X Yosemite":/Mac OS X 10[_\.]/i.test(e)?"macOS":/Android/i.test(e)?"Android":/iPhone|iPad|iPod/i.test(e)?"iOS":/Linux/i.test(e)?"Linux":"Unknown"};var jt=function(o){return function(e){return!!e&&typeof e=="object"}(o)&&!function(e){var t=Object.prototype.toString.call(e);return t==="[object RegExp]"||t==="[object Date]"||function(i){return i.$$typeof===Gt}(e)}(o)},Gt=typeof Symbol=="function"&&Symbol.for?Symbol.for("react.element"):60103;function ne(o,e){return e.clone!==!1&&e.isMergeableObject(o)?Z((t=o,Array.isArray(t)?[]:{}),o,e):o;var t}function Kt(o,e,t){return o.concat(e).map(function(i){return ne(i,t)})}function ot(o){return Object.keys(o).concat(function(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter(function(t){return e.propertyIsEnumerable(t)}):[]}(o))}function rt(o,e){try{return e in o}catch{return!1}}function qt(o,e,t){var i={};return t.isMergeableObject(o)&&ot(o).forEach(function(s){i[s]=ne(o[s],t)}),ot(e).forEach(function(s){(function(n,r){return rt(n,r)&&!(Object.hasOwnProperty.call(n,r)&&Object.propertyIsEnumerable.call(n,r))})(o,s)||(rt(o,s)&&t.isMergeableObject(e[s])?i[s]=function(n,r){if(!r.customMerge)return Z;var a=r.customMerge(n);return typeof a=="function"?a:Z}(s,t)(o[s],e[s],t):i[s]=ne(e[s],t))}),i}function Z(o,e,t){(t=t||{}).arrayMerge=t.arrayMerge||Kt,t.isMergeableObject=t.isMergeableObject||jt,t.cloneUnlessOtherwiseSpecified=ne;var i=Array.isArray(e);return i===Array.isArray(o)?i?t.arrayMerge(o,e,t):qt(o,e,t):ne(e,t)}Z.all=function(o,e){if(!Array.isArray(o))throw new Error("first argument should be an array");return o.reduce(function(t,i){return Z(t,i,e)},{})};var at=Z;function V(o){return Array.isArray?Array.isArray(o):xt(o)==="[object Array]"}function q(o){return typeof o=="string"}function St(o){return typeof o=="number"}function Vt(o){return o===!0||o===!1||function(e){return wt(e)&&e!==null}(o)&&xt(o)=="[object Boolean]"}function wt(o){return typeof o=="object"}function k(o){return o!=null}function Ie(o){return!o.trim().length}function xt(o){return o==null?o===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(o)}var lt=Object.prototype.hasOwnProperty,Ae=class{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach(i=>{let s=Ct(i);t+=s.weight,this._keys.push(s),this._keyMap[s.id]=s,t+=s.weight}),this._keys.forEach(i=>{i.weight/=t})}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}};function Ct(o){let e=null,t=null,i=null,s=1;if(q(o)||V(o))i=o,e=ct(o),t=De(o);else{if(!lt.call(o,"name"))throw new Error((r=>`Missing ${r} property in key`)("name"));let n=o.name;if(i=n,lt.call(o,"weight")&&(s=o.weight,s<=0))throw new Error((r=>`Property 'weight' in key '${r}' must be a positive integer`)(n));e=ct(n),t=De(n)}return{path:e,id:t,weight:s,src:i}}function ct(o){return V(o)?o:o.split(".")}function De(o){return V(o)?o.join("."):o}var _={isCaseSensitive:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(o,e)=>o.score===e.score?o.idx<e.idx?-1:1:o.score<e.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,useExtendedSearch:!1,getFn:function(o,e){let t=[],i=!1,s=(n,r,a)=>{if(k(n))if(r[a]){let l=n[r[a]];if(!k(l))return;if(a===r.length-1&&(q(l)||St(l)||Vt(l)))t.push(function(c){return c==null?"":function(h){if(typeof h=="string")return h;let p=h+"";return p=="0"&&1/h==-1/0?"-0":p}(c)}(l));else if(V(l)){i=!0;for(let c=0,h=l.length;c<h;c+=1)s(l[c],r,a+1)}else r.length&&s(l,r,a+1)}else t.push(n)};return s(o,q(e)?e.split("."):e,0),i?t:t[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1},Wt=/[^ ]+/g,oe=class{constructor({getFn:e=_.getFn,fieldNormWeight:t=_.fieldNormWeight}={}){this.norm=function(i=1,s=3){let n=new Map,r=Math.pow(10,s);return{get(a){let l=a.match(Wt).length;if(n.has(l))return n.get(l);let c=1/Math.pow(l,.5*i),h=parseFloat(Math.round(c*r)/r);return n.set(l,h),h},clear(){n.clear()}}}(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach((t,i)=>{this._keysMap[t.id]=i})}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,q(this.docs[0])?this.docs.forEach((e,t)=>{this._addString(e,t)}):this.docs.forEach((e,t)=>{this._addObject(e,t)}),this.norm.clear())}add(e){let t=this.size();q(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,i=this.size();t<i;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!k(e)||Ie(e))return;let i={v:e,i:t,n:this.norm.get(e)};this.records.push(i)}_addObject(e,t){let i={i:t,$:{}};this.keys.forEach((s,n)=>{let r=this.getFn(e,s.path);if(k(r)){if(V(r)){let a=[],l=[{nestedArrIndex:-1,value:r}];for(;l.length;){let{nestedArrIndex:c,value:h}=l.pop();if(k(h))if(q(h)&&!Ie(h)){let p={v:h,i:c,n:this.norm.get(h)};a.push(p)}else V(h)&&h.forEach((p,d)=>{l.push({nestedArrIndex:d,value:p})})}i.$[n]=a}else if(!Ie(r)){let a={v:r,n:this.norm.get(r)};i.$[n]=a}}}),this.records.push(i)}toJSON(){return{keys:this.keys,records:this.records}}};function It(o,e,{getFn:t=_.getFn,fieldNormWeight:i=_.fieldNormWeight}={}){let s=new oe({getFn:t,fieldNormWeight:i});return s.setKeys(o.map(Ct)),s.setSources(e),s.create(),s}function ue(o,{errors:e=0,currentLocation:t=0,expectedLocation:i=0,distance:s=_.distance,ignoreLocation:n=_.ignoreLocation}={}){let r=e/o.length;if(n)return r;let a=Math.abs(i-t);return s?r+a/s:a?1:r}function Ut(o,e,t,{location:i=_.location,distance:s=_.distance,threshold:n=_.threshold,findAllMatches:r=_.findAllMatches,minMatchCharLength:a=_.minMatchCharLength,includeMatches:l=_.includeMatches,ignoreLocation:c=_.ignoreLocation}={}){if(e.length>32)throw new Error("Pattern length exceeds max of 32.");let h=e.length,p=o.length,d=Math.max(0,Math.min(i,p)),g=n,f=d,u=a>1||l,m=u?Array(p):[],b;for(;(b=o.indexOf(e,f))>-1;){let x=ue(e,{currentLocation:b,expectedLocation:d,distance:s,ignoreLocation:c});if(g=Math.min(x,g),f=b+h,u){let E=0;for(;E<h;)m[b+E]=1,E+=1}}f=-1;let y=[],v=1,w=h+p,S=1<<h-1;for(let x=0;x<h;x+=1){let E=0,C=w;for(;E<C;)ue(e,{errors:x,currentLocation:d+C,expectedLocation:d,distance:s,ignoreLocation:c})<=g?E=C:w=C,C=Math.floor((w-E)/2+E);w=C;let M=Math.max(1,d-C+1),T=r?p:Math.min(d+C,p)+h,A=Array(T+2);A[T+1]=(1<<x)-1;for(let O=T;O>=M;O-=1){let $=O-1,B=t[o.charAt($)];if(u&&(m[$]=+!!B),A[O]=(A[O+1]<<1|1)&B,x&&(A[O]|=(y[O+1]|y[O])<<1|1|y[O+1]),A[O]&S&&(v=ue(e,{errors:x,currentLocation:$,expectedLocation:d,distance:s,ignoreLocation:c}),v<=g)){if(g=v,f=$,f<=d)break;M=Math.max(1,2*d-f)}}if(ue(e,{errors:x+1,currentLocation:d,expectedLocation:d,distance:s,ignoreLocation:c})>g)break;y=A}let I={isMatch:f>=0,score:Math.max(.001,v)};if(u){let x=function(E=[],C=_.minMatchCharLength){let M=[],T=-1,A=-1,O=0;for(let $=E.length;O<$;O+=1){let B=E[O];B&&T===-1?T=O:B||T===-1||(A=O-1,A-T+1>=C&&M.push([T,A]),T=-1)}return E[O-1]&&O-T>=C&&M.push([T,O-1]),M}(m,a);x.length?l&&(I.indices=x):I.isMatch=!1}return I}function Yt(o){let e={};for(let t=0,i=o.length;t<i;t+=1){let s=o.charAt(t);e[s]=(e[s]||0)|1<<i-t-1}return e}var ge=class{constructor(e,{location:t=_.location,threshold:i=_.threshold,distance:s=_.distance,includeMatches:n=_.includeMatches,findAllMatches:r=_.findAllMatches,minMatchCharLength:a=_.minMatchCharLength,isCaseSensitive:l=_.isCaseSensitive,ignoreLocation:c=_.ignoreLocation}={}){if(this.options={location:t,threshold:i,distance:s,includeMatches:n,findAllMatches:r,minMatchCharLength:a,isCaseSensitive:l,ignoreLocation:c},this.pattern=l?e:e.toLowerCase(),this.chunks=[],!this.pattern.length)return;let h=(d,g)=>{this.chunks.push({pattern:d,alphabet:Yt(d),startIndex:g})},p=this.pattern.length;if(p>32){let d=0,g=p%32,f=p-g;for(;d<f;)h(this.pattern.substr(d,32),d),d+=32;if(g){let u=p-32;h(this.pattern.substr(u),u)}}else h(this.pattern,0)}searchIn(e){let{isCaseSensitive:t,includeMatches:i}=this.options;if(t||(e=e.toLowerCase()),this.pattern===e){let f={isMatch:!0,score:0};return i&&(f.indices=[[0,e.length-1]]),f}let{location:s,distance:n,threshold:r,findAllMatches:a,minMatchCharLength:l,ignoreLocation:c}=this.options,h=[],p=0,d=!1;this.chunks.forEach(({pattern:f,alphabet:u,startIndex:m})=>{let{isMatch:b,score:y,indices:v}=Ut(e,f,u,{location:s+m,distance:n,threshold:r,findAllMatches:a,minMatchCharLength:l,includeMatches:i,ignoreLocation:c});b&&(d=!0),p+=y,b&&v&&(h=[...h,...v])});let g={isMatch:d,score:d?p/this.chunks.length:1};return d&&i&&(g.indices=h),g}},G=class{constructor(e){this.pattern=e}static isMultiMatch(e){return ht(e,this.multiRegex)}static isSingleMatch(e){return ht(e,this.singleRegex)}search(){}};function ht(o,e){let t=o.match(e);return t?t[1]:null}var fe=class extends G{constructor(e,{location:t=_.location,threshold:i=_.threshold,distance:s=_.distance,includeMatches:n=_.includeMatches,findAllMatches:r=_.findAllMatches,minMatchCharLength:a=_.minMatchCharLength,isCaseSensitive:l=_.isCaseSensitive,ignoreLocation:c=_.ignoreLocation}={}){super(e),this._bitapSearch=new ge(e,{location:t,threshold:i,distance:s,includeMatches:n,findAllMatches:r,minMatchCharLength:a,isCaseSensitive:l,ignoreLocation:c})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}},be=class extends G{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t,i=0,s=[],n=this.pattern.length;for(;(t=e.indexOf(this.pattern,i))>-1;)i=t+n,s.push([t,i-1]);let r=!!s.length;return{isMatch:r,score:r?0:1,indices:s}}},Ne=[class extends G{constructor(o){super(o)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(o){let e=o===this.pattern;return{isMatch:e,score:e?0:1,indices:[0,this.pattern.length-1]}}},be,class extends G{constructor(o){super(o)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(o){let e=o.startsWith(this.pattern);return{isMatch:e,score:e?0:1,indices:[0,this.pattern.length-1]}}},class extends G{constructor(o){super(o)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(o){let e=!o.startsWith(this.pattern);return{isMatch:e,score:e?0:1,indices:[0,o.length-1]}}},class extends G{constructor(o){super(o)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(o){let e=!o.endsWith(this.pattern);return{isMatch:e,score:e?0:1,indices:[0,o.length-1]}}},class extends G{constructor(o){super(o)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(o){let e=o.endsWith(this.pattern);return{isMatch:e,score:e?0:1,indices:[o.length-this.pattern.length,o.length-1]}}},class extends G{constructor(o){super(o)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(o){let e=o.indexOf(this.pattern)===-1;return{isMatch:e,score:e?0:1,indices:[0,o.length-1]}}},fe],dt=Ne.length,Jt=/ +(?=([^\"]*\"[^\"]*\")*[^\"]*$)/,zt=new Set([fe.type,be.type]),$e=class{constructor(e,{isCaseSensitive:t=_.isCaseSensitive,includeMatches:i=_.includeMatches,minMatchCharLength:s=_.minMatchCharLength,ignoreLocation:n=_.ignoreLocation,findAllMatches:r=_.findAllMatches,location:a=_.location,threshold:l=_.threshold,distance:c=_.distance}={}){this.query=null,this.options={isCaseSensitive:t,includeMatches:i,minMatchCharLength:s,findAllMatches:r,ignoreLocation:n,location:a,threshold:l,distance:c},this.pattern=t?e:e.toLowerCase(),this.query=function(h,p={}){return h.split("|").map(d=>{let g=d.trim().split(Jt).filter(u=>u&&!!u.trim()),f=[];for(let u=0,m=g.length;u<m;u+=1){let b=g[u],y=!1,v=-1;for(;!y&&++v<dt;){let w=Ne[v],S=w.isMultiMatch(b);S&&(f.push(new w(S,p)),y=!0)}if(!y)for(v=-1;++v<dt;){let w=Ne[v],S=w.isSingleMatch(b);if(S){f.push(new w(S,p));break}}}return f})}(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){let t=this.query;if(!t)return{isMatch:!1,score:1};let{includeMatches:i,isCaseSensitive:s}=this.options;e=s?e:e.toLowerCase();let n=0,r=[],a=0;for(let l=0,c=t.length;l<c;l+=1){let h=t[l];r.length=0,n=0;for(let p=0,d=h.length;p<d;p+=1){let g=h[p],{isMatch:f,indices:u,score:m}=g.search(e);if(!f){a=0,n=0,r.length=0;break}if(n+=1,a+=m,i){let b=g.constructor.type;zt.has(b)?r=[...r,...u]:r.push(u)}}if(n){let p={isMatch:!0,score:a/n};return i&&(p.indices=r),p}}return{isMatch:!1,score:1}}},Pe=[];function ke(o,e){for(let t=0,i=Pe.length;t<i;t+=1){let s=Pe[t];if(s.condition(o,e))return new s(o,e)}return new ge(o,e)}var Ge="$and",Xt="$or",ut="$path",Zt="$val",Te=o=>!(!o[Ge]&&!o[Xt]),mt=o=>({[Ge]:Object.keys(o).map(e=>({[e]:o[e]}))});function Tt(o,e,{auto:t=!0}={}){let i=s=>{let n=Object.keys(s),r=(l=>!!l[ut])(s);if(!r&&n.length>1&&!Te(s))return i(mt(s));if((l=>!V(l)&&wt(l)&&!Te(l))(s)){let l=r?s[ut]:n[0],c=r?s[Zt]:s[l];if(!q(c))throw new Error((p=>`Invalid value for key ${p}`)(l));let h={keyId:De(l),pattern:c};return t&&(h.searcher=ke(c,e)),h}let a={children:[],operator:n[0]};return n.forEach(l=>{let c=s[l];V(c)&&c.forEach(h=>{a.children.push(i(h))})}),a};return Te(o)||(o=mt(o)),i(o)}function Qt(o,e){let t=o.matches;e.matches=[],k(t)&&t.forEach(i=>{if(!k(i.indices)||!i.indices.length)return;let{indices:s,value:n}=i,r={indices:s,value:n};i.key&&(r.key=i.key.src),i.idx>-1&&(r.refIndex=i.idx),e.matches.push(r)})}function ei(o,e){e.score=o.score}var U=class{constructor(e,t={},i){this.options={..._,...t},this.options.useExtendedSearch,this._keyStore=new Ae(this.options.keys),this.setCollection(e,i)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof oe))throw new Error("Incorrect 'index' type");this._myIndex=t||It(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){k(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){let t=[];for(let i=0,s=this._docs.length;i<s;i+=1){let n=this._docs[i];e(n,i)&&(this.removeAt(i),i-=1,s-=1,t.push(n))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){let{includeMatches:i,includeScore:s,shouldSort:n,sortFn:r,ignoreFieldNorm:a}=this.options,l=q(e)?q(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(c,{ignoreFieldNorm:h=_.ignoreFieldNorm}){c.forEach(p=>{let d=1;p.matches.forEach(({key:g,norm:f,score:u})=>{let m=g?g.weight:null;d*=Math.pow(u===0&&m?Number.EPSILON:u,(m||1)*(h?1:f))}),p.score=d})}(l,{ignoreFieldNorm:a}),n&&l.sort(r),St(t)&&t>-1&&(l=l.slice(0,t)),function(c,h,{includeMatches:p=_.includeMatches,includeScore:d=_.includeScore}={}){let g=[];return p&&g.push(Qt),d&&g.push(ei),c.map(f=>{let{idx:u}=f,m={item:h[u],refIndex:u};return g.length&&g.forEach(b=>{b(f,m)}),m})}(l,this._docs,{includeMatches:i,includeScore:s})}_searchStringList(e){let t=ke(e,this.options),{records:i}=this._myIndex,s=[];return i.forEach(({v:n,i:r,n:a})=>{if(!k(n))return;let{isMatch:l,score:c,indices:h}=t.searchIn(n);l&&s.push({item:n,idx:r,matches:[{score:c,value:n,norm:a,indices:h}]})}),s}_searchLogical(e){let t=Tt(e,this.options),i=(a,l,c)=>{if(!a.children){let{keyId:p,searcher:d}=a,g=this._findMatches({key:this._keyStore.get(p),value:this._myIndex.getValueForItemAtKeyId(l,p),searcher:d});return g&&g.length?[{idx:c,item:l,matches:g}]:[]}let h=[];for(let p=0,d=a.children.length;p<d;p+=1){let g=a.children[p],f=i(g,l,c);if(f.length)h.push(...f);else if(a.operator===Ge)return[]}return h},s=this._myIndex.records,n={},r=[];return s.forEach(({$:a,i:l})=>{if(k(a)){let c=i(t,a,l);c.length&&(n[l]||(n[l]={idx:l,item:a,matches:[]},r.push(n[l])),c.forEach(({matches:h})=>{n[l].matches.push(...h)}))}}),r}_searchObjectList(e){let t=ke(e,this.options),{keys:i,records:s}=this._myIndex,n=[];return s.forEach(({$:r,i:a})=>{if(!k(r))return;let l=[];i.forEach((c,h)=>{l.push(...this._findMatches({key:c,value:r[h],searcher:t}))}),l.length&&n.push({idx:a,item:r,matches:l})}),n}_findMatches({key:e,value:t,searcher:i}){if(!k(t))return[];let s=[];if(V(t))t.forEach(({v:n,i:r,n:a})=>{if(!k(n))return;let{isMatch:l,score:c,indices:h}=i.searchIn(n);l&&s.push({score:c,key:e,value:n,idx:r,norm:a,indices:h})});else{let{v:n,n:r}=t,{isMatch:a,score:l,indices:c}=i.searchIn(n);a&&s.push({score:l,key:e,value:n,norm:r,indices:c})}return s}};U.version="6.5.3",U.createIndex=It,U.parseIndex=function(o,{getFn:e=_.getFn,fieldNormWeight:t=_.fieldNormWeight}={}){let{keys:i,records:s}=o,n=new oe({getFn:e,fieldNormWeight:t});return n.setKeys(i),n.setIndexRecords(s),n},U.config=_,U.parseQuery=Tt,function(...o){Pe.push(...o)}($e);var j={showDropdown:"showDropdown",hideDropdown:"hideDropdown",change:"change",choice:"choice",search:"search",addItem:"addItem",removeItem:"removeItem",highlightItem:"highlightItem",highlightChoice:"highlightChoice",unhighlightItem:"unhighlightItem"},R={ADD_CHOICE:"ADD_CHOICE",FILTER_CHOICES:"FILTER_CHOICES",ACTIVATE_CHOICES:"ACTIVATE_CHOICES",CLEAR_CHOICES:"CLEAR_CHOICES",ADD_GROUP:"ADD_GROUP",ADD_ITEM:"ADD_ITEM",REMOVE_ITEM:"REMOVE_ITEM",HIGHLIGHT_ITEM:"HIGHLIGHT_ITEM",CLEAR_ALL:"CLEAR_ALL",RESET_TO:"RESET_TO",SET_IS_LOADING:"SET_IS_LOADING"},me={BACK_KEY:46,DELETE_KEY:8,ENTER_KEY:13,A_KEY:65,ESC_KEY:27,UP_KEY:38,DOWN_KEY:40,PAGE_UP_KEY:33,PAGE_DOWN_KEY:34};var Oe=(o=!0)=>({type:R.ACTIVATE_CHOICES,active:o}),pt=({value:o,id:e,active:t,disabled:i})=>({type:R.ADD_GROUP,value:o,id:e,active:t,disabled:i}),gt=(o,e)=>({type:R.HIGHLIGHT_ITEM,id:o,highlighted:e}),ft=o=>({type:R.SET_IS_LOADING,isLoading:o}),Be=class{constructor({element:e,type:t,classNames:i}){this.element=e,this.classNames=i,this.type=t,this.isActive=!1}get distanceFromTopWindow(){return this.element.getBoundingClientRect().bottom}getChild(e){return this.element.querySelector(e)}show(){return this.element.classList.add(this.classNames.activeState),this.element.setAttribute("aria-expanded","true"),this.isActive=!0,this}hide(){return this.element.classList.remove(this.classNames.activeState),this.element.setAttribute("aria-expanded","false"),this.isActive=!1,this}},bt=o=>Array.from({length:o},()=>{return(e=0,t=36,Math.floor(Math.random()*(t-e)+e)).toString(36);var e,t}).join(""),Ot=o=>Object.prototype.toString.call(o).slice(8,-1),yt=(o,e)=>e!=null&&Ot(e)===o,Lt=o=>typeof o!="string"?o:o.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),ti=(()=>{let o=document.createElement("div");return e=>{let t=e.trim();o.innerHTML=t;let i=o.children[0];for(;o.firstChild;)o.removeChild(o.firstChild);return i}})(),ii=(o,e)=>{let{score:t=0}=o,{score:i=0}=e;return t-i},ye=class{constructor({element:e,type:t,classNames:i,position:s}){this.element=e,this.classNames=i,this.type=t,this.position=s,this.isOpen=!1,this.isFlipped=!1,this.isFocussed=!1,this.isDisabled=!1,this.isLoading=!1,this._onFocus=this._onFocus.bind(this),this._onBlur=this._onBlur.bind(this)}addEventListeners(){this.element.addEventListener("focus",this._onFocus),this.element.addEventListener("blur",this._onBlur)}removeEventListeners(){this.element.removeEventListener("focus",this._onFocus),this.element.removeEventListener("blur",this._onBlur)}shouldFlip(e){if(typeof e!="number")return!1;let t=!1;return this.position==="auto"?t=!window.matchMedia(`(min-height: ${e+1}px)`).matches:this.position==="top"&&(t=!0),t}setActiveDescendant(e){this.element.setAttribute("aria-activedescendant",e)}removeActiveDescendant(){this.element.removeAttribute("aria-activedescendant")}open(e){this.element.classList.add(this.classNames.openState),this.element.setAttribute("aria-expanded","true"),this.isOpen=!0,this.shouldFlip(e)&&(this.element.classList.add(this.classNames.flippedState),this.isFlipped=!0)}close(){this.element.classList.remove(this.classNames.openState),this.element.setAttribute("aria-expanded","false"),this.removeActiveDescendant(),this.isOpen=!1,this.isFlipped&&(this.element.classList.remove(this.classNames.flippedState),this.isFlipped=!1)}focus(){this.isFocussed||this.element.focus()}addFocusState(){this.element.classList.add(this.classNames.focusState)}removeFocusState(){this.element.classList.remove(this.classNames.focusState)}enable(){this.element.classList.remove(this.classNames.disabledState),this.element.removeAttribute("aria-disabled"),this.type==="select-one"&&this.element.setAttribute("tabindex","0"),this.isDisabled=!1}disable(){this.element.classList.add(this.classNames.disabledState),this.element.setAttribute("aria-disabled","true"),this.type==="select-one"&&this.element.setAttribute("tabindex","-1"),this.isDisabled=!0}wrap(e){((t,i=document.createElement("div"))=>{t.parentNode&&(t.nextSibling?t.parentNode.insertBefore(i,t.nextSibling):t.parentNode.appendChild(i)),i.appendChild(t)})(e,this.element)}unwrap(e){this.element.parentNode&&(this.element.parentNode.insertBefore(e,this.element),this.element.parentNode.removeChild(this.element))}addLoadingState(){this.element.classList.add(this.classNames.loadingState),this.element.setAttribute("aria-busy","true"),this.isLoading=!0}removeLoadingState(){this.element.classList.remove(this.classNames.loadingState),this.element.removeAttribute("aria-busy"),this.isLoading=!1}_onFocus(){this.isFocussed=!0}_onBlur(){this.isFocussed=!1}},Fe=class{constructor({element:e,type:t,classNames:i,preventPaste:s}){this.element=e,this.type=t,this.classNames=i,this.preventPaste=s,this.isFocussed=this.element.isEqualNode(document.activeElement),this.isDisabled=e.disabled,this._onPaste=this._onPaste.bind(this),this._onInput=this._onInput.bind(this),this._onFocus=this._onFocus.bind(this),this._onBlur=this._onBlur.bind(this)}set placeholder(e){this.element.placeholder=e}get value(){return Lt(this.element.value)}set value(e){this.element.value=e}get rawValue(){return this.element.value}addEventListeners(){this.element.addEventListener("paste",this._onPaste),this.element.addEventListener("input",this._onInput,{passive:!0}),this.element.addEventListener("focus",this._onFocus,{passive:!0}),this.element.addEventListener("blur",this._onBlur,{passive:!0})}removeEventListeners(){this.element.removeEventListener("input",this._onInput),this.element.removeEventListener("paste",this._onPaste),this.element.removeEventListener("focus",this._onFocus),this.element.removeEventListener("blur",this._onBlur)}enable(){this.element.removeAttribute("disabled"),this.isDisabled=!1}disable(){this.element.setAttribute("disabled",""),this.isDisabled=!0}focus(){this.isFocussed||this.element.focus()}blur(){this.isFocussed&&this.element.blur()}clear(e=!0){return this.element.value&&(this.element.value=""),e&&this.setWidth(),this}setWidth(){let{style:e,value:t,placeholder:i}=this.element;e.minWidth=`${i.length+1}ch`,e.width=`${t.length+1}ch`}setActiveDescendant(e){this.element.setAttribute("aria-activedescendant",e)}removeActiveDescendant(){this.element.removeAttribute("aria-activedescendant")}_onInput(){this.type!=="select-one"&&this.setWidth()}_onPaste(e){this.preventPaste&&e.preventDefault()}_onFocus(){this.isFocussed=!0}_onBlur(){this.isFocussed=!1}},ve=class{constructor({element:e}){this.element=e,this.scrollPos=this.element.scrollTop,this.height=this.element.offsetHeight}clear(){this.element.innerHTML=""}append(e){this.element.appendChild(e)}getChild(e){return this.element.querySelector(e)}hasChildren(){return this.element.hasChildNodes()}scrollToTop(){this.element.scrollTop=0}scrollToChildElement(e,t){if(!e)return;let i=this.element.offsetHeight,s=this.element.scrollTop+i,n=e.offsetHeight,r=e.offsetTop+n,a=t>0?this.element.scrollTop+r-s:e.offsetTop;requestAnimationFrame(()=>{this._animateScroll(a,t)})}_scrollDown(e,t,i){let s=(i-e)/t,n=s>1?s:1;this.element.scrollTop=e+n}_scrollUp(e,t,i){let s=(e-i)/t,n=s>1?s:1;this.element.scrollTop=e-n}_animateScroll(e,t){let i=this.element.scrollTop,s=!1;t>0?(this._scrollDown(i,4,e),i<e&&(s=!0)):(this._scrollUp(i,4,e),i>e&&(s=!0)),s&&requestAnimationFrame(()=>{this._animateScroll(e,t)})}},_e=class{constructor({element:e,classNames:t}){if(this.element=e,this.classNames=t,!(e instanceof HTMLInputElement||e instanceof HTMLSelectElement))throw new TypeError("Invalid element passed");this.isDisabled=!1}get isActive(){return this.element.dataset.choice==="active"}get dir(){return this.element.dir}get value(){return this.element.value}set value(e){this.element.value=e}conceal(){this.element.classList.add(this.classNames.input),this.element.hidden=!0,this.element.tabIndex=-1;let e=this.element.getAttribute("style");e&&this.element.setAttribute("data-choice-orig-style",e),this.element.setAttribute("data-choice","active")}reveal(){this.element.classList.remove(this.classNames.input),this.element.hidden=!1,this.element.removeAttribute("tabindex");let e=this.element.getAttribute("data-choice-orig-style");e?(this.element.removeAttribute("data-choice-orig-style"),this.element.setAttribute("style",e)):this.element.removeAttribute("style"),this.element.removeAttribute("data-choice"),this.element.value=this.element.value}enable(){this.element.removeAttribute("disabled"),this.element.disabled=!1,this.isDisabled=!1}disable(){this.element.setAttribute("disabled",""),this.element.disabled=!0,this.isDisabled=!0}triggerEvent(e,t){((i,s,n=null)=>{let r=new CustomEvent(s,{detail:n,bubbles:!0,cancelable:!0});i.dispatchEvent(r)})(this.element,e,t)}},Re=class extends _e{constructor({element:e,classNames:t,delimiter:i}){super({element:e,classNames:t}),this.delimiter=i}get value(){return this.element.value}set value(e){this.element.setAttribute("value",e),this.element.value=e}},He=class extends _e{constructor({element:e,classNames:t,template:i}){super({element:e,classNames:t}),this.template=i}get placeholderOption(){return this.element.querySelector('option[value=""]')||this.element.querySelector("option[placeholder]")}get optionGroups(){return Array.from(this.element.getElementsByTagName("OPTGROUP"))}get options(){return Array.from(this.element.options)}set options(e){let t=document.createDocumentFragment(),i=s=>{let n=this.template(s);t.appendChild(n)};e.forEach(s=>i(s)),this.appendDocFragment(t)}appendDocFragment(e){this.element.innerHTML="",this.element.appendChild(e)}},si={containerOuter:"choices",containerInner:"choices__inner",input:"choices__input",inputCloned:"choices__input--cloned",list:"choices__list",listItems:"choices__list--multiple",listSingle:"choices__list--single",listDropdown:"choices__list--dropdown",item:"choices__item",itemSelectable:"choices__item--selectable",itemDisabled:"choices__item--disabled",itemChoice:"choices__item--choice",placeholder:"choices__placeholder",group:"choices__group",groupHeading:"choices__heading",button:"choices__button",activeState:"is-active",focusState:"is-focused",openState:"is-open",disabledState:"is-disabled",highlightedState:"is-highlighted",selectedState:"is-selected",flippedState:"is-flipped",loadingState:"is-loading",noResults:"has-no-results",noChoices:"has-no-choices"},vt={items:[],choices:[],silent:!1,renderChoiceLimit:-1,maxItemCount:-1,addItems:!0,addItemFilter:null,removeItems:!0,removeItemButton:!1,editItems:!1,allowHTML:!0,duplicateItemsAllowed:!0,delimiter:",",paste:!0,searchEnabled:!0,searchChoices:!0,searchFloor:1,searchResultLimit:4,searchFields:["label","value"],position:"auto",resetScrollPosition:!0,shouldSort:!0,shouldSortItems:!1,sorter:({value:o,label:e=o},{value:t,label:i=t})=>e.localeCompare(i,[],{sensitivity:"base",ignorePunctuation:!0,numeric:!0}),placeholder:!0,placeholderValue:null,searchPlaceholderValue:null,prependValue:null,appendValue:null,renderSelectedChoices:"auto",loadingText:"Loading...",noResultsText:"No results found",noChoicesText:"No choices to choose from",itemSelectText:"Press to select",uniqueItemText:"Only unique values can be added",customAddItemText:"Only values matching specific conditions can be added",addItemText:o=>`Press Enter to add <b>"${Lt(o)}"</b>`,maxItemText:o=>`Only ${o} values can be added`,valueComparer:(o,e)=>o===e,fuseOptions:{includeScore:!0},callbackOnInit:null,callbackOnCreateTemplates:null,classNames:si};function P(o){return"Minified Redux error #"+o+"; visit https://redux.js.org/Errors?code="+o+" for the full message or use the non-minified dev environment for full errors. "}var _t=typeof Symbol=="function"&&Symbol.observable||"@@observable",Le=function(){return Math.random().toString(36).substring(7).split("").join(".")},Ee={INIT:"@@redux/INIT"+Le(),REPLACE:"@@redux/REPLACE"+Le(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+Le()}};function ni(o){if(typeof o!="object"||o===null)return!1;for(var e=o;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(o)===e}function Mt(o,e,t){var i;if(typeof e=="function"&&typeof t=="function"||typeof t=="function"&&typeof arguments[3]=="function")throw new Error(P(0));if(typeof e=="function"&&t===void 0&&(t=e,e=void 0),t!==void 0){if(typeof t!="function")throw new Error(P(1));return t(Mt)(o,e)}if(typeof o!="function")throw new Error(P(2));var s=o,n=e,r=[],a=r,l=!1;function c(){a===r&&(a=r.slice())}function h(){if(l)throw new Error(P(3));return n}function p(u){if(typeof u!="function")throw new Error(P(4));if(l)throw new Error(P(5));var m=!0;return c(),a.push(u),function(){if(m){if(l)throw new Error(P(6));m=!1,c();var b=a.indexOf(u);a.splice(b,1),r=null}}}function d(u){if(!ni(u))throw new Error(P(7));if(u.type===void 0)throw new Error(P(8));if(l)throw new Error(P(9));try{l=!0,n=s(n,u)}finally{l=!1}for(var m=r=a,b=0;b<m.length;b++)(0,m[b])();return u}function g(u){if(typeof u!="function")throw new Error(P(10));s=u,d({type:Ee.REPLACE})}function f(){var u,m=p;return(u={subscribe:function(b){if(typeof b!="object"||b===null)throw new Error(P(11));function y(){b.next&&b.next(h())}return y(),{unsubscribe:m(y)}}})[_t]=function(){return this},u}return d({type:Ee.INIT}),(i={dispatch:d,subscribe:p,getState:h,replaceReducer:g})[_t]=f,i}var oi=[],ri=[],Et=[],pe={groups:[],items:[],choices:[],loading:!1},ai=function(o){for(var e=Object.keys(o),t={},i=0;i<e.length;i++){var s=e[i];typeof o[s]=="function"&&(t[s]=o[s])}var n,r=Object.keys(t);try{(function(a){Object.keys(a).forEach(function(l){var c=a[l];if(c(void 0,{type:Ee.INIT})===void 0)throw new Error(P(12));if(c(void 0,{type:Ee.PROBE_UNKNOWN_ACTION()})===void 0)throw new Error(P(13))})})(t)}catch(a){n=a}return function(a,l){if(a===void 0&&(a={}),n)throw n;for(var c=!1,h={},p=0;p<r.length;p++){var d=r[p],g=t[d],f=a[d],u=g(f,l);if(u===void 0)throw l&&l.type,new Error(P(14));h[d]=u,c=c||u!==f}return(c=c||r.length!==Object.keys(a).length)?h:a}}({items:function(o=oi,e={}){switch(e.type){case"ADD_ITEM":{let t=e;return[...o,{id:t.id,choiceId:t.choiceId,groupId:t.groupId,value:t.value,label:t.label,active:!0,highlighted:!1,customProperties:t.customProperties,placeholder:t.placeholder||!1,keyCode:null}].map(i=>{let s=i;return s.highlighted=!1,s})}case"REMOVE_ITEM":return o.map(t=>{let i=t;return i.id===e.id&&(i.active=!1),i});case"HIGHLIGHT_ITEM":{let t=e;return o.map(i=>{let s=i;return s.id===t.id&&(s.highlighted=t.highlighted),s})}default:return o}},groups:function(o=ri,e={}){switch(e.type){case"ADD_GROUP":{let t=e;return[...o,{id:t.id,value:t.value,active:t.active,disabled:t.disabled}]}case"CLEAR_CHOICES":return[];default:return o}},choices:function(o=Et,e={}){switch(e.type){case"ADD_CHOICE":{let t=e,i={id:t.id,elementId:t.elementId,groupId:t.groupId,value:t.value,label:t.label||t.value,disabled:t.disabled||!1,selected:!1,active:!0,score:9999,customProperties:t.customProperties,placeholder:t.placeholder||!1};return[...o,i]}case"ADD_ITEM":{let t=e;return t.choiceId>-1?o.map(i=>{let s=i;return s.id===parseInt(`${t.choiceId}`,10)&&(s.selected=!0),s}):o}case"REMOVE_ITEM":{let t=e;return t.choiceId&&t.choiceId>-1?o.map(i=>{let s=i;return s.id===parseInt(`${t.choiceId}`,10)&&(s.selected=!1),s}):o}case"FILTER_CHOICES":{let t=e;return o.map(i=>{let s=i;return s.active=t.results.some(({item:n,score:r})=>n.id===s.id&&(s.score=r,!0)),s})}case"ACTIVATE_CHOICES":{let t=e;return o.map(i=>{let s=i;return s.active=t.active,s})}case"CLEAR_CHOICES":return Et;default:return o}},loading:(o=!1,e={})=>e.type==="SET_IS_LOADING"?e.isLoading:o}),li=(o,e)=>{let t=o;if(e.type==="CLEAR_ALL")t=pe;else if(e.type==="RESET_TO")return i=e.state,JSON.parse(JSON.stringify(i));var i;return ai(t,e)},je=class{constructor(){this._store=Mt(li,window.__REDUX_DEVTOOLS_EXTENSION__&&window.__REDUX_DEVTOOLS_EXTENSION__())}subscribe(e){this._store.subscribe(e)}dispatch(e){this._store.dispatch(e)}get state(){return this._store.getState()}get items(){return this.state.items}get activeItems(){return this.items.filter(e=>e.active===!0)}get highlightedActiveItems(){return this.items.filter(e=>e.active&&e.highlighted)}get choices(){return this.state.choices}get activeChoices(){return this.choices.filter(e=>e.active===!0)}get selectableChoices(){return this.choices.filter(e=>e.disabled!==!0)}get searchableChoices(){return this.selectableChoices.filter(e=>e.placeholder!==!0)}get placeholderChoice(){return[...this.choices].reverse().find(e=>e.placeholder===!0)}get groups(){return this.state.groups}get activeGroups(){let{groups:e,choices:t}=this;return e.filter(i=>{let s=i.active===!0&&i.disabled===!1,n=t.some(r=>r.active===!0&&r.disabled===!1);return s&&n},[])}isLoading(){return this.state.loading}getChoiceById(e){return this.activeChoices.find(t=>t.id===parseInt(e,10))}getGroupById(e){return this.groups.find(t=>t.id===e)}},Me={containerOuter({classNames:{containerOuter:o}},e,t,i,s,n){let r=Object.assign(document.createElement("div"),{className:o});return r.dataset.type=n,e&&(r.dir=e),i&&(r.tabIndex=0),t&&(r.setAttribute("role",s?"combobox":"listbox"),s&&r.setAttribute("aria-autocomplete","list")),r.setAttribute("aria-haspopup","true"),r.setAttribute("aria-expanded","false"),r},containerInner:({classNames:{containerInner:o}})=>Object.assign(document.createElement("div"),{className:o}),itemList:({classNames:{list:o,listSingle:e,listItems:t}},i)=>Object.assign(document.createElement("div"),{className:`${o} ${i?e:t}`}),placeholder:({allowHTML:o,classNames:{placeholder:e}},t)=>Object.assign(document.createElement("div"),{className:e,[o?"innerHTML":"innerText"]:t}),item({allowHTML:o,classNames:{item:e,button:t,highlightedState:i,itemSelectable:s,placeholder:n}},{id:r,value:a,label:l,customProperties:c,active:h,disabled:p,highlighted:d,placeholder:g},f){let u=Object.assign(document.createElement("div"),{className:e,[o?"innerHTML":"innerText"]:l});if(Object.assign(u.dataset,{item:"",id:r,value:a,customProperties:c}),h&&u.setAttribute("aria-selected","true"),p&&u.setAttribute("aria-disabled","true"),g&&u.classList.add(n),u.classList.add(d?i:s),f){p&&u.classList.remove(s),u.dataset.deletable="";let m="Remove item",b=Object.assign(document.createElement("button"),{type:"button",className:t,[o?"innerHTML":"innerText"]:m});b.setAttribute("aria-label",`${m}: '${a}'`),b.dataset.button="",u.appendChild(b)}return u},choiceList({classNames:{list:o}},e){let t=Object.assign(document.createElement("div"),{className:o});return e||t.setAttribute("aria-multiselectable","true"),t.setAttribute("role","listbox"),t},choiceGroup({allowHTML:o,classNames:{group:e,groupHeading:t,itemDisabled:i}},{id:s,value:n,disabled:r}){let a=Object.assign(document.createElement("div"),{className:`${e} ${r?i:""}`});return a.setAttribute("role","group"),Object.assign(a.dataset,{group:"",id:s,value:n}),r&&a.setAttribute("aria-disabled","true"),a.appendChild(Object.assign(document.createElement("div"),{className:t,[o?"innerHTML":"innerText"]:n})),a},choice({allowHTML:o,classNames:{item:e,itemChoice:t,itemSelectable:i,selectedState:s,itemDisabled:n,placeholder:r}},{id:a,value:l,label:c,groupId:h,elementId:p,disabled:d,selected:g,placeholder:f},u){let m=Object.assign(document.createElement("div"),{id:p,[o?"innerHTML":"innerText"]:c,className:`${e} ${t}`});return g&&m.classList.add(s),f&&m.classList.add(r),m.setAttribute("role",h&&h>0?"treeitem":"option"),Object.assign(m.dataset,{choice:"",id:a,value:l,selectText:u}),d?(m.classList.add(n),m.dataset.choiceDisabled="",m.setAttribute("aria-disabled","true")):(m.classList.add(i),m.dataset.choiceSelectable=""),m},input({classNames:{input:o,inputCloned:e}},t){let i=Object.assign(document.createElement("input"),{type:"search",name:"search_terms",className:`${o} ${e}`,autocomplete:"off",autocapitalize:"off",spellcheck:!1});return i.setAttribute("role","textbox"),i.setAttribute("aria-autocomplete","list"),i.setAttribute("aria-label",t),i},dropdown({classNames:{list:o,listDropdown:e}}){let t=document.createElement("div");return t.classList.add(o,e),t.setAttribute("aria-expanded","false"),t},notice({allowHTML:o,classNames:{item:e,itemChoice:t,noResults:i,noChoices:s}},n,r=""){let a=[e,t];return r==="no-choices"?a.push(s):r==="no-results"&&a.push(i),Object.assign(document.createElement("div"),{[o?"innerHTML":"innerText"]:n,className:a.join(" ")})},option({label:o,value:e,customProperties:t,active:i,disabled:s}){let n=new Option(o,e,!1,i);return t&&(n.dataset.customProperties=`${t}`),n.disabled=!!s,n}},ci="-ms-scroll-limit"in document.documentElement.style&&"-ms-ime-align"in document.documentElement.style,hi={},Se=class o{constructor(e="[data-choice]",t={}){t.allowHTML===void 0&&console.warn("Deprecation warning: allowHTML will default to false in a future release. To render HTML in Choices, you will need to set it to true. Setting allowHTML will suppress this message."),this.config=at.all([vt,o.defaults.options,t],{arrayMerge:(n,r)=>[...r]});let i=((n,r)=>{let a=Object.keys(n).sort(),l=Object.keys(r).sort();return a.filter(c=>l.indexOf(c)<0)})(this.config,vt);i.length&&console.warn("Unknown config option(s) passed",i.join(", "));let s=typeof e=="string"?document.querySelector(e):e;if(!(s instanceof HTMLInputElement||s instanceof HTMLSelectElement))throw TypeError("Expected one of the following types text|select-one|select-multiple");if(this._isTextElement=s.type==="text",this._isSelectOneElement=s.type==="select-one",this._isSelectMultipleElement=s.type==="select-multiple",this._isSelectElement=this._isSelectOneElement||this._isSelectMultipleElement,this.config.searchEnabled=this._isSelectMultipleElement||this.config.searchEnabled,["auto","always"].includes(`${this.config.renderSelectedChoices}`)||(this.config.renderSelectedChoices="auto"),t.addItemFilter&&typeof t.addItemFilter!="function"){let n=t.addItemFilter instanceof RegExp?t.addItemFilter:new RegExp(t.addItemFilter);this.config.addItemFilter=n.test.bind(n)}if(this._isTextElement?this.passedElement=new Re({element:s,classNames:this.config.classNames,delimiter:this.config.delimiter}):this.passedElement=new He({element:s,classNames:this.config.classNames,template:n=>this._templates.option(n)}),this.initialised=!1,this._store=new je,this._initialState=pe,this._currentState=pe,this._prevState=pe,this._currentValue="",this._canSearch=!!this.config.searchEnabled,this._isScrollingOnIe=!1,this._highlightPosition=0,this._wasTap=!0,this._placeholderValue=this._generatePlaceholderValue(),this._baseId=((n,r)=>{let a=n.id||n.name&&`${n.name}-${bt(2)}`||bt(4);return a=a.replace(/(:|\.|\[|\]|,)/g,""),a=`${r}-${a}`,a})(this.passedElement.element,"choices-"),this._direction=this.passedElement.dir,!this._direction){let{direction:n}=window.getComputedStyle(this.passedElement.element),{direction:r}=window.getComputedStyle(document.documentElement);n!==r&&(this._direction=n)}if(this._idNames={itemChoice:"item-choice"},this._isSelectElement&&(this._presetGroups=this.passedElement.optionGroups,this._presetOptions=this.passedElement.options),this._presetChoices=this.config.choices,this._presetItems=this.config.items,this.passedElement.value&&this._isTextElement){let n=this.passedElement.value.split(this.config.delimiter);this._presetItems=this._presetItems.concat(n)}if(this.passedElement.options&&this.passedElement.options.forEach(n=>{this._presetChoices.push({value:n.value,label:n.innerHTML,selected:!!n.selected,disabled:n.disabled||n.parentNode.disabled,placeholder:n.value===""||n.hasAttribute("placeholder"),customProperties:n.dataset["custom-properties"]})}),this._render=this._render.bind(this),this._onFocus=this._onFocus.bind(this),this._onBlur=this._onBlur.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onClick=this._onClick.bind(this),this._onTouchMove=this._onTouchMove.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onMouseDown=this._onMouseDown.bind(this),this._onMouseOver=this._onMouseOver.bind(this),this._onFormReset=this._onFormReset.bind(this),this._onSelectKey=this._onSelectKey.bind(this),this._onEnterKey=this._onEnterKey.bind(this),this._onEscapeKey=this._onEscapeKey.bind(this),this._onDirectionKey=this._onDirectionKey.bind(this),this._onDeleteKey=this._onDeleteKey.bind(this),this.passedElement.isActive)return this.config.silent||console.warn("Trying to initialise Choices on element already initialised",{element:e}),void(this.initialised=!0);this.init()}static get defaults(){return Object.preventExtensions({get options(){return hi},get templates(){return Me}})}init(){if(this.initialised)return;this._createTemplates(),this._createElements(),this._createStructure(),this._store.subscribe(this._render),this._render(),this._addEventListeners(),(!this.config.addItems||this.passedElement.element.hasAttribute("disabled"))&&this.disable(),this.initialised=!0;let{callbackOnInit:e}=this.config;e&&typeof e=="function"&&e.call(this)}destroy(){this.initialised&&(this._removeEventListeners(),this.passedElement.reveal(),this.containerOuter.unwrap(this.passedElement.element),this.clearStore(),this._isSelectElement&&(this.passedElement.options=this._presetOptions),this._templates=Me,this.initialised=!1)}enable(){return this.passedElement.isDisabled&&this.passedElement.enable(),this.containerOuter.isDisabled&&(this._addEventListeners(),this.input.enable(),this.containerOuter.enable()),this}disable(){return this.passedElement.isDisabled||this.passedElement.disable(),this.containerOuter.isDisabled||(this._removeEventListeners(),this.input.disable(),this.containerOuter.disable()),this}highlightItem(e,t=!0){if(!e||!e.id)return this;let{id:i,groupId:s=-1,value:n="",label:r=""}=e,a=s>=0?this._store.getGroupById(s):null;return this._store.dispatch(gt(i,!0)),t&&this.passedElement.triggerEvent(j.highlightItem,{id:i,value:n,label:r,groupValue:a&&a.value?a.value:null}),this}unhighlightItem(e){if(!e||!e.id)return this;let{id:t,groupId:i=-1,value:s="",label:n=""}=e,r=i>=0?this._store.getGroupById(i):null;return this._store.dispatch(gt(t,!1)),this.passedElement.triggerEvent(j.highlightItem,{id:t,value:s,label:n,groupValue:r&&r.value?r.value:null}),this}highlightAll(){return this._store.items.forEach(e=>this.highlightItem(e)),this}unhighlightAll(){return this._store.items.forEach(e=>this.unhighlightItem(e)),this}removeActiveItemsByValue(e){return this._store.activeItems.filter(t=>t.value===e).forEach(t=>this._removeItem(t)),this}removeActiveItems(e){return this._store.activeItems.filter(({id:t})=>t!==e).forEach(t=>this._removeItem(t)),this}removeHighlightedItems(e=!1){return this._store.highlightedActiveItems.forEach(t=>{this._removeItem(t),e&&this._triggerChange(t.value)}),this}showDropdown(e){return this.dropdown.isActive||requestAnimationFrame(()=>{this.dropdown.show(),this.containerOuter.open(this.dropdown.distanceFromTopWindow),!e&&this._canSearch&&this.input.focus(),this.passedElement.triggerEvent(j.showDropdown,{})}),this}hideDropdown(e){return this.dropdown.isActive?(requestAnimationFrame(()=>{this.dropdown.hide(),this.containerOuter.close(),!e&&this._canSearch&&(this.input.removeActiveDescendant(),this.input.blur()),this.passedElement.triggerEvent(j.hideDropdown,{})}),this):this}getValue(e=!1){let t=this._store.activeItems.reduce((i,s)=>{let n=e?s.value:s;return i.push(n),i},[]);return this._isSelectOneElement?t[0]:t}setValue(e){return this.initialised?(e.forEach(t=>this._setChoiceOrItem(t)),this):this}setChoiceByValue(e){return!this.initialised||this._isTextElement?this:((Array.isArray(e)?e:[e]).forEach(t=>this._findAndSelectChoiceByValue(t)),this)}setChoices(e=[],t="value",i="label",s=!1){if(!this.initialised)throw new ReferenceError("setChoices was called on a non-initialized instance of Choices");if(!this._isSelectElement)throw new TypeError("setChoices can't be used with INPUT based Choices");if(typeof t!="string"||!t)throw new TypeError("value parameter must be a name of 'value' field in passed objects");if(s&&this.clearChoices(),typeof e=="function"){let n=e(this);if(typeof Promise=="function"&&n instanceof Promise)return new Promise(r=>requestAnimationFrame(r)).then(()=>this._handleLoadingState(!0)).then(()=>n).then(r=>this.setChoices(r,t,i,s)).catch(r=>{this.config.silent||console.error(r)}).then(()=>this._handleLoadingState(!1)).then(()=>this);if(!Array.isArray(n))throw new TypeError(".setChoices first argument function must return either array of choices or Promise, got: "+typeof n);return this.setChoices(n,t,i,!1)}if(!Array.isArray(e))throw new TypeError(".setChoices must be called either with array of choices with a function resulting into Promise of array of choices");return this.containerOuter.removeLoadingState(),this._startLoading(),e.forEach(n=>{if(n.choices)this._addGroup({id:n.id?parseInt(`${n.id}`,10):null,group:n,valueKey:t,labelKey:i});else{let r=n;this._addChoice({value:r[t],label:r[i],isSelected:!!r.selected,isDisabled:!!r.disabled,placeholder:!!r.placeholder,customProperties:r.customProperties})}}),this._stopLoading(),this}clearChoices(){return this._store.dispatch({type:R.CLEAR_CHOICES}),this}clearStore(){return this._store.dispatch({type:R.CLEAR_ALL}),this}clearInput(){let e=!this._isSelectOneElement;return this.input.clear(e),!this._isTextElement&&this._canSearch&&(this._isSearching=!1,this._store.dispatch(Oe(!0))),this}_render(){if(this._store.isLoading())return;this._currentState=this._store.state;let e=this._currentState.choices!==this._prevState.choices||this._currentState.groups!==this._prevState.groups||this._currentState.items!==this._prevState.items,t=this._isSelectElement,i=this._currentState.items!==this._prevState.items;e&&(t&&this._renderChoices(),i&&this._renderItems(),this._prevState=this._currentState)}_renderChoices(){let{activeGroups:e,activeChoices:t}=this._store,i=document.createDocumentFragment();if(this.choiceList.clear(),this.config.resetScrollPosition&&requestAnimationFrame(()=>this.choiceList.scrollToTop()),e.length>=1&&!this._isSearching){let s=t.filter(n=>n.placeholder===!0&&n.groupId===-1);s.length>=1&&(i=this._createChoicesFragment(s,i)),i=this._createGroupsFragment(e,t,i)}else t.length>=1&&(i=this._createChoicesFragment(t,i));if(i.childNodes&&i.childNodes.length>0){let{activeItems:s}=this._store,n=this._canAddItem(s,this.input.value);if(n.response)this.choiceList.append(i),this._highlightChoice();else{let r=this._getTemplate("notice",n.notice);this.choiceList.append(r)}}else{let s,n;this._isSearching?(n=typeof this.config.noResultsText=="function"?this.config.noResultsText():this.config.noResultsText,s=this._getTemplate("notice",n,"no-results")):(n=typeof this.config.noChoicesText=="function"?this.config.noChoicesText():this.config.noChoicesText,s=this._getTemplate("notice",n,"no-choices")),this.choiceList.append(s)}}_renderItems(){let e=this._store.activeItems||[];this.itemList.clear();let t=this._createItemsFragment(e);t.childNodes&&this.itemList.append(t)}_createGroupsFragment(e,t,i=document.createDocumentFragment()){let s=n=>t.filter(r=>this._isSelectOneElement?r.groupId===n.id:r.groupId===n.id&&(this.config.renderSelectedChoices==="always"||!r.selected));return this.config.shouldSort&&e.sort(this.config.sorter),e.forEach(n=>{let r=s(n);if(r.length>=1){let a=this._getTemplate("choiceGroup",n);i.appendChild(a),this._createChoicesFragment(r,i,!0)}}),i}_createChoicesFragment(e,t=document.createDocumentFragment(),i=!1){let{renderSelectedChoices:s,searchResultLimit:n,renderChoiceLimit:r}=this.config,a=this._isSearching?ii:this.config.sorter,l=f=>{if(s!=="auto"||this._isSelectOneElement||!f.selected){let u=this._getTemplate("choice",f,this.config.itemSelectText);t.appendChild(u)}},c=e;s!=="auto"||this._isSelectOneElement||(c=e.filter(f=>!f.selected));let{placeholderChoices:h,normalChoices:p}=c.reduce((f,u)=>(u.placeholder?f.placeholderChoices.push(u):f.normalChoices.push(u),f),{placeholderChoices:[],normalChoices:[]});(this.config.shouldSort||this._isSearching)&&p.sort(a);let d=c.length,g=this._isSelectOneElement?[...h,...p]:p;this._isSearching?d=n:r&&r>0&&!i&&(d=r);for(let f=0;f<d;f+=1)g[f]&&l(g[f]);return t}_createItemsFragment(e,t=document.createDocumentFragment()){let{shouldSortItems:i,sorter:s,removeItemButton:n}=this.config;return i&&!this._isSelectOneElement&&e.sort(s),this._isTextElement?this.passedElement.value=e.map(({value:r})=>r).join(this.config.delimiter):this.passedElement.options=e,e.forEach(r=>{let a=this._getTemplate("item",r,n);t.appendChild(a)}),t}_triggerChange(e){e!=null&&this.passedElement.triggerEvent(j.change,{value:e})}_selectPlaceholderChoice(e){this._addItem({value:e.value,label:e.label,choiceId:e.id,groupId:e.groupId,placeholder:e.placeholder}),this._triggerChange(e.value)}_handleButtonAction(e,t){if(!(e&&t&&this.config.removeItems&&this.config.removeItemButton))return;let i=t.parentNode&&t.parentNode.dataset.id,s=i&&e.find(n=>n.id===parseInt(i,10));s&&(this._removeItem(s),this._triggerChange(s.value),this._isSelectOneElement&&this._store.placeholderChoice&&this._selectPlaceholderChoice(this._store.placeholderChoice))}_handleItemAction(e,t,i=!1){if(!e||!t||!this.config.removeItems||this._isSelectOneElement)return;let s=t.dataset.id;e.forEach(n=>{n.id!==parseInt(`${s}`,10)||n.highlighted?!i&&n.highlighted&&this.unhighlightItem(n):this.highlightItem(n)}),this.input.focus()}_handleChoiceAction(e,t){if(!e||!t)return;let{id:i}=t.dataset,s=i&&this._store.getChoiceById(i);if(!s)return;let n=e[0]&&e[0].keyCode?e[0].keyCode:void 0,r=this.dropdown.isActive;s.keyCode=n,this.passedElement.triggerEvent(j.choice,{choice:s}),!s.selected&&!s.disabled&&this._canAddItem(e,s.value).response&&(this._addItem({value:s.value,label:s.label,choiceId:s.id,groupId:s.groupId,customProperties:s.customProperties,placeholder:s.placeholder,keyCode:s.keyCode}),this._triggerChange(s.value)),this.clearInput(),r&&this._isSelectOneElement&&(this.hideDropdown(!0),this.containerOuter.focus())}_handleBackspace(e){if(!this.config.removeItems||!e)return;let t=e[e.length-1],i=e.some(s=>s.highlighted);this.config.editItems&&!i&&t?(this.input.value=t.value,this.input.setWidth(),this._removeItem(t),this._triggerChange(t.value)):(i||this.highlightItem(t,!1),this.removeHighlightedItems(!0))}_startLoading(){this._store.dispatch(ft(!0))}_stopLoading(){this._store.dispatch(ft(!1))}_handleLoadingState(e=!0){let t=this.itemList.getChild(`.${this.config.classNames.placeholder}`);e?(this.disable(),this.containerOuter.addLoadingState(),this._isSelectOneElement?t?t.innerHTML=this.config.loadingText:(t=this._getTemplate("placeholder",this.config.loadingText),t&&this.itemList.append(t)):this.input.placeholder=this.config.loadingText):(this.enable(),this.containerOuter.removeLoadingState(),this._isSelectOneElement?t&&(t.innerHTML=this._placeholderValue||""):this.input.placeholder=this._placeholderValue||"")}_handleSearch(e){if(!this.input.isFocussed)return;let{choices:t}=this._store,{searchFloor:i,searchChoices:s}=this.config,n=t.some(r=>!r.active);if(e!=null&&e.length>=i){let r=s?this._searchChoices(e):0;this.passedElement.triggerEvent(j.search,{value:e,resultCount:r})}else n&&(this._isSearching=!1,this._store.dispatch(Oe(!0)))}_canAddItem(e,t){let i=!0,s=typeof this.config.addItemText=="function"?this.config.addItemText(t):this.config.addItemText;if(!this._isSelectOneElement){let n=((r,a,l="value")=>r.some(c=>typeof a=="string"?c[l]===a.trim():c[l]===a))(e,t);this.config.maxItemCount>0&&this.config.maxItemCount<=e.length&&(i=!1,s=typeof this.config.maxItemText=="function"?this.config.maxItemText(this.config.maxItemCount):this.config.maxItemText),!this.config.duplicateItemsAllowed&&n&&i&&(i=!1,s=typeof this.config.uniqueItemText=="function"?this.config.uniqueItemText(t):this.config.uniqueItemText),this._isTextElement&&this.config.addItems&&i&&typeof this.config.addItemFilter=="function"&&!this.config.addItemFilter(t)&&(i=!1,s=typeof this.config.customAddItemText=="function"?this.config.customAddItemText(t):this.config.customAddItemText)}return{response:i,notice:s}}_searchChoices(e){let t=typeof e=="string"?e.trim():e,i=typeof this._currentValue=="string"?this._currentValue.trim():this._currentValue;if(t.length<1&&t===`${i} `)return 0;let s=this._store.searchableChoices,n=t,r=Object.assign(this.config.fuseOptions,{keys:[...this.config.searchFields],includeMatches:!0}),a=new U(s,r).search(n);return this._currentValue=t,this._highlightPosition=0,this._isSearching=!0,this._store.dispatch((l=>({type:R.FILTER_CHOICES,results:l}))(a)),a.length}_addEventListeners(){let{documentElement:e}=document;e.addEventListener("touchend",this._onTouchEnd,!0),this.containerOuter.element.addEventListener("keydown",this._onKeyDown,!0),this.containerOuter.element.addEventListener("mousedown",this._onMouseDown,!0),e.addEventListener("click",this._onClick,{passive:!0}),e.addEventListener("touchmove",this._onTouchMove,{passive:!0}),this.dropdown.element.addEventListener("mouseover",this._onMouseOver,{passive:!0}),this._isSelectOneElement&&(this.containerOuter.element.addEventListener("focus",this._onFocus,{passive:!0}),this.containerOuter.element.addEventListener("blur",this._onBlur,{passive:!0})),this.input.element.addEventListener("keyup",this._onKeyUp,{passive:!0}),this.input.element.addEventListener("focus",this._onFocus,{passive:!0}),this.input.element.addEventListener("blur",this._onBlur,{passive:!0}),this.input.element.form&&this.input.element.form.addEventListener("reset",this._onFormReset,{passive:!0}),this.input.addEventListeners()}_removeEventListeners(){let{documentElement:e}=document;e.removeEventListener("touchend",this._onTouchEnd,!0),this.containerOuter.element.removeEventListener("keydown",this._onKeyDown,!0),this.containerOuter.element.removeEventListener("mousedown",this._onMouseDown,!0),e.removeEventListener("click",this._onClick),e.removeEventListener("touchmove",this._onTouchMove),this.dropdown.element.removeEventListener("mouseover",this._onMouseOver),this._isSelectOneElement&&(this.containerOuter.element.removeEventListener("focus",this._onFocus),this.containerOuter.element.removeEventListener("blur",this._onBlur)),this.input.element.removeEventListener("keyup",this._onKeyUp),this.input.element.removeEventListener("focus",this._onFocus),this.input.element.removeEventListener("blur",this._onBlur),this.input.element.form&&this.input.element.form.removeEventListener("reset",this._onFormReset),this.input.removeEventListeners()}_onKeyDown(e){let{keyCode:t}=e,{activeItems:i}=this._store,s=this.input.isFocussed,n=this.dropdown.isActive,r=this.itemList.hasChildren(),a=String.fromCharCode(t),l=/[a-zA-Z0-9-_ ]/.test(a),{BACK_KEY:c,DELETE_KEY:h,ENTER_KEY:p,A_KEY:d,ESC_KEY:g,UP_KEY:f,DOWN_KEY:u,PAGE_UP_KEY:m,PAGE_DOWN_KEY:b}=me;switch(this._isTextElement||n||!l||(this.showDropdown(),this.input.isFocussed||(this.input.value+=a.toLowerCase())),t){case d:return this._onSelectKey(e,r);case p:return this._onEnterKey(e,i,n);case g:return this._onEscapeKey(n);case f:case m:case u:case b:return this._onDirectionKey(e,n);case h:case c:return this._onDeleteKey(e,i,s)}}_onKeyUp({target:e,keyCode:t}){let{value:i}=this.input,{activeItems:s}=this._store,n=this._canAddItem(s,i),{BACK_KEY:r,DELETE_KEY:a}=me;if(this._isTextElement)if(n.notice&&i){let l=this._getTemplate("notice",n.notice);this.dropdown.element.innerHTML=l.outerHTML,this.showDropdown(!0)}else this.hideDropdown(!0);else{let l=(t===r||t===a)&&e&&!e.value,c=!this._isTextElement&&this._isSearching,h=this._canSearch&&n.response;l&&c?(this._isSearching=!1,this._store.dispatch(Oe(!0))):h&&this._handleSearch(this.input.rawValue)}this._canSearch=this.config.searchEnabled}_onSelectKey(e,t){let{ctrlKey:i,metaKey:s}=e;(i||s)&&t&&(this._canSearch=!1,this.config.removeItems&&!this.input.value&&this.input.element===document.activeElement&&this.highlightAll())}_onEnterKey(e,t,i){let{target:s}=e,{ENTER_KEY:n}=me,r=s&&s.hasAttribute("data-button");if(this._isTextElement&&s&&s.value){let{value:a}=this.input;this._canAddItem(t,a).response&&(this.hideDropdown(!0),this._addItem({value:a}),this._triggerChange(a),this.clearInput())}if(r&&(this._handleButtonAction(t,s),e.preventDefault()),i){let a=this.dropdown.getChild(`.${this.config.classNames.highlightedState}`);a&&(t[0]&&(t[0].keyCode=n),this._handleChoiceAction(t,a)),e.preventDefault()}else this._isSelectOneElement&&(this.showDropdown(),e.preventDefault())}_onEscapeKey(e){e&&(this.hideDropdown(!0),this.containerOuter.focus())}_onDirectionKey(e,t){let{keyCode:i,metaKey:s}=e,{DOWN_KEY:n,PAGE_UP_KEY:r,PAGE_DOWN_KEY:a}=me;if(t||this._isSelectOneElement){this.showDropdown(),this._canSearch=!1;let l=i===n||i===a?1:-1,c="[data-choice-selectable]",h;if(s||i===a||i===r)h=l>0?this.dropdown.element.querySelector(`${c}:last-of-type`):this.dropdown.element.querySelector(c);else{let p=this.dropdown.element.querySelector(`.${this.config.classNames.highlightedState}`);h=p?((d,g,f=1)=>{let u=(f>0?"next":"previous")+"ElementSibling",m=d[u];for(;m;){if(m.matches(g))return m;m=m[u]}return m})(p,c,l):this.dropdown.element.querySelector(c)}h&&(((p,d,g=1)=>{if(!p)return!1;let f;return f=g>0?d.scrollTop+d.offsetHeight>=p.offsetTop+p.offsetHeight:p.offsetTop>=d.scrollTop,f})(h,this.choiceList.element,l)||this.choiceList.scrollToChildElement(h,l),this._highlightChoice(h)),e.preventDefault()}}_onDeleteKey(e,t,i){let{target:s}=e;this._isSelectOneElement||s.value||!i||(this._handleBackspace(t),e.preventDefault())}_onTouchMove(){this._wasTap&&(this._wasTap=!1)}_onTouchEnd(e){let{target:t}=e||e.touches[0];this._wasTap&&this.containerOuter.element.contains(t)&&((t===this.containerOuter.element||t===this.containerInner.element)&&(this._isTextElement?this.input.focus():this._isSelectMultipleElement&&this.showDropdown()),e.stopPropagation()),this._wasTap=!0}_onMouseDown(e){let{target:t}=e;if(!(t instanceof HTMLElement))return;if(ci&&this.choiceList.element.contains(t)){let s=this.choiceList.element.firstElementChild,n=this._direction==="ltr"?e.offsetX>=s.offsetWidth:e.offsetX<s.offsetLeft;this._isScrollingOnIe=n}if(t===this.input.element)return;let i=t.closest("[data-button],[data-item],[data-choice]");if(i instanceof HTMLElement){let s=e.shiftKey,{activeItems:n}=this._store,{dataset:r}=i;"button"in r?this._handleButtonAction(n,i):"item"in r?this._handleItemAction(n,i,s):"choice"in r&&this._handleChoiceAction(n,i)}e.preventDefault()}_onMouseOver({target:e}){e instanceof HTMLElement&&"choice"in e.dataset&&this._highlightChoice(e)}_onClick({target:e}){this.containerOuter.element.contains(e)?this.dropdown.isActive||this.containerOuter.isDisabled?this._isSelectOneElement&&e!==this.input.element&&!this.dropdown.element.contains(e)&&this.hideDropdown():this._isTextElement?document.activeElement!==this.input.element&&this.input.focus():(this.showDropdown(),this.containerOuter.focus()):(this._store.highlightedActiveItems.length>0&&this.unhighlightAll(),this.containerOuter.removeFocusState(),this.hideDropdown(!0))}_onFocus({target:e}){e&&this.containerOuter.element.contains(e)&&{text:()=>{e===this.input.element&&this.containerOuter.addFocusState()},"select-one":()=>{this.containerOuter.addFocusState(),e===this.input.element&&this.showDropdown(!0)},"select-multiple":()=>{e===this.input.element&&(this.showDropdown(!0),this.containerOuter.addFocusState())}}[this.passedElement.element.type]()}_onBlur({target:e}){if(e&&this.containerOuter.element.contains(e)&&!this._isScrollingOnIe){let{activeItems:t}=this._store,i=t.some(s=>s.highlighted);({text:()=>{e===this.input.element&&(this.containerOuter.removeFocusState(),i&&this.unhighlightAll(),this.hideDropdown(!0))},"select-one":()=>{this.containerOuter.removeFocusState(),(e===this.input.element||e===this.containerOuter.element&&!this._canSearch)&&this.hideDropdown(!0)},"select-multiple":()=>{e===this.input.element&&(this.containerOuter.removeFocusState(),this.hideDropdown(!0),i&&this.unhighlightAll())}})[this.passedElement.element.type]()}else this._isScrollingOnIe=!1,this.input.element.focus()}_onFormReset(){var e;this._store.dispatch((e=this._initialState,{type:R.RESET_TO,state:e}))}_highlightChoice(e=null){let t=Array.from(this.dropdown.element.querySelectorAll("[data-choice-selectable]"));if(!t.length)return;let i=e;Array.from(this.dropdown.element.querySelectorAll(`.${this.config.classNames.highlightedState}`)).forEach(s=>{s.classList.remove(this.config.classNames.highlightedState),s.setAttribute("aria-selected","false")}),i?this._highlightPosition=t.indexOf(i):(i=t.length>this._highlightPosition?t[this._highlightPosition]:t[t.length-1],i||(i=t[0])),i.classList.add(this.config.classNames.highlightedState),i.setAttribute("aria-selected","true"),this.passedElement.triggerEvent(j.highlightChoice,{el:i}),this.dropdown.isActive&&(this.input.setActiveDescendant(i.id),this.containerOuter.setActiveDescendant(i.id))}_addItem({value:e,label:t=null,choiceId:i=-1,groupId:s=-1,customProperties:n={},placeholder:r=!1,keyCode:a=-1}){let l=typeof e=="string"?e.trim():e,{items:c}=this._store,h=t||l,p=i||-1,d=s>=0?this._store.getGroupById(s):null,g=c?c.length+1:1;this.config.prependValue&&(l=this.config.prependValue+l.toString()),this.config.appendValue&&(l+=this.config.appendValue.toString()),this._store.dispatch((({value:f,label:u,id:m,choiceId:b,groupId:y,customProperties:v,placeholder:w,keyCode:S})=>({type:R.ADD_ITEM,value:f,label:u,id:m,choiceId:b,groupId:y,customProperties:v,placeholder:w,keyCode:S}))({value:l,label:h,id:g,choiceId:p,groupId:s,customProperties:n,placeholder:r,keyCode:a})),this._isSelectOneElement&&this.removeActiveItems(g),this.passedElement.triggerEvent(j.addItem,{id:g,value:l,label:h,customProperties:n,groupValue:d&&d.value?d.value:null,keyCode:a})}_removeItem(e){let{id:t,value:i,label:s,customProperties:n,choiceId:r,groupId:a}=e,l=a&&a>=0?this._store.getGroupById(a):null;t&&r&&(this._store.dispatch(((c,h)=>({type:R.REMOVE_ITEM,id:c,choiceId:h}))(t,r)),this.passedElement.triggerEvent(j.removeItem,{id:t,value:i,label:s,customProperties:n,groupValue:l&&l.value?l.value:null}))}_addChoice({value:e,label:t=null,isSelected:i=!1,isDisabled:s=!1,groupId:n=-1,customProperties:r={},placeholder:a=!1,keyCode:l=-1}){if(e==null)return;let{choices:c}=this._store,h=t||e,p=c?c.length+1:1,d=`${this._baseId}-${this._idNames.itemChoice}-${p}`;this._store.dispatch((({value:g,label:f,id:u,groupId:m,disabled:b,elementId:y,customProperties:v,placeholder:w,keyCode:S})=>({type:R.ADD_CHOICE,value:g,label:f,id:u,groupId:m,disabled:b,elementId:y,customProperties:v,placeholder:w,keyCode:S}))({id:p,groupId:n,elementId:d,value:e,label:h,disabled:s,customProperties:r,placeholder:a,keyCode:l})),i&&this._addItem({value:e,label:h,choiceId:p,customProperties:r,placeholder:a,keyCode:l})}_addGroup({group:e,id:t,valueKey:i="value",labelKey:s="label"}){let n=yt("Object",e)?e.choices:Array.from(e.getElementsByTagName("OPTION")),r=t||Math.floor(new Date().valueOf()*Math.random()),a=!!e.disabled&&e.disabled;if(n){this._store.dispatch(pt({value:e.label,id:r,active:!0,disabled:a}));let l=c=>{let h=c.disabled||c.parentNode&&c.parentNode.disabled;this._addChoice({value:c[i],label:yt("Object",c)?c[s]:c.innerHTML,isSelected:c.selected,isDisabled:h,groupId:r,customProperties:c.customProperties,placeholder:c.placeholder})};n.forEach(l)}else this._store.dispatch(pt({value:e.label,id:e.id,active:!1,disabled:e.disabled}))}_getTemplate(e,...t){return this._templates[e].call(this,this.config,...t)}_createTemplates(){let{callbackOnCreateTemplates:e}=this.config,t={};e&&typeof e=="function"&&(t=e.call(this,ti)),this._templates=at(Me,t)}_createElements(){this.containerOuter=new ye({element:this._getTemplate("containerOuter",this._direction,this._isSelectElement,this._isSelectOneElement,this.config.searchEnabled,this.passedElement.element.type),classNames:this.config.classNames,type:this.passedElement.element.type,position:this.config.position}),this.containerInner=new ye({element:this._getTemplate("containerInner"),classNames:this.config.classNames,type:this.passedElement.element.type,position:this.config.position}),this.input=new Fe({element:this._getTemplate("input",this._placeholderValue),classNames:this.config.classNames,type:this.passedElement.element.type,preventPaste:!this.config.paste}),this.choiceList=new ve({element:this._getTemplate("choiceList",this._isSelectOneElement)}),this.itemList=new ve({element:this._getTemplate("itemList",this._isSelectOneElement)}),this.dropdown=new Be({element:this._getTemplate("dropdown"),classNames:this.config.classNames,type:this.passedElement.element.type})}_createStructure(){this.passedElement.conceal(),this.containerInner.wrap(this.passedElement.element),this.containerOuter.wrap(this.containerInner.element),this._isSelectOneElement?this.input.placeholder=this.config.searchPlaceholderValue||"":this._placeholderValue&&(this.input.placeholder=this._placeholderValue,this.input.setWidth()),this.containerOuter.element.appendChild(this.containerInner.element),this.containerOuter.element.appendChild(this.dropdown.element),this.containerInner.element.appendChild(this.itemList.element),this._isTextElement||this.dropdown.element.appendChild(this.choiceList.element),this._isSelectOneElement?this.config.searchEnabled&&this.dropdown.element.insertBefore(this.input.element,this.dropdown.element.firstChild):this.containerInner.element.appendChild(this.input.element),this._isSelectElement&&(this._highlightPosition=0,this._isSearching=!1,this._startLoading(),this._presetGroups.length?this._addPredefinedGroups(this._presetGroups):this._addPredefinedChoices(this._presetChoices),this._stopLoading()),this._isTextElement&&this._addPredefinedItems(this._presetItems)}_addPredefinedGroups(e){let t=this.passedElement.placeholderOption;t&&t.parentNode&&t.parentNode.tagName==="SELECT"&&this._addChoice({value:t.value,label:t.innerHTML,isSelected:t.selected,isDisabled:t.disabled,placeholder:!0}),e.forEach(i=>this._addGroup({group:i,id:i.id||null}))}_addPredefinedChoices(e){this.config.shouldSort&&e.sort(this.config.sorter);let t=e.some(s=>s.selected),i=e.findIndex(s=>s.disabled===void 0||!s.disabled);e.forEach((s,n)=>{let{value:r="",label:a,customProperties:l,placeholder:c}=s;if(this._isSelectElement)if(s.choices)this._addGroup({group:s,id:s.id||null});else{let h=!!(this._isSelectOneElement&&!t&&n===i)||s.selected,p=s.disabled;this._addChoice({value:r,label:a,isSelected:!!h,isDisabled:!!p,placeholder:!!c,customProperties:l})}else this._addChoice({value:r,label:a,isSelected:!!s.selected,isDisabled:!!s.disabled,placeholder:!!s.placeholder,customProperties:l})})}_addPredefinedItems(e){e.forEach(t=>{typeof t=="object"&&t.value&&this._addItem({value:t.value,label:t.label,choiceId:t.id,customProperties:t.customProperties,placeholder:t.placeholder}),typeof t=="string"&&this._addItem({value:t})})}_setChoiceOrItem(e){({object:()=>{e.value&&(this._isTextElement?this._addItem({value:e.value,label:e.label,choiceId:e.id,customProperties:e.customProperties,placeholder:e.placeholder}):this._addChoice({value:e.value,label:e.label,isSelected:!0,isDisabled:!1,customProperties:e.customProperties,placeholder:e.placeholder}))},string:()=>{this._isTextElement?this._addItem({value:e}):this._addChoice({value:e,label:e,isSelected:!0,isDisabled:!1})}})[Ot(e).toLowerCase()]()}_findAndSelectChoiceByValue(e){let{choices:t}=this._store,i=t.find(s=>this.config.valueComparer(s.value,e));i&&!i.selected&&this._addItem({value:i.value,label:i.label,choiceId:i.id,groupId:i.groupId,customProperties:i.customProperties,placeholder:i.placeholder,keyCode:i.keyCode})}_generatePlaceholderValue(){if(this._isSelectElement&&this.passedElement.placeholderOption){let{placeholderOption:s}=this.passedElement;return s?s.text:null}let{placeholder:e,placeholderValue:t}=this.config,{element:{dataset:i}}=this.passedElement;if(e){if(t)return t;if(i.placeholder)return i.placeholder}return null}};var Q=GM_info.script.name.toString(),re=GM_info.script.version.toString(),di="color: cornflowerblue;",Ke="https://raw.githubusercontent.com/Egorrko/wplace-templates/refs/heads/main/",Ce="https://freakland.egorrko.ru";function ui(o){let e=document.createElement("script");e.setAttribute("bm-name",Q),e.setAttribute("bm-cStyle",di),e.textContent=`(${o})();`,document.documentElement?.appendChild(e),e.remove()}ui(()=>{let o=document.currentScript,e=o?.getAttribute("bm-name")||"Blue Marble",t=o?.getAttribute("bm-cStyle")||"",i=new Map;window.addEventListener("message",n=>{let{source:r,endpoint:a,blobID:l,blobData:c,blink:h}=n.data,p=Date.now()-h;if(console.groupCollapsed(`%c${e}%c: ${i.size} Recieved IMAGE message about blob "${l}"`,t,""),console.log(`Blob fetch took %c${String(Math.floor(p/6e4)).padStart(2,"0")}:${String(Math.floor(p/1e3)%60).padStart(2,"0")}.${String(p%1e3).padStart(3,"0")}%c MM:SS.mmm`,t,""),console.log(i),console.groupEnd(),r=="blue-marble"&&l&&c&&!a){let d=i.get(l);typeof d=="function"?d(c):Ze(`%c${e}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,t,"",l),i.delete(l)}});let s=window.fetch;window.fetch=async function(...n){let r=await s.apply(this,n),a=r.clone(),l=(n[0]instanceof Request?n[0]?.url:n[0])||"ignore",c=a.headers.get("content-type")||"";if(c.includes("application/json"))console.log(`%c${e}%c: Sending JSON message about endpoint "${l}"`,t,""),a.json().then(h=>{window.postMessage({source:"blue-marble",endpoint:l,jsonData:h},"*")}).catch(h=>{console.error(`%c${e}%c: Failed to parse JSON: `,t,"",h)});else if(c.includes("image/")&&!l.includes("openfreemap")&&!l.includes("maps")){let h=Date.now(),p=await a.blob();return console.log(`%c${e}%c: ${i.size} Sending IMAGE message about endpoint "${l}"`,t,""),new Promise(d=>{let g=crypto.randomUUID();i.set(g,f=>{d(new Response(f,{headers:a.headers,status:a.status,statusText:a.statusText})),console.log(`%c${e}%c: ${i.size} Processed blob "${g}"`,t,"")}),window.postMessage({source:"blue-marble",endpoint:l,blobID:g,blobData:p,blink:h})}).catch(d=>{let g=Date.now();console.error(`%c${e}%c: Failed to Promise blob!`,t,""),console.groupCollapsed(`%c${e}%c: Details of failed blob Promise:`,t,""),console.log(`Endpoint: ${l}
There are ${i.size} blobs processing...
Blink: ${h.toLocaleString()}
Time Since Blink: ${String(Math.floor(g/6e4)).padStart(2,"0")}:${String(Math.floor(g/1e3)%60).padStart(2,"0")}.${String(g%1e3).padStart(3,"0")} MM:SS.mmm`),console.error("Exception stack:",d),console.groupEnd()})}return r}});GM_addStyle(`.choices{position:relative;overflow:hidden;margin-bottom:24px;font-size:16px}.choices:focus{outline:0}.choices:last-child{margin-bottom:0}.choices.is-open{overflow:initial}.choices.is-disabled .choices__inner,.choices.is-disabled .choices__input{background-color:#eaeaea;cursor:not-allowed;-webkit-user-select:none;user-select:none}.choices.is-disabled .choices__item{cursor:not-allowed}.choices [hidden]{display:none!important}.choices[data-type*=select-one]{cursor:pointer}.choices[data-type*=select-one] .choices__inner{padding-bottom:7.5px}.choices[data-type*=select-one] .choices__input{display:block;width:100%;padding:10px;border-bottom:1px solid #ddd;background-color:#fff;margin:0}.choices[data-type*=select-one] .choices__button{background-image:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjEiIGhlaWdodD0iMjEiIHZpZXdCb3g9IjAgMCAyMSAyMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSIjMDAwIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0yLjU5Mi4wNDRsMTguMzY0IDE4LjM2NC0yLjU0OCAyLjU0OEwuMDQ0IDIuNTkyeiIvPjxwYXRoIGQ9Ik0wIDE4LjM2NEwxOC4zNjQgMGwyLjU0OCAyLjU0OEwyLjU0OCAyMC45MTJ6Ii8+PC9nPjwvc3ZnPg==);padding:0;background-size:8px;position:absolute;top:50%;right:0;margin-top:-10px;margin-right:25px;height:20px;width:20px;border-radius:10em;opacity:.25}.choices[data-type*=select-one] .choices__button:focus,.choices[data-type*=select-one] .choices__button:hover{opacity:1}.choices[data-type*=select-one] .choices__button:focus{box-shadow:0 0 0 2px #00bcd4}.choices[data-type*=select-one] .choices__item[data-value=""] .choices__button{display:none}.choices[data-type*=select-one]:after{content:"";height:0;width:0;border-style:solid;border-color:#333 transparent transparent;border-width:5px;position:absolute;right:11.5px;top:50%;margin-top:-2.5px;pointer-events:none}.choices[data-type*=select-one].is-open:after{border-color:transparent transparent #333;margin-top:-7.5px}.choices[data-type*=select-one][dir=rtl]:after{left:11.5px;right:auto}.choices[data-type*=select-one][dir=rtl] .choices__button{right:auto;left:0;margin-left:25px;margin-right:0}.choices[data-type*=select-multiple] .choices__inner,.choices[data-type*=text] .choices__inner{cursor:text}.choices[data-type*=select-multiple] .choices__button,.choices[data-type*=text] .choices__button{position:relative;display:inline-block;margin:0 -4px 0 8px;padding-left:16px;border-left:1px solid #008fa1;background-image:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjEiIGhlaWdodD0iMjEiIHZpZXdCb3g9IjAgMCAyMSAyMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSIjRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0yLjU5Mi4wNDRsMTguMzY0IDE4LjM2NC0yLjU0OCAyLjU0OEwuMDQ0IDIuNTkyeiIvPjxwYXRoIGQ9Ik0wIDE4LjM2NEwxOC4zNjQgMGwyLjU0OCAyLjU0OEwyLjU0OCAyMC45MTJ6Ii8+PC9nPjwvc3ZnPg==);background-size:8px;width:8px;line-height:1;opacity:.75;border-radius:0}.choices[data-type*=select-multiple] .choices__button:focus,.choices[data-type*=select-multiple] .choices__button:hover,.choices[data-type*=text] .choices__button:focus,.choices[data-type*=text] .choices__button:hover{opacity:1}.choices__inner{display:inline-block;vertical-align:top;width:100%;background-color:#f9f9f9;padding:7.5px 7.5px 3.75px;border:1px solid #ddd;border-radius:2.5px;font-size:14px;min-height:44px;overflow:hidden}.is-focused .choices__inner,.is-open .choices__inner{border-color:#b7b7b7}.is-open .choices__inner{border-radius:2.5px 2.5px 0 0}.is-flipped.is-open .choices__inner{border-radius:0 0 2.5px 2.5px}.choices__list{margin:0;padding-left:0;list-style:none}.choices__list--single{display:inline-block;padding:4px 16px 4px 4px;width:100%}[dir=rtl] .choices__list--single{padding-right:4px;padding-left:16px}.choices__list--single .choices__item{width:100%}.choices__list--multiple{display:inline}.choices__list--multiple .choices__item{display:inline-block;vertical-align:middle;border-radius:20px;padding:4px 10px;font-size:12px;font-weight:500;margin-right:3.75px;margin-bottom:3.75px;background-color:#00bcd4;border:1px solid #00a5bb;color:#fff;word-break:break-all;box-sizing:border-box}.choices__list--multiple .choices__item[data-deletable]{padding-right:5px}[dir=rtl] .choices__list--multiple .choices__item{margin-right:0;margin-left:3.75px}.choices__list--multiple .choices__item.is-highlighted{background-color:#00a5bb;border:1px solid #008fa1}.is-disabled .choices__list--multiple .choices__item{background-color:#aaa;border:1px solid #919191}.choices__list--dropdown{visibility:hidden;z-index:1;position:absolute;width:100%;background-color:#fff;border:1px solid #ddd;top:100%;margin-top:-1px;border-bottom-left-radius:2.5px;border-bottom-right-radius:2.5px;overflow:hidden;word-break:break-all;will-change:visibility}.choices__list--dropdown.is-active{visibility:visible}.is-open .choices__list--dropdown{border-color:#b7b7b7}.is-flipped .choices__list--dropdown{top:auto;bottom:100%;margin-top:0;margin-bottom:-1px;border-radius:.25rem .25rem 0 0}.choices__list--dropdown .choices__list{position:relative;max-height:300px;overflow:auto;-webkit-overflow-scrolling:touch;will-change:scroll-position}.choices__list--dropdown .choices__item{position:relative;padding:10px;font-size:14px}[dir=rtl] .choices__list--dropdown .choices__item{text-align:right}@media (min-width:640px){.choices__list--dropdown .choices__item--selectable{padding-right:100px}.choices__list--dropdown .choices__item--selectable:after{content:attr(data-select-text);font-size:12px;opacity:0;position:absolute;right:10px;top:50%;transform:translateY(-50%)}[dir=rtl] .choices__list--dropdown .choices__item--selectable{text-align:right;padding-left:100px;padding-right:10px}[dir=rtl] .choices__list--dropdown .choices__item--selectable:after{right:auto;left:10px}}.choices__list--dropdown .choices__item--selectable.is-highlighted{background-color:#f2f2f2}.choices__list--dropdown .choices__item--selectable.is-highlighted:after{opacity:.5}.choices__item{cursor:default}.choices__item--selectable{cursor:pointer}.choices__item--disabled{cursor:not-allowed;-webkit-user-select:none;user-select:none;opacity:.5}.choices__heading{font-weight:600;font-size:12px;padding:10px;border-bottom:1px solid #f7f7f7;color:gray}.choices__button{text-indent:-9999px;-webkit-appearance:none;appearance:none;border:0;background-color:transparent;background-repeat:no-repeat;background-position:center;cursor:pointer}.choices__button:focus,.choices__input:focus{outline:0}.choices__input{display:inline-block;vertical-align:baseline;background-color:#f9f9f9;font-size:14px;margin-bottom:5px;border:0;border-radius:0;max-width:100%;padding:4px 0 4px 2px}[dir=rtl] .choices__input{padding-right:2px;padding-left:0}.choices__placeholder{opacity:.5}#bm-overlay,#bm-overlay-telemetry{position:fixed;background-color:#b6b9cae6;color:#000;padding:10px;border-radius:8px;z-index:9000;transition:all .3s ease,transform 0s;max-width:300px;width:auto;will-change:transform;backface-visibility:hidden;-webkit-backface-visibility:hidden;transform-style:preserve-3d;-webkit-transform-style:preserve-3d}#bm-contain-userinfo,#bm-overlay hr,#bm-overlay-telemetry hr,#bm-contain-automation,#bm-contain-buttons-action{transition:opacity .2s ease,height .2s ease}div#bm-overlay,div#bm-overlay-telemetry{font-family:Roboto Mono,Courier New,Monaco,DejaVu Sans Mono,monospace,Arial;letter-spacing:.05em}#bm-bar-drag,#bm-bar-drag-telemetry{margin-bottom:.5em;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="5" height="5"><circle cx="3" cy="3" r="1.5" fill="CornflowerBlue" /></svg>') repeat;cursor:grab;width:100%;height:1em}#bm-bar-drag.dragging,#bm-bar-drag-telemetry.dragging{cursor:grabbing}#bm-overlay:has(#bm-bar-drag.dragging),#bm-overlay-telemetry:has(#bm-bar-drag-telemetry.dragging){pointer-events:none;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}#bm-bar-drag.dragging,#bm-bar-drag-telemetry.dragging{pointer-events:auto}#bm-contain-header,#bm-contain-header-telemetry{margin-bottom:.5em}#bm-contain-header[style*="text-align: center"],#bm-contain-header-telemetry[style*="text-align: center"]{display:flex;flex-direction:column;align-items:center;justify-content:center}#bm-overlay[style*="padding: 5px"],#bm-overlay-telemetry[style*="padding: 5px"]{width:auto!important;max-width:300px;min-width:200px}#bm-overlay img{display:inline-block;height:2.5em;margin-right:1ch;vertical-align:middle;transition:opacity .2s ease}#bm-contain-header[style*="text-align: center"] img{display:block;margin:0 auto}#bm-bar-drag,#bm-bar-drag-telemetry{transition:margin-bottom .2s ease}#bm-overlay h1,#bm-overlay-telemetry h1{display:inline-block;font-size:x-large;font-weight:700;vertical-align:middle}#bm-contain-automation input[type=checkbox]{vertical-align:middle;margin-right:.5ch}#bm-contain-automation label{margin-right:.5ch}.bm-help{border:white 1px solid;height:1.5em;width:1.5em;margin-top:2px;text-align:center;line-height:1em;padding:0!important}#bm-button-coords{vertical-align:middle}#bm-button-coords svg{width:50%;margin:0 auto;fill:#111}div:has(>#bm-button-teleport){display:flex;gap:.5ch}#bm-button-favorite svg,#bm-button-template svg{height:1em;margin:2px auto 0;text-align:center;line-height:1em;vertical-align:bottom}#bm-contain-coords input[type=number]{appearance:auto;-moz-appearance:textfield;width:5.5ch;margin-left:1ch;background-color:#0003;padding:0 .5ch;font-size:small}#bm-contain-coords input[type=number]::-webkit-outer-spin-button,#bm-contain-coords input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}#bm-contain-buttons-template{display:flex;flex-direction:row;flex-wrap:wrap;align-content:center;justify-content:center;align-items:center;gap:1ch}div:has(>#bm-input-file-template)>button{width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#bm-input-file-template,input[type=file][id*=template]{display:none!important;visibility:hidden!important;position:absolute!important;left:-9999px!important;top:-9999px!important;width:0!important;height:0!important;opacity:0!important;z-index:-9999!important;pointer-events:none!important}#bm-output-status{font-size:small;background-color:#0003;padding:0 .5ch;height:5rem;min-height:5rem;width:100%}#bm-contain-buttons-action{display:flex;justify-content:space-between}#bm-overlay small{font-size:x-small;color:#d3d3d3}#bm-contain-userinfo,#bm-contain-automation,#bm-contain-coords,#bm-contain-buttons-template,div:has(>#bm-input-file-template),#bm-output-status{margin-top:.5em}#bm-overlay button,#bm-overlay-telemetry button{background-color:#7fa5eb;border-radius:1em;padding:0 .75ch}#bm-overlay button:hover,#bm-overlay button:focus-visible,#bm-overlay-telemetry button:hover,#bm-overlay-telemetry button:focus-visible{background-color:#7fa5eb}#bm-overlay button:active,#bm-overlay-telemetry button:active #bm-overlay button:disabled,#bm-overlay-telemetry button:disabled{background-color:#7fa5eb}#bm-overlay button:disabled,#bm-overlay-telemetry button:disabled{text-decoration:line-through}#bm-selector-templates{background-color:#7fa5eb}#bm-selector-templates:hover{background-color:#6893e2;cursor:pointer}.choices{font-size:14px}.choices__inner{min-height:auto;padding:4px 8px}.choices__list--dropdown .choices__item--choice{font-size:14px;padding:6px 10px}.choices__list--dropdown .choices__item--choice .choices__item-text{white-space:normal;word-wrap:break-word}
`);var ae=document.createElement("link");ae.href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap";ae.rel="preload";ae.as="style";ae.onload=function(){this.onload=null,this.rel="stylesheet"};document.head?.appendChild(ae);var Ui=new ee,H=new J(Q,re),Yi=new J(Q,re),F=new ie(Q,re,H),At=new se(F);H.setApiManager(At);var Dt=JSON.parse(GM_getValue("bmTemplates","{}"));console.log(Dt);F.importJSON(Dt);var qe=JSON.parse(GM_getValue("bmUserSettings","{}"));console.log(qe);console.log(Object.keys(qe).length);if(Object.keys(qe).length==0){let o=crypto.randomUUID();console.log(o),GM.setValue("bmUserSettings",JSON.stringify({uuid:o}))}setInterval(()=>{let o=JSON.parse(GM_getValue("bmUserPixels","{}"));Object.keys(o).length!=0&&H.updateInnerHTML("bm-user-reload","\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0437\u0430\u0440\u044F\u0434\u043E\u0432 \u0447\u0435\u0440\u0435\u0437: <b>"+Math.ceil(o.cooldownMs*(o.max-o.count)/1e3)+"</b> \u043C\u0438\u043D ")},1e4);pi();H.handleDrag("#bm-overlay","#bm-bar-drag");At.spontaneousResponseListener(H);mi();Xe(`%c${Q}%c (${re}) userscript has loaded!`,"color: cornflowerblue;","");function mi(){new MutationObserver((e,t)=>{let i=document.querySelector("#color-1");if(!i)return;let s=document.querySelector("#bm-button-move");s||(s=document.createElement("button"),s.id="bm-button-move",s.textContent="Move \u2191",s.className="btn btn-soft",s.onclick=function(){let r=this.parentNode.parentNode.parentNode.parentNode,a=this.textContent=="Move \u2191";r.parentNode.className=r.parentNode.className.replace(a?"bottom":"top",a?"top":"bottom"),r.style.borderTopLeftRadius=a?"0px":"var(--radius-box)",r.style.borderTopRightRadius=a?"0px":"var(--radius-box)",r.style.borderBottomLeftRadius=a?"var(--radius-box)":"0px",r.style.borderBottomRightRadius=a?"var(--radius-box)":"0px",this.textContent=a?"Move \u2193":"Move \u2191"},i.parentNode.parentNode.parentNode.parentNode.querySelector("h2").parentNode?.appendChild(s))}).observe(document.body,{childList:!0,subtree:!0})}function pi(){let o=!1,e={};try{e=JSON.parse(GM_getValue("bmCoords","{}"))||{}}catch{e={}}let t=async s=>{let r=await(await fetch(`${Ke}/data.json`)).json();GM.setValue("bmOptions",JSON.stringify(r)),H.handleSelectorStatus(r.images),i(s),H.handleDisplayStatus("\u0421\u043A\u0430\u0447\u0438\u0432\u0430\u0435\u043C \u0448\u0430\u0431\u043B\u043E\u043D! \u041E\u0436\u0438\u0434\u0430\u0439\u0442\u0435...")},i=async s=>{let n=JSON.parse(s.value);console.log("selected_template",n);let a=await(await fetch(`${Ke}${n.path}`)).blob(),l=n.name;F.createTemplate(a,n.id,l,[n.coords.tx,n.coords.ty,n.coords.px,n.coords.py]),H.handleDisplayStatus(`\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0448\u0430\u0431\u043B\u043E\u043D "${l}"! \u041E\u0436\u0438\u0434\u0430\u0439\u0442\u0435...`)};H.addDiv({id:"bm-overlay",style:"top: 10px; right: 75px;"}).addDiv({id:"bm-contain-header"}).addDiv({id:"bm-bar-drag"}).buildElement().addImg({alt:"Blue Marble Icon - Click to minimize/maximize",src:"https://freakland.egorrko.ru/favicon/favicon-96x96.png",style:"cursor: pointer;"},(s,n)=>{n.addEventListener("click",()=>{o=!o;let r=document.querySelector("#bm-overlay"),a=document.querySelector("#bm-contain-header"),l=document.querySelector("#bm-bar-drag"),c=document.querySelector("#bm-contain-coords"),h=document.querySelector("#bm-button-coords"),p=document.querySelector("#bm-button-create"),d=document.querySelector("#bm-button-enable"),g=document.querySelector("#bm-button-disable"),f=document.querySelectorAll("#bm-contain-coords input");o||(r.style.width="auto",r.style.maxWidth="300px",r.style.minWidth="200px",r.style.padding="10px"),["#bm-overlay h1","#bm-contain-userinfo","#bm-overlay hr","#bm-contain-automation > *:not(#bm-contain-coords)","#bm-input-file-template","#bm-contain-buttons-action",`#${s.outputStatusId}`,"#bm-contain-colorfilter"].forEach(m=>{document.querySelectorAll(m).forEach(y=>{y.style.display=o?"none":""})}),o?(c&&(c.style.display="none"),h&&(h.style.display="none"),p&&(p.style.display="none"),d&&(d.style.display="none"),g&&(g.style.display="none"),f.forEach(m=>{m.style.display="none"}),r.style.width="60px",r.style.height="76px",r.style.maxWidth="60px",r.style.minWidth="60px",r.style.padding="8px",n.style.marginLeft="3px",a.style.textAlign="center",a.style.margin="0",a.style.marginBottom="0",l&&(l.style.display="",l.style.marginBottom="0.25em")):(c&&(c.style.display="",c.style.flexDirection="",c.style.justifyContent="",c.style.alignItems="",c.style.gap="",c.style.textAlign="",c.style.margin=""),h&&(h.style.display=""),p&&(p.style.display="",p.style.marginTop=""),d&&(d.style.display="",d.style.marginTop=""),g&&(g.style.display="",g.style.marginTop=""),f.forEach(m=>{m.style.display=""}),n.style.marginLeft="",r.style.padding="10px",a.style.textAlign="",a.style.margin="",a.style.marginBottom="",l&&(l.style.marginBottom="0.5em"),r.style.width="",r.style.height=""),n.alt=o?"Blue Marble Icon - Minimized (Click to maximize)":"Blue Marble Icon - Maximized (Click to minimize)"})}).buildElement().addHeader(1,{textContent:Q}).buildElement().buildElement().addHr().buildElement().addDiv({id:"bm-contain-userinfo"}).addP({id:"bm-user-name",textContent:"\u042E\u0437\u0435\u0440\u043D\u0435\u0439\u043C:"}).buildElement().addP({id:"bm-user-droplets",textContent:"\u041A\u0430\u043F\u0435\u043B\u044C:"}).buildElement().addP({id:"bm-user-nextlevel",textContent:"\u0421\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0439 \u0443\u0440\u043E\u0432\u0435\u043D\u044C \u0447\u0435\u0440\u0435\u0437:"}).buildElement().addP({id:"bm-user-reload",textContent:""}).buildElement().addP({id:"bm-user-online",textContent:""}).buildElement().buildElement().addHr().buildElement().addDiv({id:"bm-contain-automation"}).addButton({id:"bm-button-create",textContent:"\u041E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0448\u0430\u0431\u043B\u043E\u043D\u044B"},(s,n)=>{n.onclick=async()=>{let a=await(await fetch(`${Ke}/data.json`)).json();GM.setValue("bmOptions",JSON.stringify(a)),s.handleSelectorStatus(a.images),s.handleDisplayStatus("\u0421\u043A\u0430\u0447\u0438\u0432\u0430\u0435\u043C \u0448\u0430\u0431\u043B\u043E\u043D! \u041E\u0436\u0438\u0434\u0430\u0439\u0442\u0435...")}}).buildElement().addDiv({id:"bm-contain-selector-templates",style:"margin-top: 10px;"}).addSelector({id:"bm-selector-templates"},async(s,n)=>{console.log("selector",n),await t(n);let r=new Se(n,{shouldSort:!1,searchEnabled:!1,itemSelectText:""});n.addEventListener("change",async a=>{i(n)})}).buildElement().buildElement().addDiv({id:"bm-contain-colorfilter",style:"max-height: 140px; overflow: auto; border: 1px solid rgba(255,255,255,0.1); padding: 4px; border-radius: 4px; display: none;"}).addDiv({style:"display: flex; gap: 6px; margin-bottom: 6px;"}).addButton({id:"bm-button-colors-enable-all",textContent:"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432\u0441\u0435 \u0446\u0432\u0435\u0442\u0430"},(s,n)=>{n.onclick=()=>{let r=F.templatesArray[0];r?.colorPalette&&(Object.values(r.colorPalette).forEach(a=>a.enabled=!0),buildColorFilterList(),s.handleDisplayStatus("\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432\u0441\u0435 \u0446\u0432\u0435\u0442\u0430"))}}).buildElement().addButton({id:"bm-button-colors-disable-all",textContent:"\u0412\u044B\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432\u0441\u0435 \u0446\u0432\u0435\u0442\u0430"},(s,n)=>{n.onclick=()=>{let r=F.templatesArray[0];r?.colorPalette&&(Object.values(r.colorPalette).forEach(a=>a.enabled=!1),buildColorFilterList(),s.handleDisplayStatus("\u0412\u044B\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432\u0441\u0435 \u0446\u0432\u0435\u0442\u0430"))}}).buildElement().buildElement().addDiv({id:"bm-colorfilter-list"}).buildElement().buildElement().addDiv({id:"bm-contain-buttons-template"}).addButton({id:"bm-button-enable",textContent:"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C"},(s,n)=>{n.onclick=()=>{s.apiManager?.templateManager?.setTemplatesShouldBeDrawn(!0),s.handleDisplayStatus("\u0412\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u0448\u0430\u0431\u043B\u043E\u043D\u0430! \u041E\u0436\u0438\u0434\u0430\u0439\u0442\u0435...")}}).buildElement().addButton({id:"bm-button-disable",textContent:"\u0412\u044B\u043A\u043B\u044E\u0447\u0438\u0442\u044C"},(s,n)=>{n.onclick=()=>{s.apiManager?.templateManager?.setTemplatesShouldBeDrawn(!1),s.handleDisplayStatus("\u0412\u044B\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u0448\u0430\u0431\u043B\u043E\u043D\u0430! \u041E\u0436\u0438\u0434\u0430\u0439\u0442\u0435...")}}).buildElement().buildElement().addTextarea({id:H.outputStatusId,placeholder:`\u0421\u0442\u0430\u0442\u0443\u0441: \u0421\u043F\u0438\u0442...
\u0412\u0435\u0440\u0441\u0438\u044F: ${re}`,readOnly:!0}).buildElement().addDiv({id:"bm-contain-buttons-action"}).addDiv().addHyperLink({href:"https://t.me/YrodstvoDesinova",target:"_blank",textContent:"\u0413\u0435\u043D\u0435\u0440\u0430\u043B: @MishaDesinov",style:"font-size: 12px;"}).buildElement().addDiv().addHyperLink({href:"https://freakland.egorrko.ru",target:"_blank",textContent:"\u0420\u0430\u0437\u0440\u0430\u0431\u043E\u0442\u0447\u0438\u043A: @Egorrko",style:"font-size: 12px;"}).buildElement().buildElement().buildElement().buildOverlay(document.body),window.buildColorFilterList=function(){let n=document.querySelector("#bm-colorfilter-list"),r=F.templatesArray?.[0];if(!n||!r?.colorPalette){n&&(n.innerHTML="<small>No template colors to display.</small>");return}n.innerHTML="";let a=Object.entries(r.colorPalette).sort((l,c)=>c[1].count-l[1].count);for(let[l,c]of a){let h=document.createElement("div");h.style.display="flex",h.style.alignItems="center",h.style.gap="8px",h.style.margin="4px 0";let p=document.createElement("div");p.style.width="14px",p.style.height="14px",p.style.border="1px solid rgba(255,255,255,0.5)";let d=document.createElement("span");d.style.fontSize="12px";let g=`${c.count.toLocaleString()}`;if(l==="other")p.style.background="#888",g=`Other \u2022 ${g}`;else if(l==="#deface")p.style.background="#deface",g=`Transparent \u2022 ${g}`;else{let[u,m,b]=l.split(",").map(Number);p.style.background=`rgb(${u},${m},${b})`;try{let y=F.templatesArray?.[0]?.rgbToMeta?.get(l);if(y&&typeof y.id=="number"){let v=y?.name||`rgb(${u},${m},${b})`,w=y.premium?"\u2605 ":"";g=`#${y.id} ${w}${v} \u2022 ${g}`}}catch{}}d.textContent=g;let f=document.createElement("input");f.type="checkbox",f.checked=!!c.enabled,f.addEventListener("change",()=>{c.enabled=f.checked,H.handleDisplayStatus(`${f.checked?"Enabled":"Disabled"} ${l}`);try{let u=F.templatesArray?.[0],m=u?.storageKey;u&&m&&F.templatesJSON?.templates?.[m]&&(F.templatesJSON.templates[m].palette=u.colorPalette,GM.setValue("bmTemplates",JSON.stringify(F.templatesJSON)))}catch{}}),h.appendChild(f),h.appendChild(p),h.appendChild(d),n.appendChild(h)}},window.addEventListener("message",s=>{if(s?.data?.bmEvent==="bm-rebuild-color-list")try{buildColorFilterList()}catch{}}),setTimeout(()=>{try{if(F.templatesArray?.length>0){let s=document.querySelector("#bm-contain-colorfilter");s&&(s.style.display=""),buildColorFilterList()}}catch{}},0)}})();
