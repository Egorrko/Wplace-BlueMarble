// ==UserScript==
// @name         Freakland
// @namespace    https://github.com/Egorrko/Wplace-Freakland
// @version      0.86.0
// @icon         https://raw.githubusercontent.com/Egorrko/Wplace-Freakland/refs/heads/main/favicon.png
// @match        https://wplace.live/*
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @grant        GM.setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @connect      freakland.egorrko.ru
// @connect      localhost
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/
(()=>{var Ve=n=>{throw TypeError(n)};var kt=(n,e,t)=>e.has(n)||Ve("Cannot "+t);var Y=(n,e,t)=>e.has(n)?Ve("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t);var O=(n,e,t)=>(kt(n,e,"access private method"),t);var D,N,z=class{constructor(e,t){Y(this,D);this.name=e,this.version=t,this.apiManager=null,this.outputStatusId="bm-output-status",this.overlay=null,this.currentParent=null,this.parentStack=[]}setApiManager(e){this.apiManager=e}buildElement(){return this.parentStack.length>0&&(this.currentParent=this.parentStack.pop()),this}buildOverlay(e){e?.appendChild(this.overlay),this.overlay=null,this.currentParent=null,this.parentStack=[]}addDiv(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"div",i,e);return t(this,s),this}addP(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"p",i,e);return t(this,s),this}addSmall(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"small",i,e);return t(this,s),this}addHyperLink(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"a",i,e);return t(this,s),this}addImg(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"img",i,e);return t(this,s),this}addHeader(e,t={},i=()=>{}){let s={},r=O(this,D,N).call(this,"h"+e,s,t);return i(this,r),this}addHr(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"hr",i,e);return t(this,s),this}addBr(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"br",i,e);return t(this,s),this}addCheckbox(e={},t=()=>{}){let i={type:"checkbox"},s=O(this,D,N).call(this,"label",{textContent:e.textContent??""});delete e.textContent;let r=O(this,D,N).call(this,"input",i,e);return s.insertBefore(r,s.firstChild),this.buildElement(),t(this,s,r),this}addButton(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"button",i,e);return t(this,s),this}addButtonHelp(e={},t=()=>{}){let i=e.title??e.textContent??"Help: No info";delete e.textContent,e.title=`Help: ${i}`;let s={textContent:"?",className:"bm-help",onclick:()=>{this.updateInnerHTML(this.outputStatusId,i)}},r=O(this,D,N).call(this,"button",s,e);return t(this,r),this}addInput(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"input",i,e);return t(this,s),this}addSelector(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"select",i,e);return t(this,s),this}addInputFile(e={},t=()=>{}){let i={type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},s=e.textContent??"";delete e.textContent;let r=O(this,D,N).call(this,"div"),o=O(this,D,N).call(this,"input",i,e);this.buildElement();let a=O(this,D,N).call(this,"button",{textContent:s});return this.buildElement(),this.buildElement(),o.setAttribute("tabindex","-1"),o.setAttribute("aria-hidden","true"),a.addEventListener("click",()=>{o.click()}),o.addEventListener("change",()=>{a.style.maxWidth=`${a.offsetWidth}px`,o.files.length>0?a.textContent=o.files[0].name:a.textContent=s}),t(this,r,o,a),this}addTextarea(e={},t=()=>{}){let i={},s=O(this,D,N).call(this,"textarea",i,e);return t(this,s),this}updateInnerHTML(e,t,i=!1){let s=document.getElementById(e.replace(/^#/,""));if(s){if(s instanceof HTMLInputElement){s.value=t;return}i?s.textContent=t:s.innerHTML=t}}handleDrag(e,t){let i=!1,s,r=0,o=null,a=0,l=0,h=0,c=0;if(e=document.querySelector(e?.[0]=="#"?e:"#"+e),t=document.querySelector(t?.[0]=="#"?t:"#"+t),!e||!t){this.handleDisplayError(`Can not drag! ${e?"":"moveMe"} ${!e&&!t?"and ":""}${t?"":"iMoveThings "}was not found!`);return}let g=()=>{if(i){let d=Math.abs(a-h),u=Math.abs(l-c);(d>.5||u>.5)&&(a=h,l=c,e.style.transform=`translate(${a}px, ${l}px)`,e.style.left="0px",e.style.top="0px",e.style.right=""),o=requestAnimationFrame(g)}},p=null,m=(d,u)=>{i=!0,p=e.getBoundingClientRect(),s=d-p.left,r=u-p.top;let y=window.getComputedStyle(e).transform;if(y&&y!=="none"){let v=new DOMMatrix(y);a=v.m41,l=v.m42}else a=p.left,l=p.top;h=a,c=l,document.body.style.userSelect="none",t.classList.add("dragging"),o&&cancelAnimationFrame(o),g()},f=()=>{i=!1,o&&(cancelAnimationFrame(o),o=null),document.body.style.userSelect="",t.classList.remove("dragging")};t.addEventListener("mousedown",function(d){d.preventDefault(),m(d.clientX,d.clientY)}),t.addEventListener("touchstart",function(d){let u=d?.touches?.[0];u&&(m(u.clientX,u.clientY),d.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(d){i&&p&&(h=d.clientX-s,c=d.clientY-r)},{passive:!0}),document.addEventListener("touchmove",function(d){if(i&&p){let u=d?.touches?.[0];if(!u)return;h=u.clientX-s,c=u.clientY-r,d.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",f),document.addEventListener("touchend",f),document.addEventListener("touchcancel",f)}handleDisplayStatus(e){let t=console.info;t(`${this.name}: ${e}`),this.updateInnerHTML(this.outputStatusId,"Status: "+e,!0)}handleDisplayError(e){let t=console.error;t(`${this.name}: ${e}`),this.updateInnerHTML(this.outputStatusId,"Error: "+e,!0)}handleSelectorStatus(e){let t=document.querySelector("#bm-selector-templates");t.innerHTML="";for(let i of e){let s=document.createElement("option");s.value=JSON.stringify(i.value),s.textContent=i.label,t.appendChild(s)}}};D=new WeakSet,N=function(e,t={},i={}){let s=document.createElement(e);this.overlay?(this.currentParent?.appendChild(s),this.parentStack.push(this.currentParent),this.currentParent=s):(this.overlay=s,this.currentParent=s);for(let[r,o]of Object.entries(t))s[r]=o;for(let[r,o]of Object.entries(i))s[r]=o;return s};var ee=class{constructor(){this.observerBody=null,this.observerBodyTarget=null,this.targetDisplayCoords="#bm-display-coords"}createObserverBody(e){return this.observerBodyTarget=e,this.observerBody=new MutationObserver(t=>{for(let i of t)for(let s of i.addedNodes)s instanceof HTMLElement&&s.matches?.(this.targetDisplayCoords)}),this}getObserverBody(){return this.observerBody}observe(e,t=!1,i=!1){e.observe(this.observerBodyTarget,{childList:t,subtree:i})}};function We(n){let e=document.createElement("div");return e.textContent=n,e.innerHTML}function Ue(n,e){return[parseInt(n[0])%4*1e3+parseInt(e[0]),parseInt(n[1])%4*1e3+parseInt(e[1])]}function Ye(...n){(e=>e(...n))(console.log)}function te(...n){(e=>e(...n))(console.error)}function ze(...n){(e=>e(...n))(console.warn)}function Je(n,e){if(n===0)return e[0];let t="",i=e.length;for(;n>0;)t=e[n%i]+t,n=Math.floor(n/i);return t}function Xe(n){let e="";for(let t=0;t<n.length;t++)e+=String.fromCharCode(n[t]);return btoa(e)}function Ze(n){let e=atob(n),t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}var xe=[{id:0,premium:!1,name:"Transparent",rgb:[0,0,0]},{id:1,premium:!1,name:"Black",rgb:[0,0,0]},{id:2,premium:!1,name:"Dark Gray",rgb:[60,60,60]},{id:3,premium:!1,name:"Gray",rgb:[120,120,120]},{id:4,premium:!1,name:"Light Gray",rgb:[210,210,210]},{id:5,premium:!1,name:"White",rgb:[255,255,255]},{id:6,premium:!1,name:"Deep Red",rgb:[96,0,24]},{id:7,premium:!1,name:"Red",rgb:[237,28,36]},{id:8,premium:!1,name:"Orange",rgb:[255,127,39]},{id:9,premium:!1,name:"Gold",rgb:[246,170,9]},{id:10,premium:!1,name:"Yellow",rgb:[249,221,59]},{id:11,premium:!1,name:"Light Yellow",rgb:[255,250,188]},{id:12,premium:!1,name:"Dark Green",rgb:[14,185,104]},{id:13,premium:!1,name:"Green",rgb:[19,230,123]},{id:14,premium:!1,name:"Light Green",rgb:[135,255,94]},{id:15,premium:!1,name:"Dark Teal",rgb:[12,129,110]},{id:16,premium:!1,name:"Teal",rgb:[16,174,166]},{id:17,premium:!1,name:"Light Teal",rgb:[19,225,190]},{id:18,premium:!1,name:"Dark Blue",rgb:[40,80,158]},{id:19,premium:!1,name:"Blue",rgb:[64,147,228]},{id:20,premium:!1,name:"Cyan",rgb:[96,247,242]},{id:21,premium:!1,name:"Indigo",rgb:[107,80,246]},{id:22,premium:!1,name:"Light Indigo",rgb:[153,177,251]},{id:23,premium:!1,name:"Dark Purple",rgb:[120,12,153]},{id:24,premium:!1,name:"Purple",rgb:[170,56,185]},{id:25,premium:!1,name:"Light Purple",rgb:[224,159,249]},{id:26,premium:!1,name:"Dark Pink",rgb:[203,0,122]},{id:27,premium:!1,name:"Pink",rgb:[236,31,128]},{id:28,premium:!1,name:"Light Pink",rgb:[243,141,169]},{id:29,premium:!1,name:"Dark Brown",rgb:[104,70,52]},{id:30,premium:!1,name:"Brown",rgb:[149,104,42]},{id:31,premium:!1,name:"Beige",rgb:[248,178,119]},{id:32,premium:!0,name:"Medium Gray",rgb:[170,170,170]},{id:33,premium:!0,name:"Dark Red",rgb:[165,14,30]},{id:34,premium:!0,name:"Light Red",rgb:[250,128,114]},{id:35,premium:!0,name:"Dark Orange",rgb:[228,92,26]},{id:36,premium:!0,name:"Light Tan",rgb:[214,181,148]},{id:37,premium:!0,name:"Dark Goldenrod",rgb:[156,132,49]},{id:38,premium:!0,name:"Goldenrod",rgb:[197,173,49]},{id:39,premium:!0,name:"Light Goldenrod",rgb:[232,212,95]},{id:40,premium:!0,name:"Dark Olive",rgb:[74,107,58]},{id:41,premium:!0,name:"Olive",rgb:[90,148,74]},{id:42,premium:!0,name:"Light Olive",rgb:[132,197,115]},{id:43,premium:!0,name:"Dark Cyan",rgb:[15,121,159]},{id:44,premium:!0,name:"Light Cyan",rgb:[187,250,242]},{id:45,premium:!0,name:"Light Blue",rgb:[125,199,255]},{id:46,premium:!0,name:"Dark Indigo",rgb:[77,49,184]},{id:47,premium:!0,name:"Dark Slate Blue",rgb:[74,66,132]},{id:48,premium:!0,name:"Slate Blue",rgb:[122,113,196]},{id:49,premium:!0,name:"Light Slate Blue",rgb:[181,174,241]},{id:50,premium:!0,name:"Light Brown",rgb:[219,164,99]},{id:51,premium:!0,name:"Dark Beige",rgb:[209,128,81]},{id:52,premium:!0,name:"Light Beige",rgb:[255,197,165]},{id:53,premium:!0,name:"Dark Peach",rgb:[155,82,73]},{id:54,premium:!0,name:"Peach",rgb:[209,128,120]},{id:55,premium:!0,name:"Light Peach",rgb:[250,182,164]},{id:56,premium:!0,name:"Dark Tan",rgb:[123,99,82]},{id:57,premium:!0,name:"Tan",rgb:[156,132,107]},{id:58,premium:!0,name:"Dark Slate",rgb:[51,57,65]},{id:59,premium:!0,name:"Slate",rgb:[109,117,141]},{id:60,premium:!0,name:"Light Slate",rgb:[179,185,209]},{id:61,premium:!0,name:"Dark Stone",rgb:[109,100,63]},{id:62,premium:!0,name:"Stone",rgb:[148,140,107]},{id:63,premium:!0,name:"Light Stone",rgb:[205,197,158]}];var J=class{constructor({displayName:e="My template",template_id:t=null,sortID:i=0,authorID:s="",url:r="",file:o=null,coords:a=null,chunked:l=null,tileSize:h=1e3}={}){this.displayName=e,this.template_id=t,this.sortID=i,this.authorID=s,this.url=r,this.file=o,this.coords=a,this.chunked=l,this.tileSize=h,this.pixelCount=0,this.requiredPixelCount=0,this.defacePixelCount=0,this.colorPalette={},this.tilePrefixes=new Set,this.storageKey=null;let c=Array.isArray(xe)?xe:[];this.allowedColorsSet=new Set(c.filter(m=>(m?.name||"").toLowerCase()!=="transparent"&&Array.isArray(m?.rgb)).map(m=>`${m.rgb[0]},${m.rgb[1]},${m.rgb[2]}`));let g="222,250,206";this.allowedColorsSet.add(g);let p="other";this.allowedColorsSet.add(p),this.rgbToMeta=new Map(c.filter(m=>Array.isArray(m?.rgb)).map(m=>[`${m.rgb[0]},${m.rgb[1]},${m.rgb[2]}`,{id:m.id,premium:!!m.premium,name:m.name}]));try{let m=c.find(f=>(f?.name||"").toLowerCase()==="transparent");m&&Array.isArray(m.rgb)&&this.rgbToMeta.set(g,{id:m.id,premium:!!m.premium,name:m.name})}catch{}try{this.rgbToMeta.set(p,{id:"other",premium:!1,name:"Other"})}catch{}console.log("Allowed colors for template:",this.allowedColorsSet)}async createTemplateTiles(){console.log("Template coordinates:",this.coords);let e=3,t=await createImageBitmap(this.file),i=t.width,s=t.height,r=i*s;console.log(`Template pixel analysis - Dimensions: ${i}\xD7${s} = ${r.toLocaleString()} pixels`),this.pixelCount=r;try{let g=new OffscreenCanvas(i,s).getContext("2d",{willReadFrequently:!0});g.imageSmoothingEnabled=!1,g.clearRect(0,0,i,s),g.drawImage(t,0,0);let p=g.getImageData(0,0,i,s).data,m=0,f=0,d=new Map;for(let b=0;b<s;b++)for(let y=0;y<i;y++){let v=(b*i+y)*4,w=p[v],S=p[v+1],I=p[v+2];if(p[v+3]===0)continue;w===222&&S===250&&I===206&&f++;let E=this.allowedColorsSet.has(`${w},${S},${I}`)?`${w},${S},${I}`:"other";m++,d.set(E,(d.get(E)||0)+1)}this.requiredPixelCount=m,this.defacePixelCount=f;let u={};for(let[b,y]of d.entries())u[b]={count:y,enabled:!0};this.colorPalette=u}catch(c){this.requiredPixelCount=Math.max(0,this.pixelCount),this.defacePixelCount=0,console.warn("Failed to compute required/deface counts. Falling back to total pixels.",c)}let o={},a={},l=new OffscreenCanvas(this.tileSize,this.tileSize),h=l.getContext("2d",{willReadFrequently:!0});for(let c=this.coords[3];c<s+this.coords[3];){let g=Math.min(this.tileSize-c%this.tileSize,s-(c-this.coords[3]));console.log(`Math.min(${this.tileSize} - (${c} % ${this.tileSize}), ${s} - (${c-this.coords[3]}))`);for(let p=this.coords[2];p<i+this.coords[2];){console.log(`Pixel X: ${p}
Pixel Y: ${c}`);let m=Math.min(this.tileSize-p%this.tileSize,i-(p-this.coords[2]));console.log(`Math.min(${this.tileSize} - (${p} % ${this.tileSize}), ${i} - (${p-this.coords[2]}))`),console.log(`Draw Size X: ${m}
Draw Size Y: ${g}`);let f=m*e,d=g*e;l.width=f,l.height=d,console.log(`Draw X: ${m}
Draw Y: ${g}
Canvas Width: ${f}
Canvas Height: ${d}`),h.imageSmoothingEnabled=!1,console.log(`Getting X ${p}-${p+m}
Getting Y ${c}-${c+g}`),h.clearRect(0,0,f,d),h.drawImage(t,p-this.coords[2],c-this.coords[3],m,g,0,0,m*e,g*e);let u=h.getImageData(0,0,f,d);for(let S=0;S<d;S++)for(let I=0;I<f;I++){let x=(S*f+I)*4;if(u.data[x]===222&&u.data[x+1]===250&&u.data[x+2]===206)(I+S)%2===0?(u.data[x]=0,u.data[x+1]=0,u.data[x+2]=0):(u.data[x]=255,u.data[x+1]=255,u.data[x+2]=255),u.data[x+3]=32;else if(I%e!==1||S%e!==1)u.data[x+3]=0;else{let E=u.data[x],C=u.data[x+1],M=u.data[x+2];this.allowedColorsSet.has(`${E},${C},${M}`)}}console.log(`Shreaded pixels for ${p}, ${c}`,u),h.putImageData(u,0,0);let b=`${(this.coords[0]+Math.floor(p/1e3)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(c/1e3)).toString().padStart(4,"0")},${(p%1e3).toString().padStart(3,"0")},${(c%1e3).toString().padStart(3,"0")}`;o[b]=await createImageBitmap(l),this.tilePrefixes.add(b.split(",").slice(0,2).join(","));let v=await(await l.convertToBlob()).arrayBuffer(),w=Array.from(new Uint8Array(v));a[b]=Xe(w),p+=m}c+=g}return console.log("Template Tiles: ",o),console.log("Template Tiles Buffers: ",a),{templateTiles:o,templateTilesBuffers:a}}};var W,Bt,Qe,et,Ft,ie=class{constructor(e,t,i){Y(this,W);this.name=e,this.version=t,this.overlay=i,this.templatesVersion="1.0.0",this.userID=null,this.encodingBase="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.tileSize=1e3,this.drawMult=3,this.canvasTemplate=null,this.canvasTemplateZoomed=null,this.canvasTemplateID="bm-canvas",this.canvasMainID="div#map canvas.maplibregl-canvas",this.template=null,this.templateState="",this.templatesArray=[],this.templatesJSON=null,this.templatesShouldBeDrawn=!0,this.tileProgress=new Map}getCanvas(){if(document.body.contains(this.canvasTemplate))return this.canvasTemplate;document.getElementById(this.canvasTemplateID)?.remove();let e=document.querySelector(this.canvasMainID),t=document.createElement("canvas");return t.id=this.canvasTemplateID,t.className="maplibregl-canvas",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.height=`${e?.clientHeight*(window.devicePixelRatio||1)}px`,t.style.width=`${e?.clientWidth*(window.devicePixelRatio||1)}px`,t.height=e?.clientHeight*(window.devicePixelRatio||1),t.width=e?.clientWidth*(window.devicePixelRatio||1),t.style.zIndex="8999",t.style.pointerEvents="none",e?.parentElement?.appendChild(t),this.canvasTemplate=t,window.addEventListener("move",this.onMove),window.addEventListener("zoom",this.onZoom),window.addEventListener("resize",this.onResize),this.canvasTemplate}async createJSON(){return{whoami:this.name.replace(" ",""),scriptVersion:this.version,schemaVersion:this.templatesVersion,templates:{}}}async createTemplate(e,t,i,s){this.templatesJSON||(this.templatesJSON=await this.createJSON(),console.log("Creating JSON...")),this.overlay.handleDisplayStatus(`\u0413\u0435\u043D\u0435\u0440\u0430\u0446\u0438\u044F \u0448\u0430\u0431\u043B\u043E\u043D\u0430 \u043D\u0430 ${s.join(", ")}...`);let r=new J({displayName:i,template_id:t,sortID:0,authorID:Je(this.userID||0,this.encodingBase),file:e,coords:s}),{templateTiles:o,templateTilesBuffers:a}=await r.createTemplateTiles(this.tileSize);r.chunked=o;let l=`${r.sortID} ${r.authorID}`;r.storageKey=l,this.templatesJSON.templates[l]={name:r.displayName,template_id:t,coords:s.join(", "),enabled:!0,tiles:a,palette:r.colorPalette},this.templatesArray=[],this.tileProgress.clear(),this.templatesArray.push(r);let h=new Intl.NumberFormat().format(r.pixelCount);this.overlay.handleDisplayStatus(`\u0413\u0435\u043D\u0435\u0440\u0430\u0446\u0438\u044F \u0448\u0430\u0431\u043B\u043E\u043D\u0430 \u043D\u0430 ${s.join(", ")}! \u041E\u0431\u0449\u0435\u0435 \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u043F\u0438\u043A\u0441\u0435\u043B\u0435\u0439: ${h}`);try{let c=document.querySelector("#bm-contain-colorfilter");c&&(c.style.display=""),window.postMessage({source:"blue-marble",bmEvent:"bm-rebuild-color-list"},"*")}catch{}await O(this,W,Qe).call(this)}deleteTemplate(){}async disableTemplate(){this.templatesJSON||(this.templatesJSON=await this.createJSON(),console.log("Creating JSON..."))}async drawTemplateOnTile(e,t){if(!this.templatesShouldBeDrawn)return e;let i=this.tileSize*this.drawMult;t=t[0].toString().padStart(4,"0")+","+t[1].toString().padStart(4,"0"),console.log(`Searching for templates in tile: "${t}"`);let s=this.templatesArray;if(s.sort((d,u)=>d.sortID-u.sortID),!s.some(d=>d?.chunked?d.tilePrefixes&&d.tilePrefixes.size>0?d.tilePrefixes.has(t):Object.keys(d.chunked).some(u=>u.startsWith(t)):!1))return e;let o=s.map(d=>{let u=Object.keys(d.chunked).filter(y=>y.startsWith(t));return u.length===0?null:u.map(y=>{let v=y.split(",");return{bitmap:d.chunked[y],tileCoords:[v[0],v[1]],pixelCoords:[v[2],v[3]]}})?.[0]}).filter(Boolean),a=o?.length||0,l=0,h=0,c=0,g=await createImageBitmap(e),p=new OffscreenCanvas(i,i),m=p.getContext("2d");m.imageSmoothingEnabled=!1,m.beginPath(),m.rect(0,0,i,i),m.clip(),m.clearRect(0,0,i,i),m.drawImage(g,0,0,i,i);let f=null;try{f=m.getImageData(0,0,i,i).data}catch{}for(let d of o){if(f)try{let u=d.bitmap.width,b=d.bitmap.height,v=new OffscreenCanvas(u,b).getContext("2d",{willReadFrequently:!0});v.imageSmoothingEnabled=!1,v.clearRect(0,0,u,b),v.drawImage(d.bitmap,0,0);let S=v.getImageData(0,0,u,b).data,I=Number(d.pixelCoords[0])*this.drawMult,x=Number(d.pixelCoords[1])*this.drawMult;for(let E=0;E<b;E++)for(let C=0;C<u;C++){if(C%this.drawMult!==1||E%this.drawMult!==1)continue;let M=C+I,T=E+x;if(M<0||T<0||M>=i||T>=i)continue;let A=(E*u+C)*4,L=S[A],P=S[A+1],F=S[A+2];if(S[A+3]<64){try{let ce=this.templatesArray?.[0],he=(T*i+M)*4,Ge=f[he],Ke=f[he+1],qe=f[he+2],Nt=f[he+3],Pt=ce.allowedColorsSet.has(`${Ge},${Ke},${qe}`)?`${Ge},${Ke},${qe}`:"other",$t=ce?.allowedColorsSet?ce.allowedColorsSet.has(Pt):!1;Nt>=64&&$t&&h++}catch{}continue}c++;let K=(T*i+M)*4,we=f[K],At=f[K+1],Dt=f[K+2];f[K+3]<64||(we===L&&At===P&&Dt===F?l++:h++)}}catch(u){console.warn("Failed to compute per-tile painted/wrong stats:",u)}try{let u=this.templatesArray?.[0],b=u?.colorPalette||{};if(!Object.values(b).some(v=>v?.enabled===!1))m.drawImage(d.bitmap,Number(d.pixelCoords[0])*this.drawMult,Number(d.pixelCoords[1])*this.drawMult);else{console.log("Applying color filter...");let v=d.bitmap.width,w=d.bitmap.height,S=new OffscreenCanvas(v,w),I=S.getContext("2d",{willReadFrequently:!0});I.imageSmoothingEnabled=!1,I.clearRect(0,0,v,w),I.drawImage(d.bitmap,0,0);let x=I.getImageData(0,0,v,w),E=x.data;for(let C=0;C<w;C++)for(let M=0;M<v;M++){if(M%this.drawMult!==1||C%this.drawMult!==1)continue;let T=(C*v+M)*4,A=E[T],L=E[T+1],P=E[T+2];if(E[T+3]<1)continue;let le=u.allowedColorsSet.has(`${A},${L},${P}`)?`${A},${L},${P}`:"other",K=u?.allowedColorsSet?u.allowedColorsSet.has(le):!0,we=b?.[le]?.enabled!==!1;(!K||!we)&&(E[T+3]=0)}I.putImageData(x,0,0),m.drawImage(S,Number(d.pixelCoords[0])*this.drawMult,Number(d.pixelCoords[1])*this.drawMult)}}catch(u){console.warn("Failed to apply color filter:",u),m.drawImage(d.bitmap,Number(d.pixelCoords[0])*this.drawMult,Number(d.pixelCoords[1])*this.drawMult)}}if(a>0){let d=t;this.tileProgress.set(d,{painted:l,required:c,wrong:h});let u=0,b=0,y=0;for(let E of this.tileProgress.values())u+=E.painted||0,b+=E.required||0,y+=E.wrong||0;let v=this.templatesArray.reduce((E,C)=>E+(C.requiredPixelCount||C.pixelCount||0),0),w=v>0?v:b,S=new Intl.NumberFormat().format(u),I=new Intl.NumberFormat().format(w),x=new Intl.NumberFormat().format(w-u);this.overlay.handleDisplayStatus(`\u041E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 ${a} \u0448\u0430\u0431\u043B\u043E\u043D\u0430${a==1?"":"\u043E\u0432"}.
\u041D\u0430\u0440\u0438\u0441\u043E\u0432\u0430\u043D\u043E ${S} / ${I} \u2022 \u041D\u0435\u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u043E ${x}`)}else this.overlay.handleDisplayStatus(`\u041E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 ${a} \u0448\u0430\u0431\u043B\u043E\u043D\u0430${a==1?"":"\u043E\u0432"}.`);return await p.convertToBlob({type:"image/png"})}importJSON(e){e?.whoami=="BlueMarble"&&O(this,W,et).call(this,e)}setTemplatesShouldBeDrawn(e){this.templatesShouldBeDrawn=e}};W=new WeakSet,Bt=function(){},Qe=async function(){GM.setValue("bmTemplates",JSON.stringify(this.templatesJSON))},et=async function(e){console.log("Parsing BlueMarble...");let t=e.templates;if(console.log(`BlueMarble length: ${Object.keys(t).length}`),Object.keys(t).length>0){for(let i in t){let s=i,r=t[i];if(t.hasOwnProperty(i)){let o=s.split(" "),a=Number(o?.[0]),l=o?.[1]||"0",h=r.name||`Template ${a||""}`,c=r.tiles,g={},p=0,m=new Map;for(let u in c)if(c.hasOwnProperty(u)){let b=c[u],y=Ze(b),v=new Blob([y],{type:"image/png"}),w=await createImageBitmap(v);g[u]=w;try{let S=w.width,I=w.height,E=new OffscreenCanvas(S,I).getContext("2d",{willReadFrequently:!0});E.imageSmoothingEnabled=!1,E.clearRect(0,0,S,I),E.drawImage(w,0,0);let C=E.getImageData(0,0,S,I).data;for(let M=0;M<I;M++)for(let T=0;T<S;T++){if(T%this.drawMult!==1||M%this.drawMult!==1)continue;let A=(M*S+T)*4,L=C[A],P=C[A+1],F=C[A+2];if(C[A+3]<64||L===222&&P===250&&F===206)continue;p++;let K=activeTemplate.allowedColorsSet.has(`${L},${P},${F}`)?`${L},${P},${F}`:"other";m.set(K,(m.get(K)||0)+1)}}catch(S){console.warn("Failed to count required pixels for imported tile",S)}}let f=new J({displayName:h,sortID:a||this.templatesArray?.length||0,authorID:l||""});f.chunked=g,f.requiredPixelCount=p;let d={};for(let[u,b]of m.entries())d[u]={count:b,enabled:!0};f.colorPalette=d;try{Object.keys(g).forEach(u=>{f.tilePrefixes?.add(u.split(",").slice(0,2).join(","))})}catch{}try{let u=t?.[s]?.palette;if(u)for(let[b,y]of Object.entries(u))f.colorPalette[b]?f.colorPalette[b].enabled=!!y?.enabled:f.colorPalette[b]={count:y?.count||0,enabled:!!y?.enabled}}catch{}f.storageKey=s,this.templatesArray.push(f)}}try{let i=document.querySelector("#bm-contain-colorfilter");i&&(i.style.display=""),window.postMessage({source:"blue-marble",bmEvent:"bm-rebuild-color-list"},"*")}catch{}}},Ft=function(){};var X,tt,it,se=class{constructor(e){Y(this,X);this.templateManager=e,this.disableAll=!1,this.coordsTilePixel=[],this.templateCoordsTilePixel=[]}spontaneousResponseListener(e){window.addEventListener("message",async t=>{let i=t.data,s=i.jsonData;if(!(i&&i.source==="blue-marble")||!i.endpoint)return;let r=i.endpoint?.split("?")[0].split("/").filter(o=>o&&isNaN(Number(o))).filter(o=>o&&!o.includes(".")).pop();switch(console.log('%cBlue Marble%c: Recieved message about "%s"',"color: cornflowerblue;","",r),r){case"me":if(s.status&&s.status?.toString()[0]!="2"){e.handleDisplayError(`You are not logged in!
Could not fetch userdata.`);return}let o=Math.ceil(Math.pow(Math.floor(s.level)*Math.pow(30,.65),1/.65)-s.pixelsPainted);s.id||s.id,this.templateManager.userID=s.id,e.updateInnerHTML("bm-user-name",`\u042E\u0437\u0435\u0440\u043D\u0435\u0439\u043C: <b>${We(s.name)}</b>`),e.updateInnerHTML("bm-user-droplets",`\u041A\u0430\u043F\u0435\u043B\u044C: <b>${new Intl.NumberFormat().format(s.droplets)}</b>`),e.updateInnerHTML("bm-user-nextlevel",`\u0421\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0439 \u0443\u0440\u043E\u0432\u0435\u043D\u044C \u0447\u0435\u0440\u0435\u0437: <b>${new Intl.NumberFormat().format(o)}</b> \u043F\u0438\u043A\u0441\u0435\u043B${o==1?"\u044C":"\u0435\u0439"}`),GM.setValue("bmUserPixels",JSON.stringify({count:s.charges.count,max:s.charges.max,cooldownMs:s.charges.cooldownMs,updated:Date.now()})),this.sendOnlineStatus(e,s);break;case"pixel":let a=i.endpoint.split("?")[0].split("/").filter(u=>u&&!isNaN(Number(u))),l=new URLSearchParams(i.endpoint.split("?")[1]),h=[l.get("x"),l.get("y")];if(this.coordsTilePixel.length&&(!a.length||!h.length)){e.handleDisplayError(`Coordinates are malformed!
Did you try clicking the canvas first?`);return}this.coordsTilePixel=[...a,...h];let c=Ue(a,h),g=document.querySelectorAll("span");for(let u of g)if(u.textContent.trim().includes(`${c[0]}, ${c[1]}`)){let b=document.querySelector("#bm-display-coords"),y=`(Tl X: ${a[0]}, Tl Y: ${a[1]}, Px X: ${h[0]}, Px Y: ${h[1]})`;b?b.textContent=y:(b=document.createElement("span"),b.id="bm-display-coords",b.textContent=y,b.style="margin-left: calc(var(--spacing)*3); font-size: small;",u.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",b))}break;case"tiles":let p=i.endpoint.split("/");p=[parseInt(p[p.length-2]),parseInt(p[p.length-1].replace(".png",""))];let m=i.blobID,f=i.blobData,d=await this.templateManager.drawTemplateOnTile(f,p);window.postMessage({source:"blue-marble",blobID:m,blobData:d,blink:i.blink});break;case"robots":this.disableAll=s.userscript?.toString().toLowerCase()=="false";break}})}async sendOnlineStatus(e,t){let s=JSON.parse(GM_getValue("bmUserSettings","{}")).uuid,r=JSON.stringify({count:Math.floor(t.charges.count),max:Math.floor(t.charges.max),uuid:s,template_id:this.templateManager.templatesArray[0].template_id});GM_xmlhttpRequest({method:"POST",url:`${de}/wplace-api/online`,headers:{"Content-Type":"application/json"},data:r,onload:o=>{o.status!==200&&te("Failed to send online status:",o.statusText)},onerror:o=>{te("Error sending online status:",o)}})}async sendHeartbeat(e){console.log("Sending heartbeat to telemetry server...");let t=GM_getValue("bmUserSettings","{}");if(t=JSON.parse(t),!t||!t.telemetry||!t.uuid){console.log("Telemetry is disabled, not sending heartbeat.");return}let i=navigator.userAgent,s=await O(this,X,tt).call(this,i),r=O(this,X,it).call(this,i);GM_xmlhttpRequest({method:"POST",url:`${de}/heartbeat`,headers:{"Content-Type":"application/json"},data:JSON.stringify({uuid:t.uuid,version:e,browser:s,os:r}),onload:o=>{o.status!==200&&te("Failed to send heartbeat:",o.statusText)},onerror:o=>{te("Error sending heartbeat:",o)}})}};X=new WeakSet,tt=async function(e=navigator.userAgent){return e=e||"",e.includes("OPR/")||e.includes("Opera")?"Opera":e.includes("Edg/")?"Edge":e.includes("Vivaldi")?"Vivaldi":e.includes("YaBrowser")?"Yandex":e.includes("Kiwi")?"Kiwi":e.includes("Brave")?"Brave":e.includes("Firefox/")?"Firefox":e.includes("Chrome/")?"Chrome":e.includes("Safari/")?"Safari":navigator.brave&&typeof navigator.brave.isBrave=="function"&&await navigator.brave.isBrave()?"Brave":"Unknown"},it=function(e=navigator.userAgent){return e=e||"",/Windows NT 11/i.test(e)?"Windows 11":/Windows NT 10/i.test(e)?"Windows 10":/Windows NT 6\.3/i.test(e)?"Windows 8.1":/Windows NT 6\.2/i.test(e)?"Windows 8":/Windows NT 6\.1/i.test(e)?"Windows 7":/Windows NT 6\.0/i.test(e)?"Windows Vista":/Windows NT 5\.1|Windows XP/i.test(e)?"Windows XP":/Mac OS X 10[_\.]15/i.test(e)?"macOS Catalina":/Mac OS X 10[_\.]14/i.test(e)?"macOS Mojave":/Mac OS X 10[_\.]13/i.test(e)?"macOS High Sierra":/Mac OS X 10[_\.]12/i.test(e)?"macOS Sierra":/Mac OS X 10[_\.]11/i.test(e)?"OS X El Capitan":/Mac OS X 10[_\.]10/i.test(e)?"OS X Yosemite":/Mac OS X 10[_\.]/i.test(e)?"macOS":/Android/i.test(e)?"Android":/iPhone|iPad|iPod/i.test(e)?"iOS":/Linux/i.test(e)?"Linux":"Unknown"};var Rt=function(n){return function(e){return!!e&&typeof e=="object"}(n)&&!function(e){var t=Object.prototype.toString.call(e);return t==="[object RegExp]"||t==="[object Date]"||function(i){return i.$$typeof===Ht}(e)}(n)},Ht=typeof Symbol=="function"&&Symbol.for?Symbol.for("react.element"):60103;function ne(n,e){return e.clone!==!1&&e.isMergeableObject(n)?Z((t=n,Array.isArray(t)?[]:{}),n,e):n;var t}function jt(n,e,t){return n.concat(e).map(function(i){return ne(i,t)})}function st(n){return Object.keys(n).concat(function(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter(function(t){return e.propertyIsEnumerable(t)}):[]}(n))}function nt(n,e){try{return e in n}catch{return!1}}function Gt(n,e,t){var i={};return t.isMergeableObject(n)&&st(n).forEach(function(s){i[s]=ne(n[s],t)}),st(e).forEach(function(s){(function(r,o){return nt(r,o)&&!(Object.hasOwnProperty.call(r,o)&&Object.propertyIsEnumerable.call(r,o))})(n,s)||(nt(n,s)&&t.isMergeableObject(e[s])?i[s]=function(r,o){if(!o.customMerge)return Z;var a=o.customMerge(r);return typeof a=="function"?a:Z}(s,t)(n[s],e[s],t):i[s]=ne(e[s],t))}),i}function Z(n,e,t){(t=t||{}).arrayMerge=t.arrayMerge||jt,t.isMergeableObject=t.isMergeableObject||Rt,t.cloneUnlessOtherwiseSpecified=ne;var i=Array.isArray(e);return i===Array.isArray(n)?i?t.arrayMerge(n,e,t):Gt(n,e,t):ne(e,t)}Z.all=function(n,e){if(!Array.isArray(n))throw new Error("first argument should be an array");return n.reduce(function(t,i){return Z(t,i,e)},{})};var rt=Z;function V(n){return Array.isArray?Array.isArray(n):St(n)==="[object Array]"}function q(n){return typeof n=="string"}function _t(n){return typeof n=="number"}function Kt(n){return n===!0||n===!1||function(e){return Et(e)&&e!==null}(n)&&St(n)=="[object Boolean]"}function Et(n){return typeof n=="object"}function k(n){return n!=null}function Ce(n){return!n.trim().length}function St(n){return n==null?n===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(n)}var ot=Object.prototype.hasOwnProperty,Me=class{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach(i=>{let s=wt(i);t+=s.weight,this._keys.push(s),this._keyMap[s.id]=s,t+=s.weight}),this._keys.forEach(i=>{i.weight/=t})}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}};function wt(n){let e=null,t=null,i=null,s=1;if(q(n)||V(n))i=n,e=at(n),t=Ae(n);else{if(!ot.call(n,"name"))throw new Error((o=>`Missing ${o} property in key`)("name"));let r=n.name;if(i=r,ot.call(n,"weight")&&(s=n.weight,s<=0))throw new Error((o=>`Property 'weight' in key '${o}' must be a positive integer`)(r));e=at(r),t=Ae(r)}return{path:e,id:t,weight:s,src:i}}function at(n){return V(n)?n:n.split(".")}function Ae(n){return V(n)?n.join("."):n}var _={isCaseSensitive:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(n,e)=>n.score===e.score?n.idx<e.idx?-1:1:n.score<e.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,useExtendedSearch:!1,getFn:function(n,e){let t=[],i=!1,s=(r,o,a)=>{if(k(r))if(o[a]){let l=r[o[a]];if(!k(l))return;if(a===o.length-1&&(q(l)||_t(l)||Kt(l)))t.push(function(h){return h==null?"":function(c){if(typeof c=="string")return c;let g=c+"";return g=="0"&&1/c==-1/0?"-0":g}(h)}(l));else if(V(l)){i=!0;for(let h=0,c=l.length;h<c;h+=1)s(l[h],o,a+1)}else o.length&&s(l,o,a+1)}else t.push(r)};return s(n,q(e)?e.split("."):e,0),i?t:t[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1},qt=/[^ ]+/g,re=class{constructor({getFn:e=_.getFn,fieldNormWeight:t=_.fieldNormWeight}={}){this.norm=function(i=1,s=3){let r=new Map,o=Math.pow(10,s);return{get(a){let l=a.match(qt).length;if(r.has(l))return r.get(l);let h=1/Math.pow(l,.5*i),c=parseFloat(Math.round(h*o)/o);return r.set(l,c),c},clear(){r.clear()}}}(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach((t,i)=>{this._keysMap[t.id]=i})}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,q(this.docs[0])?this.docs.forEach((e,t)=>{this._addString(e,t)}):this.docs.forEach((e,t)=>{this._addObject(e,t)}),this.norm.clear())}add(e){let t=this.size();q(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,i=this.size();t<i;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!k(e)||Ce(e))return;let i={v:e,i:t,n:this.norm.get(e)};this.records.push(i)}_addObject(e,t){let i={i:t,$:{}};this.keys.forEach((s,r)=>{let o=this.getFn(e,s.path);if(k(o)){if(V(o)){let a=[],l=[{nestedArrIndex:-1,value:o}];for(;l.length;){let{nestedArrIndex:h,value:c}=l.pop();if(k(c))if(q(c)&&!Ce(c)){let g={v:c,i:h,n:this.norm.get(c)};a.push(g)}else V(c)&&c.forEach((g,p)=>{l.push({nestedArrIndex:p,value:g})})}i.$[r]=a}else if(!Ce(o)){let a={v:o,n:this.norm.get(o)};i.$[r]=a}}}),this.records.push(i)}toJSON(){return{keys:this.keys,records:this.records}}};function xt(n,e,{getFn:t=_.getFn,fieldNormWeight:i=_.fieldNormWeight}={}){let s=new re({getFn:t,fieldNormWeight:i});return s.setKeys(n.map(wt)),s.setSources(e),s.create(),s}function ue(n,{errors:e=0,currentLocation:t=0,expectedLocation:i=0,distance:s=_.distance,ignoreLocation:r=_.ignoreLocation}={}){let o=e/n.length;if(r)return o;let a=Math.abs(i-t);return s?o+a/s:a?1:o}function Vt(n,e,t,{location:i=_.location,distance:s=_.distance,threshold:r=_.threshold,findAllMatches:o=_.findAllMatches,minMatchCharLength:a=_.minMatchCharLength,includeMatches:l=_.includeMatches,ignoreLocation:h=_.ignoreLocation}={}){if(e.length>32)throw new Error("Pattern length exceeds max of 32.");let c=e.length,g=n.length,p=Math.max(0,Math.min(i,g)),m=r,f=p,d=a>1||l,u=d?Array(g):[],b;for(;(b=n.indexOf(e,f))>-1;){let x=ue(e,{currentLocation:b,expectedLocation:p,distance:s,ignoreLocation:h});if(m=Math.min(x,m),f=b+c,d){let E=0;for(;E<c;)u[b+E]=1,E+=1}}f=-1;let y=[],v=1,w=c+g,S=1<<c-1;for(let x=0;x<c;x+=1){let E=0,C=w;for(;E<C;)ue(e,{errors:x,currentLocation:p+C,expectedLocation:p,distance:s,ignoreLocation:h})<=m?E=C:w=C,C=Math.floor((w-E)/2+E);w=C;let M=Math.max(1,p-C+1),T=o?g:Math.min(p+C,g)+c,A=Array(T+2);A[T+1]=(1<<x)-1;for(let L=T;L>=M;L-=1){let P=L-1,F=t[n.charAt(P)];if(d&&(u[P]=+!!F),A[L]=(A[L+1]<<1|1)&F,x&&(A[L]|=(y[L+1]|y[L])<<1|1|y[L+1]),A[L]&S&&(v=ue(e,{errors:x,currentLocation:P,expectedLocation:p,distance:s,ignoreLocation:h}),v<=m)){if(m=v,f=P,f<=p)break;M=Math.max(1,2*p-f)}}if(ue(e,{errors:x+1,currentLocation:p,expectedLocation:p,distance:s,ignoreLocation:h})>m)break;y=A}let I={isMatch:f>=0,score:Math.max(.001,v)};if(d){let x=function(E=[],C=_.minMatchCharLength){let M=[],T=-1,A=-1,L=0;for(let P=E.length;L<P;L+=1){let F=E[L];F&&T===-1?T=L:F||T===-1||(A=L-1,A-T+1>=C&&M.push([T,A]),T=-1)}return E[L-1]&&L-T>=C&&M.push([T,L-1]),M}(u,a);x.length?l&&(I.indices=x):I.isMatch=!1}return I}function Wt(n){let e={};for(let t=0,i=n.length;t<i;t+=1){let s=n.charAt(t);e[s]=(e[s]||0)|1<<i-t-1}return e}var ge=class{constructor(e,{location:t=_.location,threshold:i=_.threshold,distance:s=_.distance,includeMatches:r=_.includeMatches,findAllMatches:o=_.findAllMatches,minMatchCharLength:a=_.minMatchCharLength,isCaseSensitive:l=_.isCaseSensitive,ignoreLocation:h=_.ignoreLocation}={}){if(this.options={location:t,threshold:i,distance:s,includeMatches:r,findAllMatches:o,minMatchCharLength:a,isCaseSensitive:l,ignoreLocation:h},this.pattern=l?e:e.toLowerCase(),this.chunks=[],!this.pattern.length)return;let c=(p,m)=>{this.chunks.push({pattern:p,alphabet:Wt(p),startIndex:m})},g=this.pattern.length;if(g>32){let p=0,m=g%32,f=g-m;for(;p<f;)c(this.pattern.substr(p,32),p),p+=32;if(m){let d=g-32;c(this.pattern.substr(d),d)}}else c(this.pattern,0)}searchIn(e){let{isCaseSensitive:t,includeMatches:i}=this.options;if(t||(e=e.toLowerCase()),this.pattern===e){let f={isMatch:!0,score:0};return i&&(f.indices=[[0,e.length-1]]),f}let{location:s,distance:r,threshold:o,findAllMatches:a,minMatchCharLength:l,ignoreLocation:h}=this.options,c=[],g=0,p=!1;this.chunks.forEach(({pattern:f,alphabet:d,startIndex:u})=>{let{isMatch:b,score:y,indices:v}=Vt(e,f,d,{location:s+u,distance:r,threshold:o,findAllMatches:a,minMatchCharLength:l,includeMatches:i,ignoreLocation:h});b&&(p=!0),g+=y,b&&v&&(c=[...c,...v])});let m={isMatch:p,score:p?g/this.chunks.length:1};return p&&i&&(m.indices=c),m}},G=class{constructor(e){this.pattern=e}static isMultiMatch(e){return lt(e,this.multiRegex)}static isSingleMatch(e){return lt(e,this.singleRegex)}search(){}};function lt(n,e){let t=n.match(e);return t?t[1]:null}var fe=class extends G{constructor(e,{location:t=_.location,threshold:i=_.threshold,distance:s=_.distance,includeMatches:r=_.includeMatches,findAllMatches:o=_.findAllMatches,minMatchCharLength:a=_.minMatchCharLength,isCaseSensitive:l=_.isCaseSensitive,ignoreLocation:h=_.ignoreLocation}={}){super(e),this._bitapSearch=new ge(e,{location:t,threshold:i,distance:s,includeMatches:r,findAllMatches:o,minMatchCharLength:a,isCaseSensitive:l,ignoreLocation:h})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}},be=class extends G{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t,i=0,s=[],r=this.pattern.length;for(;(t=e.indexOf(this.pattern,i))>-1;)i=t+r,s.push([t,i-1]);let o=!!s.length;return{isMatch:o,score:o?0:1,indices:s}}},De=[class extends G{constructor(n){super(n)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(n){let e=n===this.pattern;return{isMatch:e,score:e?0:1,indices:[0,this.pattern.length-1]}}},be,class extends G{constructor(n){super(n)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(n){let e=n.startsWith(this.pattern);return{isMatch:e,score:e?0:1,indices:[0,this.pattern.length-1]}}},class extends G{constructor(n){super(n)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(n){let e=!n.startsWith(this.pattern);return{isMatch:e,score:e?0:1,indices:[0,n.length-1]}}},class extends G{constructor(n){super(n)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(n){let e=!n.endsWith(this.pattern);return{isMatch:e,score:e?0:1,indices:[0,n.length-1]}}},class extends G{constructor(n){super(n)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(n){let e=n.endsWith(this.pattern);return{isMatch:e,score:e?0:1,indices:[n.length-this.pattern.length,n.length-1]}}},class extends G{constructor(n){super(n)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(n){let e=n.indexOf(this.pattern)===-1;return{isMatch:e,score:e?0:1,indices:[0,n.length-1]}}},fe],ct=De.length,Ut=/ +(?=([^\"]*\"[^\"]*\")*[^\"]*$)/,Yt=new Set([fe.type,be.type]),Ne=class{constructor(e,{isCaseSensitive:t=_.isCaseSensitive,includeMatches:i=_.includeMatches,minMatchCharLength:s=_.minMatchCharLength,ignoreLocation:r=_.ignoreLocation,findAllMatches:o=_.findAllMatches,location:a=_.location,threshold:l=_.threshold,distance:h=_.distance}={}){this.query=null,this.options={isCaseSensitive:t,includeMatches:i,minMatchCharLength:s,findAllMatches:o,ignoreLocation:r,location:a,threshold:l,distance:h},this.pattern=t?e:e.toLowerCase(),this.query=function(c,g={}){return c.split("|").map(p=>{let m=p.trim().split(Ut).filter(d=>d&&!!d.trim()),f=[];for(let d=0,u=m.length;d<u;d+=1){let b=m[d],y=!1,v=-1;for(;!y&&++v<ct;){let w=De[v],S=w.isMultiMatch(b);S&&(f.push(new w(S,g)),y=!0)}if(!y)for(v=-1;++v<ct;){let w=De[v],S=w.isSingleMatch(b);if(S){f.push(new w(S,g));break}}}return f})}(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){let t=this.query;if(!t)return{isMatch:!1,score:1};let{includeMatches:i,isCaseSensitive:s}=this.options;e=s?e:e.toLowerCase();let r=0,o=[],a=0;for(let l=0,h=t.length;l<h;l+=1){let c=t[l];o.length=0,r=0;for(let g=0,p=c.length;g<p;g+=1){let m=c[g],{isMatch:f,indices:d,score:u}=m.search(e);if(!f){a=0,r=0,o.length=0;break}if(r+=1,a+=u,i){let b=m.constructor.type;Yt.has(b)?o=[...o,...d]:o.push(d)}}if(r){let g={isMatch:!0,score:a/r};return i&&(g.indices=o),g}}return{isMatch:!1,score:1}}},Pe=[];function $e(n,e){for(let t=0,i=Pe.length;t<i;t+=1){let s=Pe[t];if(s.condition(n,e))return new s(n,e)}return new ge(n,e)}var je="$and",zt="$or",ht="$path",Jt="$val",Ie=n=>!(!n[je]&&!n[zt]),dt=n=>({[je]:Object.keys(n).map(e=>({[e]:n[e]}))});function Ct(n,e,{auto:t=!0}={}){let i=s=>{let r=Object.keys(s),o=(l=>!!l[ht])(s);if(!o&&r.length>1&&!Ie(s))return i(dt(s));if((l=>!V(l)&&Et(l)&&!Ie(l))(s)){let l=o?s[ht]:r[0],h=o?s[Jt]:s[l];if(!q(h))throw new Error((g=>`Invalid value for key ${g}`)(l));let c={keyId:Ae(l),pattern:h};return t&&(c.searcher=$e(h,e)),c}let a={children:[],operator:r[0]};return r.forEach(l=>{let h=s[l];V(h)&&h.forEach(c=>{a.children.push(i(c))})}),a};return Ie(n)||(n=dt(n)),i(n)}function Xt(n,e){let t=n.matches;e.matches=[],k(t)&&t.forEach(i=>{if(!k(i.indices)||!i.indices.length)return;let{indices:s,value:r}=i,o={indices:s,value:r};i.key&&(o.key=i.key.src),i.idx>-1&&(o.refIndex=i.idx),e.matches.push(o)})}function Zt(n,e){e.score=n.score}var U=class{constructor(e,t={},i){this.options={..._,...t},this.options.useExtendedSearch,this._keyStore=new Me(this.options.keys),this.setCollection(e,i)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof re))throw new Error("Incorrect 'index' type");this._myIndex=t||xt(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){k(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){let t=[];for(let i=0,s=this._docs.length;i<s;i+=1){let r=this._docs[i];e(r,i)&&(this.removeAt(i),i-=1,s-=1,t.push(r))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){let{includeMatches:i,includeScore:s,shouldSort:r,sortFn:o,ignoreFieldNorm:a}=this.options,l=q(e)?q(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(h,{ignoreFieldNorm:c=_.ignoreFieldNorm}){h.forEach(g=>{let p=1;g.matches.forEach(({key:m,norm:f,score:d})=>{let u=m?m.weight:null;p*=Math.pow(d===0&&u?Number.EPSILON:d,(u||1)*(c?1:f))}),g.score=p})}(l,{ignoreFieldNorm:a}),r&&l.sort(o),_t(t)&&t>-1&&(l=l.slice(0,t)),function(h,c,{includeMatches:g=_.includeMatches,includeScore:p=_.includeScore}={}){let m=[];return g&&m.push(Xt),p&&m.push(Zt),h.map(f=>{let{idx:d}=f,u={item:c[d],refIndex:d};return m.length&&m.forEach(b=>{b(f,u)}),u})}(l,this._docs,{includeMatches:i,includeScore:s})}_searchStringList(e){let t=$e(e,this.options),{records:i}=this._myIndex,s=[];return i.forEach(({v:r,i:o,n:a})=>{if(!k(r))return;let{isMatch:l,score:h,indices:c}=t.searchIn(r);l&&s.push({item:r,idx:o,matches:[{score:h,value:r,norm:a,indices:c}]})}),s}_searchLogical(e){let t=Ct(e,this.options),i=(a,l,h)=>{if(!a.children){let{keyId:g,searcher:p}=a,m=this._findMatches({key:this._keyStore.get(g),value:this._myIndex.getValueForItemAtKeyId(l,g),searcher:p});return m&&m.length?[{idx:h,item:l,matches:m}]:[]}let c=[];for(let g=0,p=a.children.length;g<p;g+=1){let m=a.children[g],f=i(m,l,h);if(f.length)c.push(...f);else if(a.operator===je)return[]}return c},s=this._myIndex.records,r={},o=[];return s.forEach(({$:a,i:l})=>{if(k(a)){let h=i(t,a,l);h.length&&(r[l]||(r[l]={idx:l,item:a,matches:[]},o.push(r[l])),h.forEach(({matches:c})=>{r[l].matches.push(...c)}))}}),o}_searchObjectList(e){let t=$e(e,this.options),{keys:i,records:s}=this._myIndex,r=[];return s.forEach(({$:o,i:a})=>{if(!k(o))return;let l=[];i.forEach((h,c)=>{l.push(...this._findMatches({key:h,value:o[c],searcher:t}))}),l.length&&r.push({idx:a,item:o,matches:l})}),r}_findMatches({key:e,value:t,searcher:i}){if(!k(t))return[];let s=[];if(V(t))t.forEach(({v:r,i:o,n:a})=>{if(!k(r))return;let{isMatch:l,score:h,indices:c}=i.searchIn(r);l&&s.push({score:h,key:e,value:r,idx:o,norm:a,indices:c})});else{let{v:r,n:o}=t,{isMatch:a,score:l,indices:h}=i.searchIn(r);a&&s.push({score:l,key:e,value:r,norm:o,indices:h})}return s}};U.version="6.5.3",U.createIndex=xt,U.parseIndex=function(n,{getFn:e=_.getFn,fieldNormWeight:t=_.fieldNormWeight}={}){let{keys:i,records:s}=n,r=new re({getFn:e,fieldNormWeight:t});return r.setKeys(i),r.setIndexRecords(s),r},U.config=_,U.parseQuery=Ct,function(...n){Pe.push(...n)}(Ne);var j={showDropdown:"showDropdown",hideDropdown:"hideDropdown",change:"change",choice:"choice",search:"search",addItem:"addItem",removeItem:"removeItem",highlightItem:"highlightItem",highlightChoice:"highlightChoice",unhighlightItem:"unhighlightItem"},H={ADD_CHOICE:"ADD_CHOICE",FILTER_CHOICES:"FILTER_CHOICES",ACTIVATE_CHOICES:"ACTIVATE_CHOICES",CLEAR_CHOICES:"CLEAR_CHOICES",ADD_GROUP:"ADD_GROUP",ADD_ITEM:"ADD_ITEM",REMOVE_ITEM:"REMOVE_ITEM",HIGHLIGHT_ITEM:"HIGHLIGHT_ITEM",CLEAR_ALL:"CLEAR_ALL",RESET_TO:"RESET_TO",SET_IS_LOADING:"SET_IS_LOADING"},me={BACK_KEY:46,DELETE_KEY:8,ENTER_KEY:13,A_KEY:65,ESC_KEY:27,UP_KEY:38,DOWN_KEY:40,PAGE_UP_KEY:33,PAGE_DOWN_KEY:34};var Te=(n=!0)=>({type:H.ACTIVATE_CHOICES,active:n}),ut=({value:n,id:e,active:t,disabled:i})=>({type:H.ADD_GROUP,value:n,id:e,active:t,disabled:i}),mt=(n,e)=>({type:H.HIGHLIGHT_ITEM,id:n,highlighted:e}),pt=n=>({type:H.SET_IS_LOADING,isLoading:n}),ke=class{constructor({element:e,type:t,classNames:i}){this.element=e,this.classNames=i,this.type=t,this.isActive=!1}get distanceFromTopWindow(){return this.element.getBoundingClientRect().bottom}getChild(e){return this.element.querySelector(e)}show(){return this.element.classList.add(this.classNames.activeState),this.element.setAttribute("aria-expanded","true"),this.isActive=!0,this}hide(){return this.element.classList.remove(this.classNames.activeState),this.element.setAttribute("aria-expanded","false"),this.isActive=!1,this}},gt=n=>Array.from({length:n},()=>{return(e=0,t=36,Math.floor(Math.random()*(t-e)+e)).toString(36);var e,t}).join(""),It=n=>Object.prototype.toString.call(n).slice(8,-1),ft=(n,e)=>e!=null&&It(e)===n,Tt=n=>typeof n!="string"?n:n.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),Qt=(()=>{let n=document.createElement("div");return e=>{let t=e.trim();n.innerHTML=t;let i=n.children[0];for(;n.firstChild;)n.removeChild(n.firstChild);return i}})(),ei=(n,e)=>{let{score:t=0}=n,{score:i=0}=e;return t-i},ye=class{constructor({element:e,type:t,classNames:i,position:s}){this.element=e,this.classNames=i,this.type=t,this.position=s,this.isOpen=!1,this.isFlipped=!1,this.isFocussed=!1,this.isDisabled=!1,this.isLoading=!1,this._onFocus=this._onFocus.bind(this),this._onBlur=this._onBlur.bind(this)}addEventListeners(){this.element.addEventListener("focus",this._onFocus),this.element.addEventListener("blur",this._onBlur)}removeEventListeners(){this.element.removeEventListener("focus",this._onFocus),this.element.removeEventListener("blur",this._onBlur)}shouldFlip(e){if(typeof e!="number")return!1;let t=!1;return this.position==="auto"?t=!window.matchMedia(`(min-height: ${e+1}px)`).matches:this.position==="top"&&(t=!0),t}setActiveDescendant(e){this.element.setAttribute("aria-activedescendant",e)}removeActiveDescendant(){this.element.removeAttribute("aria-activedescendant")}open(e){this.element.classList.add(this.classNames.openState),this.element.setAttribute("aria-expanded","true"),this.isOpen=!0,this.shouldFlip(e)&&(this.element.classList.add(this.classNames.flippedState),this.isFlipped=!0)}close(){this.element.classList.remove(this.classNames.openState),this.element.setAttribute("aria-expanded","false"),this.removeActiveDescendant(),this.isOpen=!1,this.isFlipped&&(this.element.classList.remove(this.classNames.flippedState),this.isFlipped=!1)}focus(){this.isFocussed||this.element.focus()}addFocusState(){this.element.classList.add(this.classNames.focusState)}removeFocusState(){this.element.classList.remove(this.classNames.focusState)}enable(){this.element.classList.remove(this.classNames.disabledState),this.element.removeAttribute("aria-disabled"),this.type==="select-one"&&this.element.setAttribute("tabindex","0"),this.isDisabled=!1}disable(){this.element.classList.add(this.classNames.disabledState),this.element.setAttribute("aria-disabled","true"),this.type==="select-one"&&this.element.setAttribute("tabindex","-1"),this.isDisabled=!0}wrap(e){((t,i=document.createElement("div"))=>{t.parentNode&&(t.nextSibling?t.parentNode.insertBefore(i,t.nextSibling):t.parentNode.appendChild(i)),i.appendChild(t)})(e,this.element)}unwrap(e){this.element.parentNode&&(this.element.parentNode.insertBefore(e,this.element),this.element.parentNode.removeChild(this.element))}addLoadingState(){this.element.classList.add(this.classNames.loadingState),this.element.setAttribute("aria-busy","true"),this.isLoading=!0}removeLoadingState(){this.element.classList.remove(this.classNames.loadingState),this.element.removeAttribute("aria-busy"),this.isLoading=!1}_onFocus(){this.isFocussed=!0}_onBlur(){this.isFocussed=!1}},Be=class{constructor({element:e,type:t,classNames:i,preventPaste:s}){this.element=e,this.type=t,this.classNames=i,this.preventPaste=s,this.isFocussed=this.element.isEqualNode(document.activeElement),this.isDisabled=e.disabled,this._onPaste=this._onPaste.bind(this),this._onInput=this._onInput.bind(this),this._onFocus=this._onFocus.bind(this),this._onBlur=this._onBlur.bind(this)}set placeholder(e){this.element.placeholder=e}get value(){return Tt(this.element.value)}set value(e){this.element.value=e}get rawValue(){return this.element.value}addEventListeners(){this.element.addEventListener("paste",this._onPaste),this.element.addEventListener("input",this._onInput,{passive:!0}),this.element.addEventListener("focus",this._onFocus,{passive:!0}),this.element.addEventListener("blur",this._onBlur,{passive:!0})}removeEventListeners(){this.element.removeEventListener("input",this._onInput),this.element.removeEventListener("paste",this._onPaste),this.element.removeEventListener("focus",this._onFocus),this.element.removeEventListener("blur",this._onBlur)}enable(){this.element.removeAttribute("disabled"),this.isDisabled=!1}disable(){this.element.setAttribute("disabled",""),this.isDisabled=!0}focus(){this.isFocussed||this.element.focus()}blur(){this.isFocussed&&this.element.blur()}clear(e=!0){return this.element.value&&(this.element.value=""),e&&this.setWidth(),this}setWidth(){let{style:e,value:t,placeholder:i}=this.element;e.minWidth=`${i.length+1}ch`,e.width=`${t.length+1}ch`}setActiveDescendant(e){this.element.setAttribute("aria-activedescendant",e)}removeActiveDescendant(){this.element.removeAttribute("aria-activedescendant")}_onInput(){this.type!=="select-one"&&this.setWidth()}_onPaste(e){this.preventPaste&&e.preventDefault()}_onFocus(){this.isFocussed=!0}_onBlur(){this.isFocussed=!1}},ve=class{constructor({element:e}){this.element=e,this.scrollPos=this.element.scrollTop,this.height=this.element.offsetHeight}clear(){this.element.innerHTML=""}append(e){this.element.appendChild(e)}getChild(e){return this.element.querySelector(e)}hasChildren(){return this.element.hasChildNodes()}scrollToTop(){this.element.scrollTop=0}scrollToChildElement(e,t){if(!e)return;let i=this.element.offsetHeight,s=this.element.scrollTop+i,r=e.offsetHeight,o=e.offsetTop+r,a=t>0?this.element.scrollTop+o-s:e.offsetTop;requestAnimationFrame(()=>{this._animateScroll(a,t)})}_scrollDown(e,t,i){let s=(i-e)/t,r=s>1?s:1;this.element.scrollTop=e+r}_scrollUp(e,t,i){let s=(e-i)/t,r=s>1?s:1;this.element.scrollTop=e-r}_animateScroll(e,t){let i=this.element.scrollTop,s=!1;t>0?(this._scrollDown(i,4,e),i<e&&(s=!0)):(this._scrollUp(i,4,e),i>e&&(s=!0)),s&&requestAnimationFrame(()=>{this._animateScroll(e,t)})}},_e=class{constructor({element:e,classNames:t}){if(this.element=e,this.classNames=t,!(e instanceof HTMLInputElement||e instanceof HTMLSelectElement))throw new TypeError("Invalid element passed");this.isDisabled=!1}get isActive(){return this.element.dataset.choice==="active"}get dir(){return this.element.dir}get value(){return this.element.value}set value(e){this.element.value=e}conceal(){this.element.classList.add(this.classNames.input),this.element.hidden=!0,this.element.tabIndex=-1;let e=this.element.getAttribute("style");e&&this.element.setAttribute("data-choice-orig-style",e),this.element.setAttribute("data-choice","active")}reveal(){this.element.classList.remove(this.classNames.input),this.element.hidden=!1,this.element.removeAttribute("tabindex");let e=this.element.getAttribute("data-choice-orig-style");e?(this.element.removeAttribute("data-choice-orig-style"),this.element.setAttribute("style",e)):this.element.removeAttribute("style"),this.element.removeAttribute("data-choice"),this.element.value=this.element.value}enable(){this.element.removeAttribute("disabled"),this.element.disabled=!1,this.isDisabled=!1}disable(){this.element.setAttribute("disabled",""),this.element.disabled=!0,this.isDisabled=!0}triggerEvent(e,t){((i,s,r=null)=>{let o=new CustomEvent(s,{detail:r,bubbles:!0,cancelable:!0});i.dispatchEvent(o)})(this.element,e,t)}},Fe=class extends _e{constructor({element:e,classNames:t,delimiter:i}){super({element:e,classNames:t}),this.delimiter=i}get value(){return this.element.value}set value(e){this.element.setAttribute("value",e),this.element.value=e}},Re=class extends _e{constructor({element:e,classNames:t,template:i}){super({element:e,classNames:t}),this.template=i}get placeholderOption(){return this.element.querySelector('option[value=""]')||this.element.querySelector("option[placeholder]")}get optionGroups(){return Array.from(this.element.getElementsByTagName("OPTGROUP"))}get options(){return Array.from(this.element.options)}set options(e){let t=document.createDocumentFragment(),i=s=>{let r=this.template(s);t.appendChild(r)};e.forEach(s=>i(s)),this.appendDocFragment(t)}appendDocFragment(e){this.element.innerHTML="",this.element.appendChild(e)}},ti={containerOuter:"choices",containerInner:"choices__inner",input:"choices__input",inputCloned:"choices__input--cloned",list:"choices__list",listItems:"choices__list--multiple",listSingle:"choices__list--single",listDropdown:"choices__list--dropdown",item:"choices__item",itemSelectable:"choices__item--selectable",itemDisabled:"choices__item--disabled",itemChoice:"choices__item--choice",placeholder:"choices__placeholder",group:"choices__group",groupHeading:"choices__heading",button:"choices__button",activeState:"is-active",focusState:"is-focused",openState:"is-open",disabledState:"is-disabled",highlightedState:"is-highlighted",selectedState:"is-selected",flippedState:"is-flipped",loadingState:"is-loading",noResults:"has-no-results",noChoices:"has-no-choices"},bt={items:[],choices:[],silent:!1,renderChoiceLimit:-1,maxItemCount:-1,addItems:!0,addItemFilter:null,removeItems:!0,removeItemButton:!1,editItems:!1,allowHTML:!0,duplicateItemsAllowed:!0,delimiter:",",paste:!0,searchEnabled:!0,searchChoices:!0,searchFloor:1,searchResultLimit:4,searchFields:["label","value"],position:"auto",resetScrollPosition:!0,shouldSort:!0,shouldSortItems:!1,sorter:({value:n,label:e=n},{value:t,label:i=t})=>e.localeCompare(i,[],{sensitivity:"base",ignorePunctuation:!0,numeric:!0}),placeholder:!0,placeholderValue:null,searchPlaceholderValue:null,prependValue:null,appendValue:null,renderSelectedChoices:"auto",loadingText:"Loading...",noResultsText:"No results found",noChoicesText:"No choices to choose from",itemSelectText:"Press to select",uniqueItemText:"Only unique values can be added",customAddItemText:"Only values matching specific conditions can be added",addItemText:n=>`Press Enter to add <b>"${Tt(n)}"</b>`,maxItemText:n=>`Only ${n} values can be added`,valueComparer:(n,e)=>n===e,fuseOptions:{includeScore:!0},callbackOnInit:null,callbackOnCreateTemplates:null,classNames:ti};function $(n){return"Minified Redux error #"+n+"; visit https://redux.js.org/Errors?code="+n+" for the full message or use the non-minified dev environment for full errors. "}var yt=typeof Symbol=="function"&&Symbol.observable||"@@observable",Le=function(){return Math.random().toString(36).substring(7).split("").join(".")},Ee={INIT:"@@redux/INIT"+Le(),REPLACE:"@@redux/REPLACE"+Le(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+Le()}};function ii(n){if(typeof n!="object"||n===null)return!1;for(var e=n;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(n)===e}function Lt(n,e,t){var i;if(typeof e=="function"&&typeof t=="function"||typeof t=="function"&&typeof arguments[3]=="function")throw new Error($(0));if(typeof e=="function"&&t===void 0&&(t=e,e=void 0),t!==void 0){if(typeof t!="function")throw new Error($(1));return t(Lt)(n,e)}if(typeof n!="function")throw new Error($(2));var s=n,r=e,o=[],a=o,l=!1;function h(){a===o&&(a=o.slice())}function c(){if(l)throw new Error($(3));return r}function g(d){if(typeof d!="function")throw new Error($(4));if(l)throw new Error($(5));var u=!0;return h(),a.push(d),function(){if(u){if(l)throw new Error($(6));u=!1,h();var b=a.indexOf(d);a.splice(b,1),o=null}}}function p(d){if(!ii(d))throw new Error($(7));if(d.type===void 0)throw new Error($(8));if(l)throw new Error($(9));try{l=!0,r=s(r,d)}finally{l=!1}for(var u=o=a,b=0;b<u.length;b++)(0,u[b])();return d}function m(d){if(typeof d!="function")throw new Error($(10));s=d,p({type:Ee.REPLACE})}function f(){var d,u=g;return(d={subscribe:function(b){if(typeof b!="object"||b===null)throw new Error($(11));function y(){b.next&&b.next(c())}return y(),{unsubscribe:u(y)}}})[yt]=function(){return this},d}return p({type:Ee.INIT}),(i={dispatch:p,subscribe:g,getState:c,replaceReducer:m})[yt]=f,i}var si=[],ni=[],vt=[],pe={groups:[],items:[],choices:[],loading:!1},ri=function(n){for(var e=Object.keys(n),t={},i=0;i<e.length;i++){var s=e[i];typeof n[s]=="function"&&(t[s]=n[s])}var r,o=Object.keys(t);try{(function(a){Object.keys(a).forEach(function(l){var h=a[l];if(h(void 0,{type:Ee.INIT})===void 0)throw new Error($(12));if(h(void 0,{type:Ee.PROBE_UNKNOWN_ACTION()})===void 0)throw new Error($(13))})})(t)}catch(a){r=a}return function(a,l){if(a===void 0&&(a={}),r)throw r;for(var h=!1,c={},g=0;g<o.length;g++){var p=o[g],m=t[p],f=a[p],d=m(f,l);if(d===void 0)throw l&&l.type,new Error($(14));c[p]=d,h=h||d!==f}return(h=h||o.length!==Object.keys(a).length)?c:a}}({items:function(n=si,e={}){switch(e.type){case"ADD_ITEM":{let t=e;return[...n,{id:t.id,choiceId:t.choiceId,groupId:t.groupId,value:t.value,label:t.label,active:!0,highlighted:!1,customProperties:t.customProperties,placeholder:t.placeholder||!1,keyCode:null}].map(i=>{let s=i;return s.highlighted=!1,s})}case"REMOVE_ITEM":return n.map(t=>{let i=t;return i.id===e.id&&(i.active=!1),i});case"HIGHLIGHT_ITEM":{let t=e;return n.map(i=>{let s=i;return s.id===t.id&&(s.highlighted=t.highlighted),s})}default:return n}},groups:function(n=ni,e={}){switch(e.type){case"ADD_GROUP":{let t=e;return[...n,{id:t.id,value:t.value,active:t.active,disabled:t.disabled}]}case"CLEAR_CHOICES":return[];default:return n}},choices:function(n=vt,e={}){switch(e.type){case"ADD_CHOICE":{let t=e,i={id:t.id,elementId:t.elementId,groupId:t.groupId,value:t.value,label:t.label||t.value,disabled:t.disabled||!1,selected:!1,active:!0,score:9999,customProperties:t.customProperties,placeholder:t.placeholder||!1};return[...n,i]}case"ADD_ITEM":{let t=e;return t.choiceId>-1?n.map(i=>{let s=i;return s.id===parseInt(`${t.choiceId}`,10)&&(s.selected=!0),s}):n}case"REMOVE_ITEM":{let t=e;return t.choiceId&&t.choiceId>-1?n.map(i=>{let s=i;return s.id===parseInt(`${t.choiceId}`,10)&&(s.selected=!1),s}):n}case"FILTER_CHOICES":{let t=e;return n.map(i=>{let s=i;return s.active=t.results.some(({item:r,score:o})=>r.id===s.id&&(s.score=o,!0)),s})}case"ACTIVATE_CHOICES":{let t=e;return n.map(i=>{let s=i;return s.active=t.active,s})}case"CLEAR_CHOICES":return vt;default:return n}},loading:(n=!1,e={})=>e.type==="SET_IS_LOADING"?e.isLoading:n}),oi=(n,e)=>{let t=n;if(e.type==="CLEAR_ALL")t=pe;else if(e.type==="RESET_TO")return i=e.state,JSON.parse(JSON.stringify(i));var i;return ri(t,e)},He=class{constructor(){this._store=Lt(oi,window.__REDUX_DEVTOOLS_EXTENSION__&&window.__REDUX_DEVTOOLS_EXTENSION__())}subscribe(e){this._store.subscribe(e)}dispatch(e){this._store.dispatch(e)}get state(){return this._store.getState()}get items(){return this.state.items}get activeItems(){return this.items.filter(e=>e.active===!0)}get highlightedActiveItems(){return this.items.filter(e=>e.active&&e.highlighted)}get choices(){return this.state.choices}get activeChoices(){return this.choices.filter(e=>e.active===!0)}get selectableChoices(){return this.choices.filter(e=>e.disabled!==!0)}get searchableChoices(){return this.selectableChoices.filter(e=>e.placeholder!==!0)}get placeholderChoice(){return[...this.choices].reverse().find(e=>e.placeholder===!0)}get groups(){return this.state.groups}get activeGroups(){let{groups:e,choices:t}=this;return e.filter(i=>{let s=i.active===!0&&i.disabled===!1,r=t.some(o=>o.active===!0&&o.disabled===!1);return s&&r},[])}isLoading(){return this.state.loading}getChoiceById(e){return this.activeChoices.find(t=>t.id===parseInt(e,10))}getGroupById(e){return this.groups.find(t=>t.id===e)}},Oe={containerOuter({classNames:{containerOuter:n}},e,t,i,s,r){let o=Object.assign(document.createElement("div"),{className:n});return o.dataset.type=r,e&&(o.dir=e),i&&(o.tabIndex=0),t&&(o.setAttribute("role",s?"combobox":"listbox"),s&&o.setAttribute("aria-autocomplete","list")),o.setAttribute("aria-haspopup","true"),o.setAttribute("aria-expanded","false"),o},containerInner:({classNames:{containerInner:n}})=>Object.assign(document.createElement("div"),{className:n}),itemList:({classNames:{list:n,listSingle:e,listItems:t}},i)=>Object.assign(document.createElement("div"),{className:`${n} ${i?e:t}`}),placeholder:({allowHTML:n,classNames:{placeholder:e}},t)=>Object.assign(document.createElement("div"),{className:e,[n?"innerHTML":"innerText"]:t}),item({allowHTML:n,classNames:{item:e,button:t,highlightedState:i,itemSelectable:s,placeholder:r}},{id:o,value:a,label:l,customProperties:h,active:c,disabled:g,highlighted:p,placeholder:m},f){let d=Object.assign(document.createElement("div"),{className:e,[n?"innerHTML":"innerText"]:l});if(Object.assign(d.dataset,{item:"",id:o,value:a,customProperties:h}),c&&d.setAttribute("aria-selected","true"),g&&d.setAttribute("aria-disabled","true"),m&&d.classList.add(r),d.classList.add(p?i:s),f){g&&d.classList.remove(s),d.dataset.deletable="";let u="Remove item",b=Object.assign(document.createElement("button"),{type:"button",className:t,[n?"innerHTML":"innerText"]:u});b.setAttribute("aria-label",`${u}: '${a}'`),b.dataset.button="",d.appendChild(b)}return d},choiceList({classNames:{list:n}},e){let t=Object.assign(document.createElement("div"),{className:n});return e||t.setAttribute("aria-multiselectable","true"),t.setAttribute("role","listbox"),t},choiceGroup({allowHTML:n,classNames:{group:e,groupHeading:t,itemDisabled:i}},{id:s,value:r,disabled:o}){let a=Object.assign(document.createElement("div"),{className:`${e} ${o?i:""}`});return a.setAttribute("role","group"),Object.assign(a.dataset,{group:"",id:s,value:r}),o&&a.setAttribute("aria-disabled","true"),a.appendChild(Object.assign(document.createElement("div"),{className:t,[n?"innerHTML":"innerText"]:r})),a},choice({allowHTML:n,classNames:{item:e,itemChoice:t,itemSelectable:i,selectedState:s,itemDisabled:r,placeholder:o}},{id:a,value:l,label:h,groupId:c,elementId:g,disabled:p,selected:m,placeholder:f},d){let u=Object.assign(document.createElement("div"),{id:g,[n?"innerHTML":"innerText"]:h,className:`${e} ${t}`});return m&&u.classList.add(s),f&&u.classList.add(o),u.setAttribute("role",c&&c>0?"treeitem":"option"),Object.assign(u.dataset,{choice:"",id:a,value:l,selectText:d}),p?(u.classList.add(r),u.dataset.choiceDisabled="",u.setAttribute("aria-disabled","true")):(u.classList.add(i),u.dataset.choiceSelectable=""),u},input({classNames:{input:n,inputCloned:e}},t){let i=Object.assign(document.createElement("input"),{type:"search",name:"search_terms",className:`${n} ${e}`,autocomplete:"off",autocapitalize:"off",spellcheck:!1});return i.setAttribute("role","textbox"),i.setAttribute("aria-autocomplete","list"),i.setAttribute("aria-label",t),i},dropdown({classNames:{list:n,listDropdown:e}}){let t=document.createElement("div");return t.classList.add(n,e),t.setAttribute("aria-expanded","false"),t},notice({allowHTML:n,classNames:{item:e,itemChoice:t,noResults:i,noChoices:s}},r,o=""){let a=[e,t];return o==="no-choices"?a.push(s):o==="no-results"&&a.push(i),Object.assign(document.createElement("div"),{[n?"innerHTML":"innerText"]:r,className:a.join(" ")})},option({label:n,value:e,customProperties:t,active:i,disabled:s}){let r=new Option(n,e,!1,i);return t&&(r.dataset.customProperties=`${t}`),r.disabled=!!s,r}},ai="-ms-scroll-limit"in document.documentElement.style&&"-ms-ime-align"in document.documentElement.style,li={},Se=class n{constructor(e="[data-choice]",t={}){t.allowHTML===void 0&&console.warn("Deprecation warning: allowHTML will default to false in a future release. To render HTML in Choices, you will need to set it to true. Setting allowHTML will suppress this message."),this.config=rt.all([bt,n.defaults.options,t],{arrayMerge:(r,o)=>[...o]});let i=((r,o)=>{let a=Object.keys(r).sort(),l=Object.keys(o).sort();return a.filter(h=>l.indexOf(h)<0)})(this.config,bt);i.length&&console.warn("Unknown config option(s) passed",i.join(", "));let s=typeof e=="string"?document.querySelector(e):e;if(!(s instanceof HTMLInputElement||s instanceof HTMLSelectElement))throw TypeError("Expected one of the following types text|select-one|select-multiple");if(this._isTextElement=s.type==="text",this._isSelectOneElement=s.type==="select-one",this._isSelectMultipleElement=s.type==="select-multiple",this._isSelectElement=this._isSelectOneElement||this._isSelectMultipleElement,this.config.searchEnabled=this._isSelectMultipleElement||this.config.searchEnabled,["auto","always"].includes(`${this.config.renderSelectedChoices}`)||(this.config.renderSelectedChoices="auto"),t.addItemFilter&&typeof t.addItemFilter!="function"){let r=t.addItemFilter instanceof RegExp?t.addItemFilter:new RegExp(t.addItemFilter);this.config.addItemFilter=r.test.bind(r)}if(this._isTextElement?this.passedElement=new Fe({element:s,classNames:this.config.classNames,delimiter:this.config.delimiter}):this.passedElement=new Re({element:s,classNames:this.config.classNames,template:r=>this._templates.option(r)}),this.initialised=!1,this._store=new He,this._initialState=pe,this._currentState=pe,this._prevState=pe,this._currentValue="",this._canSearch=!!this.config.searchEnabled,this._isScrollingOnIe=!1,this._highlightPosition=0,this._wasTap=!0,this._placeholderValue=this._generatePlaceholderValue(),this._baseId=((r,o)=>{let a=r.id||r.name&&`${r.name}-${gt(2)}`||gt(4);return a=a.replace(/(:|\.|\[|\]|,)/g,""),a=`${o}-${a}`,a})(this.passedElement.element,"choices-"),this._direction=this.passedElement.dir,!this._direction){let{direction:r}=window.getComputedStyle(this.passedElement.element),{direction:o}=window.getComputedStyle(document.documentElement);r!==o&&(this._direction=r)}if(this._idNames={itemChoice:"item-choice"},this._isSelectElement&&(this._presetGroups=this.passedElement.optionGroups,this._presetOptions=this.passedElement.options),this._presetChoices=this.config.choices,this._presetItems=this.config.items,this.passedElement.value&&this._isTextElement){let r=this.passedElement.value.split(this.config.delimiter);this._presetItems=this._presetItems.concat(r)}if(this.passedElement.options&&this.passedElement.options.forEach(r=>{this._presetChoices.push({value:r.value,label:r.innerHTML,selected:!!r.selected,disabled:r.disabled||r.parentNode.disabled,placeholder:r.value===""||r.hasAttribute("placeholder"),customProperties:r.dataset["custom-properties"]})}),this._render=this._render.bind(this),this._onFocus=this._onFocus.bind(this),this._onBlur=this._onBlur.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onClick=this._onClick.bind(this),this._onTouchMove=this._onTouchMove.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onMouseDown=this._onMouseDown.bind(this),this._onMouseOver=this._onMouseOver.bind(this),this._onFormReset=this._onFormReset.bind(this),this._onSelectKey=this._onSelectKey.bind(this),this._onEnterKey=this._onEnterKey.bind(this),this._onEscapeKey=this._onEscapeKey.bind(this),this._onDirectionKey=this._onDirectionKey.bind(this),this._onDeleteKey=this._onDeleteKey.bind(this),this.passedElement.isActive)return this.config.silent||console.warn("Trying to initialise Choices on element already initialised",{element:e}),void(this.initialised=!0);this.init()}static get defaults(){return Object.preventExtensions({get options(){return li},get templates(){return Oe}})}init(){if(this.initialised)return;this._createTemplates(),this._createElements(),this._createStructure(),this._store.subscribe(this._render),this._render(),this._addEventListeners(),(!this.config.addItems||this.passedElement.element.hasAttribute("disabled"))&&this.disable(),this.initialised=!0;let{callbackOnInit:e}=this.config;e&&typeof e=="function"&&e.call(this)}destroy(){this.initialised&&(this._removeEventListeners(),this.passedElement.reveal(),this.containerOuter.unwrap(this.passedElement.element),this.clearStore(),this._isSelectElement&&(this.passedElement.options=this._presetOptions),this._templates=Oe,this.initialised=!1)}enable(){return this.passedElement.isDisabled&&this.passedElement.enable(),this.containerOuter.isDisabled&&(this._addEventListeners(),this.input.enable(),this.containerOuter.enable()),this}disable(){return this.passedElement.isDisabled||this.passedElement.disable(),this.containerOuter.isDisabled||(this._removeEventListeners(),this.input.disable(),this.containerOuter.disable()),this}highlightItem(e,t=!0){if(!e||!e.id)return this;let{id:i,groupId:s=-1,value:r="",label:o=""}=e,a=s>=0?this._store.getGroupById(s):null;return this._store.dispatch(mt(i,!0)),t&&this.passedElement.triggerEvent(j.highlightItem,{id:i,value:r,label:o,groupValue:a&&a.value?a.value:null}),this}unhighlightItem(e){if(!e||!e.id)return this;let{id:t,groupId:i=-1,value:s="",label:r=""}=e,o=i>=0?this._store.getGroupById(i):null;return this._store.dispatch(mt(t,!1)),this.passedElement.triggerEvent(j.highlightItem,{id:t,value:s,label:r,groupValue:o&&o.value?o.value:null}),this}highlightAll(){return this._store.items.forEach(e=>this.highlightItem(e)),this}unhighlightAll(){return this._store.items.forEach(e=>this.unhighlightItem(e)),this}removeActiveItemsByValue(e){return this._store.activeItems.filter(t=>t.value===e).forEach(t=>this._removeItem(t)),this}removeActiveItems(e){return this._store.activeItems.filter(({id:t})=>t!==e).forEach(t=>this._removeItem(t)),this}removeHighlightedItems(e=!1){return this._store.highlightedActiveItems.forEach(t=>{this._removeItem(t),e&&this._triggerChange(t.value)}),this}showDropdown(e){return this.dropdown.isActive||requestAnimationFrame(()=>{this.dropdown.show(),this.containerOuter.open(this.dropdown.distanceFromTopWindow),!e&&this._canSearch&&this.input.focus(),this.passedElement.triggerEvent(j.showDropdown,{})}),this}hideDropdown(e){return this.dropdown.isActive?(requestAnimationFrame(()=>{this.dropdown.hide(),this.containerOuter.close(),!e&&this._canSearch&&(this.input.removeActiveDescendant(),this.input.blur()),this.passedElement.triggerEvent(j.hideDropdown,{})}),this):this}getValue(e=!1){let t=this._store.activeItems.reduce((i,s)=>{let r=e?s.value:s;return i.push(r),i},[]);return this._isSelectOneElement?t[0]:t}setValue(e){return this.initialised?(e.forEach(t=>this._setChoiceOrItem(t)),this):this}setChoiceByValue(e){return!this.initialised||this._isTextElement?this:((Array.isArray(e)?e:[e]).forEach(t=>this._findAndSelectChoiceByValue(t)),this)}setChoices(e=[],t="value",i="label",s=!1){if(!this.initialised)throw new ReferenceError("setChoices was called on a non-initialized instance of Choices");if(!this._isSelectElement)throw new TypeError("setChoices can't be used with INPUT based Choices");if(typeof t!="string"||!t)throw new TypeError("value parameter must be a name of 'value' field in passed objects");if(s&&this.clearChoices(),typeof e=="function"){let r=e(this);if(typeof Promise=="function"&&r instanceof Promise)return new Promise(o=>requestAnimationFrame(o)).then(()=>this._handleLoadingState(!0)).then(()=>r).then(o=>this.setChoices(o,t,i,s)).catch(o=>{this.config.silent||console.error(o)}).then(()=>this._handleLoadingState(!1)).then(()=>this);if(!Array.isArray(r))throw new TypeError(".setChoices first argument function must return either array of choices or Promise, got: "+typeof r);return this.setChoices(r,t,i,!1)}if(!Array.isArray(e))throw new TypeError(".setChoices must be called either with array of choices with a function resulting into Promise of array of choices");return this.containerOuter.removeLoadingState(),this._startLoading(),e.forEach(r=>{if(r.choices)this._addGroup({id:r.id?parseInt(`${r.id}`,10):null,group:r,valueKey:t,labelKey:i});else{let o=r;this._addChoice({value:o[t],label:o[i],isSelected:!!o.selected,isDisabled:!!o.disabled,placeholder:!!o.placeholder,customProperties:o.customProperties})}}),this._stopLoading(),this}clearChoices(){return this._store.dispatch({type:H.CLEAR_CHOICES}),this}clearStore(){return this._store.dispatch({type:H.CLEAR_ALL}),this}clearInput(){let e=!this._isSelectOneElement;return this.input.clear(e),!this._isTextElement&&this._canSearch&&(this._isSearching=!1,this._store.dispatch(Te(!0))),this}_render(){if(this._store.isLoading())return;this._currentState=this._store.state;let e=this._currentState.choices!==this._prevState.choices||this._currentState.groups!==this._prevState.groups||this._currentState.items!==this._prevState.items,t=this._isSelectElement,i=this._currentState.items!==this._prevState.items;e&&(t&&this._renderChoices(),i&&this._renderItems(),this._prevState=this._currentState)}_renderChoices(){let{activeGroups:e,activeChoices:t}=this._store,i=document.createDocumentFragment();if(this.choiceList.clear(),this.config.resetScrollPosition&&requestAnimationFrame(()=>this.choiceList.scrollToTop()),e.length>=1&&!this._isSearching){let s=t.filter(r=>r.placeholder===!0&&r.groupId===-1);s.length>=1&&(i=this._createChoicesFragment(s,i)),i=this._createGroupsFragment(e,t,i)}else t.length>=1&&(i=this._createChoicesFragment(t,i));if(i.childNodes&&i.childNodes.length>0){let{activeItems:s}=this._store,r=this._canAddItem(s,this.input.value);if(r.response)this.choiceList.append(i),this._highlightChoice();else{let o=this._getTemplate("notice",r.notice);this.choiceList.append(o)}}else{let s,r;this._isSearching?(r=typeof this.config.noResultsText=="function"?this.config.noResultsText():this.config.noResultsText,s=this._getTemplate("notice",r,"no-results")):(r=typeof this.config.noChoicesText=="function"?this.config.noChoicesText():this.config.noChoicesText,s=this._getTemplate("notice",r,"no-choices")),this.choiceList.append(s)}}_renderItems(){let e=this._store.activeItems||[];this.itemList.clear();let t=this._createItemsFragment(e);t.childNodes&&this.itemList.append(t)}_createGroupsFragment(e,t,i=document.createDocumentFragment()){let s=r=>t.filter(o=>this._isSelectOneElement?o.groupId===r.id:o.groupId===r.id&&(this.config.renderSelectedChoices==="always"||!o.selected));return this.config.shouldSort&&e.sort(this.config.sorter),e.forEach(r=>{let o=s(r);if(o.length>=1){let a=this._getTemplate("choiceGroup",r);i.appendChild(a),this._createChoicesFragment(o,i,!0)}}),i}_createChoicesFragment(e,t=document.createDocumentFragment(),i=!1){let{renderSelectedChoices:s,searchResultLimit:r,renderChoiceLimit:o}=this.config,a=this._isSearching?ei:this.config.sorter,l=f=>{if(s!=="auto"||this._isSelectOneElement||!f.selected){let d=this._getTemplate("choice",f,this.config.itemSelectText);t.appendChild(d)}},h=e;s!=="auto"||this._isSelectOneElement||(h=e.filter(f=>!f.selected));let{placeholderChoices:c,normalChoices:g}=h.reduce((f,d)=>(d.placeholder?f.placeholderChoices.push(d):f.normalChoices.push(d),f),{placeholderChoices:[],normalChoices:[]});(this.config.shouldSort||this._isSearching)&&g.sort(a);let p=h.length,m=this._isSelectOneElement?[...c,...g]:g;this._isSearching?p=r:o&&o>0&&!i&&(p=o);for(let f=0;f<p;f+=1)m[f]&&l(m[f]);return t}_createItemsFragment(e,t=document.createDocumentFragment()){let{shouldSortItems:i,sorter:s,removeItemButton:r}=this.config;return i&&!this._isSelectOneElement&&e.sort(s),this._isTextElement?this.passedElement.value=e.map(({value:o})=>o).join(this.config.delimiter):this.passedElement.options=e,e.forEach(o=>{let a=this._getTemplate("item",o,r);t.appendChild(a)}),t}_triggerChange(e){e!=null&&this.passedElement.triggerEvent(j.change,{value:e})}_selectPlaceholderChoice(e){this._addItem({value:e.value,label:e.label,choiceId:e.id,groupId:e.groupId,placeholder:e.placeholder}),this._triggerChange(e.value)}_handleButtonAction(e,t){if(!(e&&t&&this.config.removeItems&&this.config.removeItemButton))return;let i=t.parentNode&&t.parentNode.dataset.id,s=i&&e.find(r=>r.id===parseInt(i,10));s&&(this._removeItem(s),this._triggerChange(s.value),this._isSelectOneElement&&this._store.placeholderChoice&&this._selectPlaceholderChoice(this._store.placeholderChoice))}_handleItemAction(e,t,i=!1){if(!e||!t||!this.config.removeItems||this._isSelectOneElement)return;let s=t.dataset.id;e.forEach(r=>{r.id!==parseInt(`${s}`,10)||r.highlighted?!i&&r.highlighted&&this.unhighlightItem(r):this.highlightItem(r)}),this.input.focus()}_handleChoiceAction(e,t){if(!e||!t)return;let{id:i}=t.dataset,s=i&&this._store.getChoiceById(i);if(!s)return;let r=e[0]&&e[0].keyCode?e[0].keyCode:void 0,o=this.dropdown.isActive;s.keyCode=r,this.passedElement.triggerEvent(j.choice,{choice:s}),!s.selected&&!s.disabled&&this._canAddItem(e,s.value).response&&(this._addItem({value:s.value,label:s.label,choiceId:s.id,groupId:s.groupId,customProperties:s.customProperties,placeholder:s.placeholder,keyCode:s.keyCode}),this._triggerChange(s.value)),this.clearInput(),o&&this._isSelectOneElement&&(this.hideDropdown(!0),this.containerOuter.focus())}_handleBackspace(e){if(!this.config.removeItems||!e)return;let t=e[e.length-1],i=e.some(s=>s.highlighted);this.config.editItems&&!i&&t?(this.input.value=t.value,this.input.setWidth(),this._removeItem(t),this._triggerChange(t.value)):(i||this.highlightItem(t,!1),this.removeHighlightedItems(!0))}_startLoading(){this._store.dispatch(pt(!0))}_stopLoading(){this._store.dispatch(pt(!1))}_handleLoadingState(e=!0){let t=this.itemList.getChild(`.${this.config.classNames.placeholder}`);e?(this.disable(),this.containerOuter.addLoadingState(),this._isSelectOneElement?t?t.innerHTML=this.config.loadingText:(t=this._getTemplate("placeholder",this.config.loadingText),t&&this.itemList.append(t)):this.input.placeholder=this.config.loadingText):(this.enable(),this.containerOuter.removeLoadingState(),this._isSelectOneElement?t&&(t.innerHTML=this._placeholderValue||""):this.input.placeholder=this._placeholderValue||"")}_handleSearch(e){if(!this.input.isFocussed)return;let{choices:t}=this._store,{searchFloor:i,searchChoices:s}=this.config,r=t.some(o=>!o.active);if(e!=null&&e.length>=i){let o=s?this._searchChoices(e):0;this.passedElement.triggerEvent(j.search,{value:e,resultCount:o})}else r&&(this._isSearching=!1,this._store.dispatch(Te(!0)))}_canAddItem(e,t){let i=!0,s=typeof this.config.addItemText=="function"?this.config.addItemText(t):this.config.addItemText;if(!this._isSelectOneElement){let r=((o,a,l="value")=>o.some(h=>typeof a=="string"?h[l]===a.trim():h[l]===a))(e,t);this.config.maxItemCount>0&&this.config.maxItemCount<=e.length&&(i=!1,s=typeof this.config.maxItemText=="function"?this.config.maxItemText(this.config.maxItemCount):this.config.maxItemText),!this.config.duplicateItemsAllowed&&r&&i&&(i=!1,s=typeof this.config.uniqueItemText=="function"?this.config.uniqueItemText(t):this.config.uniqueItemText),this._isTextElement&&this.config.addItems&&i&&typeof this.config.addItemFilter=="function"&&!this.config.addItemFilter(t)&&(i=!1,s=typeof this.config.customAddItemText=="function"?this.config.customAddItemText(t):this.config.customAddItemText)}return{response:i,notice:s}}_searchChoices(e){let t=typeof e=="string"?e.trim():e,i=typeof this._currentValue=="string"?this._currentValue.trim():this._currentValue;if(t.length<1&&t===`${i} `)return 0;let s=this._store.searchableChoices,r=t,o=Object.assign(this.config.fuseOptions,{keys:[...this.config.searchFields],includeMatches:!0}),a=new U(s,o).search(r);return this._currentValue=t,this._highlightPosition=0,this._isSearching=!0,this._store.dispatch((l=>({type:H.FILTER_CHOICES,results:l}))(a)),a.length}_addEventListeners(){let{documentElement:e}=document;e.addEventListener("touchend",this._onTouchEnd,!0),this.containerOuter.element.addEventListener("keydown",this._onKeyDown,!0),this.containerOuter.element.addEventListener("mousedown",this._onMouseDown,!0),e.addEventListener("click",this._onClick,{passive:!0}),e.addEventListener("touchmove",this._onTouchMove,{passive:!0}),this.dropdown.element.addEventListener("mouseover",this._onMouseOver,{passive:!0}),this._isSelectOneElement&&(this.containerOuter.element.addEventListener("focus",this._onFocus,{passive:!0}),this.containerOuter.element.addEventListener("blur",this._onBlur,{passive:!0})),this.input.element.addEventListener("keyup",this._onKeyUp,{passive:!0}),this.input.element.addEventListener("focus",this._onFocus,{passive:!0}),this.input.element.addEventListener("blur",this._onBlur,{passive:!0}),this.input.element.form&&this.input.element.form.addEventListener("reset",this._onFormReset,{passive:!0}),this.input.addEventListeners()}_removeEventListeners(){let{documentElement:e}=document;e.removeEventListener("touchend",this._onTouchEnd,!0),this.containerOuter.element.removeEventListener("keydown",this._onKeyDown,!0),this.containerOuter.element.removeEventListener("mousedown",this._onMouseDown,!0),e.removeEventListener("click",this._onClick),e.removeEventListener("touchmove",this._onTouchMove),this.dropdown.element.removeEventListener("mouseover",this._onMouseOver),this._isSelectOneElement&&(this.containerOuter.element.removeEventListener("focus",this._onFocus),this.containerOuter.element.removeEventListener("blur",this._onBlur)),this.input.element.removeEventListener("keyup",this._onKeyUp),this.input.element.removeEventListener("focus",this._onFocus),this.input.element.removeEventListener("blur",this._onBlur),this.input.element.form&&this.input.element.form.removeEventListener("reset",this._onFormReset),this.input.removeEventListeners()}_onKeyDown(e){let{keyCode:t}=e,{activeItems:i}=this._store,s=this.input.isFocussed,r=this.dropdown.isActive,o=this.itemList.hasChildren(),a=String.fromCharCode(t),l=/[a-zA-Z0-9-_ ]/.test(a),{BACK_KEY:h,DELETE_KEY:c,ENTER_KEY:g,A_KEY:p,ESC_KEY:m,UP_KEY:f,DOWN_KEY:d,PAGE_UP_KEY:u,PAGE_DOWN_KEY:b}=me;switch(this._isTextElement||r||!l||(this.showDropdown(),this.input.isFocussed||(this.input.value+=a.toLowerCase())),t){case p:return this._onSelectKey(e,o);case g:return this._onEnterKey(e,i,r);case m:return this._onEscapeKey(r);case f:case u:case d:case b:return this._onDirectionKey(e,r);case c:case h:return this._onDeleteKey(e,i,s)}}_onKeyUp({target:e,keyCode:t}){let{value:i}=this.input,{activeItems:s}=this._store,r=this._canAddItem(s,i),{BACK_KEY:o,DELETE_KEY:a}=me;if(this._isTextElement)if(r.notice&&i){let l=this._getTemplate("notice",r.notice);this.dropdown.element.innerHTML=l.outerHTML,this.showDropdown(!0)}else this.hideDropdown(!0);else{let l=(t===o||t===a)&&e&&!e.value,h=!this._isTextElement&&this._isSearching,c=this._canSearch&&r.response;l&&h?(this._isSearching=!1,this._store.dispatch(Te(!0))):c&&this._handleSearch(this.input.rawValue)}this._canSearch=this.config.searchEnabled}_onSelectKey(e,t){let{ctrlKey:i,metaKey:s}=e;(i||s)&&t&&(this._canSearch=!1,this.config.removeItems&&!this.input.value&&this.input.element===document.activeElement&&this.highlightAll())}_onEnterKey(e,t,i){let{target:s}=e,{ENTER_KEY:r}=me,o=s&&s.hasAttribute("data-button");if(this._isTextElement&&s&&s.value){let{value:a}=this.input;this._canAddItem(t,a).response&&(this.hideDropdown(!0),this._addItem({value:a}),this._triggerChange(a),this.clearInput())}if(o&&(this._handleButtonAction(t,s),e.preventDefault()),i){let a=this.dropdown.getChild(`.${this.config.classNames.highlightedState}`);a&&(t[0]&&(t[0].keyCode=r),this._handleChoiceAction(t,a)),e.preventDefault()}else this._isSelectOneElement&&(this.showDropdown(),e.preventDefault())}_onEscapeKey(e){e&&(this.hideDropdown(!0),this.containerOuter.focus())}_onDirectionKey(e,t){let{keyCode:i,metaKey:s}=e,{DOWN_KEY:r,PAGE_UP_KEY:o,PAGE_DOWN_KEY:a}=me;if(t||this._isSelectOneElement){this.showDropdown(),this._canSearch=!1;let l=i===r||i===a?1:-1,h="[data-choice-selectable]",c;if(s||i===a||i===o)c=l>0?this.dropdown.element.querySelector(`${h}:last-of-type`):this.dropdown.element.querySelector(h);else{let g=this.dropdown.element.querySelector(`.${this.config.classNames.highlightedState}`);c=g?((p,m,f=1)=>{let d=(f>0?"next":"previous")+"ElementSibling",u=p[d];for(;u;){if(u.matches(m))return u;u=u[d]}return u})(g,h,l):this.dropdown.element.querySelector(h)}c&&(((g,p,m=1)=>{if(!g)return!1;let f;return f=m>0?p.scrollTop+p.offsetHeight>=g.offsetTop+g.offsetHeight:g.offsetTop>=p.scrollTop,f})(c,this.choiceList.element,l)||this.choiceList.scrollToChildElement(c,l),this._highlightChoice(c)),e.preventDefault()}}_onDeleteKey(e,t,i){let{target:s}=e;this._isSelectOneElement||s.value||!i||(this._handleBackspace(t),e.preventDefault())}_onTouchMove(){this._wasTap&&(this._wasTap=!1)}_onTouchEnd(e){let{target:t}=e||e.touches[0];this._wasTap&&this.containerOuter.element.contains(t)&&((t===this.containerOuter.element||t===this.containerInner.element)&&(this._isTextElement?this.input.focus():this._isSelectMultipleElement&&this.showDropdown()),e.stopPropagation()),this._wasTap=!0}_onMouseDown(e){let{target:t}=e;if(!(t instanceof HTMLElement))return;if(ai&&this.choiceList.element.contains(t)){let s=this.choiceList.element.firstElementChild,r=this._direction==="ltr"?e.offsetX>=s.offsetWidth:e.offsetX<s.offsetLeft;this._isScrollingOnIe=r}if(t===this.input.element)return;let i=t.closest("[data-button],[data-item],[data-choice]");if(i instanceof HTMLElement){let s=e.shiftKey,{activeItems:r}=this._store,{dataset:o}=i;"button"in o?this._handleButtonAction(r,i):"item"in o?this._handleItemAction(r,i,s):"choice"in o&&this._handleChoiceAction(r,i)}e.preventDefault()}_onMouseOver({target:e}){e instanceof HTMLElement&&"choice"in e.dataset&&this._highlightChoice(e)}_onClick({target:e}){this.containerOuter.element.contains(e)?this.dropdown.isActive||this.containerOuter.isDisabled?this._isSelectOneElement&&e!==this.input.element&&!this.dropdown.element.contains(e)&&this.hideDropdown():this._isTextElement?document.activeElement!==this.input.element&&this.input.focus():(this.showDropdown(),this.containerOuter.focus()):(this._store.highlightedActiveItems.length>0&&this.unhighlightAll(),this.containerOuter.removeFocusState(),this.hideDropdown(!0))}_onFocus({target:e}){e&&this.containerOuter.element.contains(e)&&{text:()=>{e===this.input.element&&this.containerOuter.addFocusState()},"select-one":()=>{this.containerOuter.addFocusState(),e===this.input.element&&this.showDropdown(!0)},"select-multiple":()=>{e===this.input.element&&(this.showDropdown(!0),this.containerOuter.addFocusState())}}[this.passedElement.element.type]()}_onBlur({target:e}){if(e&&this.containerOuter.element.contains(e)&&!this._isScrollingOnIe){let{activeItems:t}=this._store,i=t.some(s=>s.highlighted);({text:()=>{e===this.input.element&&(this.containerOuter.removeFocusState(),i&&this.unhighlightAll(),this.hideDropdown(!0))},"select-one":()=>{this.containerOuter.removeFocusState(),(e===this.input.element||e===this.containerOuter.element&&!this._canSearch)&&this.hideDropdown(!0)},"select-multiple":()=>{e===this.input.element&&(this.containerOuter.removeFocusState(),this.hideDropdown(!0),i&&this.unhighlightAll())}})[this.passedElement.element.type]()}else this._isScrollingOnIe=!1,this.input.element.focus()}_onFormReset(){var e;this._store.dispatch((e=this._initialState,{type:H.RESET_TO,state:e}))}_highlightChoice(e=null){let t=Array.from(this.dropdown.element.querySelectorAll("[data-choice-selectable]"));if(!t.length)return;let i=e;Array.from(this.dropdown.element.querySelectorAll(`.${this.config.classNames.highlightedState}`)).forEach(s=>{s.classList.remove(this.config.classNames.highlightedState),s.setAttribute("aria-selected","false")}),i?this._highlightPosition=t.indexOf(i):(i=t.length>this._highlightPosition?t[this._highlightPosition]:t[t.length-1],i||(i=t[0])),i.classList.add(this.config.classNames.highlightedState),i.setAttribute("aria-selected","true"),this.passedElement.triggerEvent(j.highlightChoice,{el:i}),this.dropdown.isActive&&(this.input.setActiveDescendant(i.id),this.containerOuter.setActiveDescendant(i.id))}_addItem({value:e,label:t=null,choiceId:i=-1,groupId:s=-1,customProperties:r={},placeholder:o=!1,keyCode:a=-1}){let l=typeof e=="string"?e.trim():e,{items:h}=this._store,c=t||l,g=i||-1,p=s>=0?this._store.getGroupById(s):null,m=h?h.length+1:1;this.config.prependValue&&(l=this.config.prependValue+l.toString()),this.config.appendValue&&(l+=this.config.appendValue.toString()),this._store.dispatch((({value:f,label:d,id:u,choiceId:b,groupId:y,customProperties:v,placeholder:w,keyCode:S})=>({type:H.ADD_ITEM,value:f,label:d,id:u,choiceId:b,groupId:y,customProperties:v,placeholder:w,keyCode:S}))({value:l,label:c,id:m,choiceId:g,groupId:s,customProperties:r,placeholder:o,keyCode:a})),this._isSelectOneElement&&this.removeActiveItems(m),this.passedElement.triggerEvent(j.addItem,{id:m,value:l,label:c,customProperties:r,groupValue:p&&p.value?p.value:null,keyCode:a})}_removeItem(e){let{id:t,value:i,label:s,customProperties:r,choiceId:o,groupId:a}=e,l=a&&a>=0?this._store.getGroupById(a):null;t&&o&&(this._store.dispatch(((h,c)=>({type:H.REMOVE_ITEM,id:h,choiceId:c}))(t,o)),this.passedElement.triggerEvent(j.removeItem,{id:t,value:i,label:s,customProperties:r,groupValue:l&&l.value?l.value:null}))}_addChoice({value:e,label:t=null,isSelected:i=!1,isDisabled:s=!1,groupId:r=-1,customProperties:o={},placeholder:a=!1,keyCode:l=-1}){if(e==null)return;let{choices:h}=this._store,c=t||e,g=h?h.length+1:1,p=`${this._baseId}-${this._idNames.itemChoice}-${g}`;this._store.dispatch((({value:m,label:f,id:d,groupId:u,disabled:b,elementId:y,customProperties:v,placeholder:w,keyCode:S})=>({type:H.ADD_CHOICE,value:m,label:f,id:d,groupId:u,disabled:b,elementId:y,customProperties:v,placeholder:w,keyCode:S}))({id:g,groupId:r,elementId:p,value:e,label:c,disabled:s,customProperties:o,placeholder:a,keyCode:l})),i&&this._addItem({value:e,label:c,choiceId:g,customProperties:o,placeholder:a,keyCode:l})}_addGroup({group:e,id:t,valueKey:i="value",labelKey:s="label"}){let r=ft("Object",e)?e.choices:Array.from(e.getElementsByTagName("OPTION")),o=t||Math.floor(new Date().valueOf()*Math.random()),a=!!e.disabled&&e.disabled;if(r){this._store.dispatch(ut({value:e.label,id:o,active:!0,disabled:a}));let l=h=>{let c=h.disabled||h.parentNode&&h.parentNode.disabled;this._addChoice({value:h[i],label:ft("Object",h)?h[s]:h.innerHTML,isSelected:h.selected,isDisabled:c,groupId:o,customProperties:h.customProperties,placeholder:h.placeholder})};r.forEach(l)}else this._store.dispatch(ut({value:e.label,id:e.id,active:!1,disabled:e.disabled}))}_getTemplate(e,...t){return this._templates[e].call(this,this.config,...t)}_createTemplates(){let{callbackOnCreateTemplates:e}=this.config,t={};e&&typeof e=="function"&&(t=e.call(this,Qt)),this._templates=rt(Oe,t)}_createElements(){this.containerOuter=new ye({element:this._getTemplate("containerOuter",this._direction,this._isSelectElement,this._isSelectOneElement,this.config.searchEnabled,this.passedElement.element.type),classNames:this.config.classNames,type:this.passedElement.element.type,position:this.config.position}),this.containerInner=new ye({element:this._getTemplate("containerInner"),classNames:this.config.classNames,type:this.passedElement.element.type,position:this.config.position}),this.input=new Be({element:this._getTemplate("input",this._placeholderValue),classNames:this.config.classNames,type:this.passedElement.element.type,preventPaste:!this.config.paste}),this.choiceList=new ve({element:this._getTemplate("choiceList",this._isSelectOneElement)}),this.itemList=new ve({element:this._getTemplate("itemList",this._isSelectOneElement)}),this.dropdown=new ke({element:this._getTemplate("dropdown"),classNames:this.config.classNames,type:this.passedElement.element.type})}_createStructure(){this.passedElement.conceal(),this.containerInner.wrap(this.passedElement.element),this.containerOuter.wrap(this.containerInner.element),this._isSelectOneElement?this.input.placeholder=this.config.searchPlaceholderValue||"":this._placeholderValue&&(this.input.placeholder=this._placeholderValue,this.input.setWidth()),this.containerOuter.element.appendChild(this.containerInner.element),this.containerOuter.element.appendChild(this.dropdown.element),this.containerInner.element.appendChild(this.itemList.element),this._isTextElement||this.dropdown.element.appendChild(this.choiceList.element),this._isSelectOneElement?this.config.searchEnabled&&this.dropdown.element.insertBefore(this.input.element,this.dropdown.element.firstChild):this.containerInner.element.appendChild(this.input.element),this._isSelectElement&&(this._highlightPosition=0,this._isSearching=!1,this._startLoading(),this._presetGroups.length?this._addPredefinedGroups(this._presetGroups):this._addPredefinedChoices(this._presetChoices),this._stopLoading()),this._isTextElement&&this._addPredefinedItems(this._presetItems)}_addPredefinedGroups(e){let t=this.passedElement.placeholderOption;t&&t.parentNode&&t.parentNode.tagName==="SELECT"&&this._addChoice({value:t.value,label:t.innerHTML,isSelected:t.selected,isDisabled:t.disabled,placeholder:!0}),e.forEach(i=>this._addGroup({group:i,id:i.id||null}))}_addPredefinedChoices(e){this.config.shouldSort&&e.sort(this.config.sorter);let t=e.some(s=>s.selected),i=e.findIndex(s=>s.disabled===void 0||!s.disabled);e.forEach((s,r)=>{let{value:o="",label:a,customProperties:l,placeholder:h}=s;if(this._isSelectElement)if(s.choices)this._addGroup({group:s,id:s.id||null});else{let c=!!(this._isSelectOneElement&&!t&&r===i)||s.selected,g=s.disabled;this._addChoice({value:o,label:a,isSelected:!!c,isDisabled:!!g,placeholder:!!h,customProperties:l})}else this._addChoice({value:o,label:a,isSelected:!!s.selected,isDisabled:!!s.disabled,placeholder:!!s.placeholder,customProperties:l})})}_addPredefinedItems(e){e.forEach(t=>{typeof t=="object"&&t.value&&this._addItem({value:t.value,label:t.label,choiceId:t.id,customProperties:t.customProperties,placeholder:t.placeholder}),typeof t=="string"&&this._addItem({value:t})})}_setChoiceOrItem(e){({object:()=>{e.value&&(this._isTextElement?this._addItem({value:e.value,label:e.label,choiceId:e.id,customProperties:e.customProperties,placeholder:e.placeholder}):this._addChoice({value:e.value,label:e.label,isSelected:!0,isDisabled:!1,customProperties:e.customProperties,placeholder:e.placeholder}))},string:()=>{this._isTextElement?this._addItem({value:e}):this._addChoice({value:e,label:e,isSelected:!0,isDisabled:!1})}})[It(e).toLowerCase()]()}_findAndSelectChoiceByValue(e){let{choices:t}=this._store,i=t.find(s=>this.config.valueComparer(s.value,e));i&&!i.selected&&this._addItem({value:i.value,label:i.label,choiceId:i.id,groupId:i.groupId,customProperties:i.customProperties,placeholder:i.placeholder,keyCode:i.keyCode})}_generatePlaceholderValue(){if(this._isSelectElement&&this.passedElement.placeholderOption){let{placeholderOption:s}=this.passedElement;return s?s.text:null}let{placeholder:e,placeholderValue:t}=this.config,{element:{dataset:i}}=this.passedElement;if(e){if(t)return t;if(i.placeholder)return i.placeholder}return null}};var Q=GM_info.script.name.toString(),oe=GM_info.script.version.toString(),ci="color: cornflowerblue;",Ot="https://raw.githubusercontent.com/Egorrko/wplace-templates/refs/heads/main/",de="https://freakland.egorrko.ru";function hi(n){let e=document.createElement("script");e.setAttribute("bm-name",Q),e.setAttribute("bm-cStyle",ci),e.textContent=`(${n})();`,document.documentElement?.appendChild(e),e.remove()}hi(()=>{let n=document.currentScript,e=n?.getAttribute("bm-name")||"Blue Marble",t=n?.getAttribute("bm-cStyle")||"",i=new Map;window.addEventListener("message",r=>{let{source:o,endpoint:a,blobID:l,blobData:h,blink:c}=r.data,g=Date.now()-c;if(console.groupCollapsed(`%c${e}%c: ${i.size} Recieved IMAGE message about blob "${l}"`,t,""),console.log(`Blob fetch took %c${String(Math.floor(g/6e4)).padStart(2,"0")}:${String(Math.floor(g/1e3)%60).padStart(2,"0")}.${String(g%1e3).padStart(3,"0")}%c MM:SS.mmm`,t,""),console.groupEnd(),o=="blue-marble"&&l&&h&&!a){let p=i.get(l);typeof p=="function"?p(h):ze(`%c${e}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,t,"",l),i.delete(l)}});let s=window.fetch;window.fetch=async function(...r){let o=await s.apply(this,r),a=o.clone(),l=(r[0]instanceof Request?r[0]?.url:r[0])||"ignore",h=a.headers.get("content-type")||"";if(h.includes("application/json"))console.log(`%c${e}%c: Sending JSON message about endpoint "${l}"`,t,""),a.json().then(c=>{window.postMessage({source:"blue-marble",endpoint:l,jsonData:c},"*")}).catch(c=>{console.error(`%c${e}%c: Failed to parse JSON: `,t,"",c)});else if(h.includes("image/")&&!l.includes("openfreemap")&&!l.includes("maps")){let c=Date.now(),g=await a.blob();return console.log(`%c${e}%c: ${i.size} Sending IMAGE message about endpoint "${l}"`,t,""),new Promise(p=>{let m=crypto.randomUUID();i.set(m,f=>{p(new Response(f,{headers:a.headers,status:a.status,statusText:a.statusText})),console.log(`%c${e}%c: ${i.size} Processed blob "${m}"`,t,"")}),window.postMessage({source:"blue-marble",endpoint:l,blobID:m,blobData:g,blink:c})}).catch(p=>{let m=Date.now();console.error(`%c${e}%c: Failed to Promise blob!`,t,""),console.groupCollapsed(`%c${e}%c: Details of failed blob Promise:`,t,""),console.log(`Endpoint: ${l}
There are ${i.size} blobs processing...
Blink: ${c.toLocaleString()}
Time Since Blink: ${String(Math.floor(m/6e4)).padStart(2,"0")}:${String(Math.floor(m/1e3)%60).padStart(2,"0")}.${String(m%1e3).padStart(3,"0")} MM:SS.mmm`),console.error("Exception stack:",p),console.groupEnd()})}return o}});GM_addStyle(`.choices{position:relative;overflow:hidden;margin-bottom:24px;font-size:16px}.choices:focus{outline:0}.choices:last-child{margin-bottom:0}.choices.is-open{overflow:initial}.choices.is-disabled .choices__inner,.choices.is-disabled .choices__input{background-color:#eaeaea;cursor:not-allowed;-webkit-user-select:none;user-select:none}.choices.is-disabled .choices__item{cursor:not-allowed}.choices [hidden]{display:none!important}.choices[data-type*=select-one]{cursor:pointer}.choices[data-type*=select-one] .choices__inner{padding-bottom:7.5px}.choices[data-type*=select-one] .choices__input{display:block;width:100%;padding:10px;border-bottom:1px solid #ddd;background-color:#fff;margin:0}.choices[data-type*=select-one] .choices__button{background-image:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjEiIGhlaWdodD0iMjEiIHZpZXdCb3g9IjAgMCAyMSAyMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSIjMDAwIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0yLjU5Mi4wNDRsMTguMzY0IDE4LjM2NC0yLjU0OCAyLjU0OEwuMDQ0IDIuNTkyeiIvPjxwYXRoIGQ9Ik0wIDE4LjM2NEwxOC4zNjQgMGwyLjU0OCAyLjU0OEwyLjU0OCAyMC45MTJ6Ii8+PC9nPjwvc3ZnPg==);padding:0;background-size:8px;position:absolute;top:50%;right:0;margin-top:-10px;margin-right:25px;height:20px;width:20px;border-radius:10em;opacity:.25}.choices[data-type*=select-one] .choices__button:focus,.choices[data-type*=select-one] .choices__button:hover{opacity:1}.choices[data-type*=select-one] .choices__button:focus{box-shadow:0 0 0 2px #00bcd4}.choices[data-type*=select-one] .choices__item[data-value=""] .choices__button{display:none}.choices[data-type*=select-one]:after{content:"";height:0;width:0;border-style:solid;border-color:#333 transparent transparent;border-width:5px;position:absolute;right:11.5px;top:50%;margin-top:-2.5px;pointer-events:none}.choices[data-type*=select-one].is-open:after{border-color:transparent transparent #333;margin-top:-7.5px}.choices[data-type*=select-one][dir=rtl]:after{left:11.5px;right:auto}.choices[data-type*=select-one][dir=rtl] .choices__button{right:auto;left:0;margin-left:25px;margin-right:0}.choices[data-type*=select-multiple] .choices__inner,.choices[data-type*=text] .choices__inner{cursor:text}.choices[data-type*=select-multiple] .choices__button,.choices[data-type*=text] .choices__button{position:relative;display:inline-block;margin:0 -4px 0 8px;padding-left:16px;border-left:1px solid #008fa1;background-image:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjEiIGhlaWdodD0iMjEiIHZpZXdCb3g9IjAgMCAyMSAyMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSIjRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0yLjU5Mi4wNDRsMTguMzY0IDE4LjM2NC0yLjU0OCAyLjU0OEwuMDQ0IDIuNTkyeiIvPjxwYXRoIGQ9Ik0wIDE4LjM2NEwxOC4zNjQgMGwyLjU0OCAyLjU0OEwyLjU0OCAyMC45MTJ6Ii8+PC9nPjwvc3ZnPg==);background-size:8px;width:8px;line-height:1;opacity:.75;border-radius:0}.choices[data-type*=select-multiple] .choices__button:focus,.choices[data-type*=select-multiple] .choices__button:hover,.choices[data-type*=text] .choices__button:focus,.choices[data-type*=text] .choices__button:hover{opacity:1}.choices__inner{display:inline-block;vertical-align:top;width:100%;background-color:#f9f9f9;padding:7.5px 7.5px 3.75px;border:1px solid #ddd;border-radius:2.5px;font-size:14px;min-height:44px;overflow:hidden}.is-focused .choices__inner,.is-open .choices__inner{border-color:#b7b7b7}.is-open .choices__inner{border-radius:2.5px 2.5px 0 0}.is-flipped.is-open .choices__inner{border-radius:0 0 2.5px 2.5px}.choices__list{margin:0;padding-left:0;list-style:none}.choices__list--single{display:inline-block;padding:4px 16px 4px 4px;width:100%}[dir=rtl] .choices__list--single{padding-right:4px;padding-left:16px}.choices__list--single .choices__item{width:100%}.choices__list--multiple{display:inline}.choices__list--multiple .choices__item{display:inline-block;vertical-align:middle;border-radius:20px;padding:4px 10px;font-size:12px;font-weight:500;margin-right:3.75px;margin-bottom:3.75px;background-color:#00bcd4;border:1px solid #00a5bb;color:#fff;word-break:break-all;box-sizing:border-box}.choices__list--multiple .choices__item[data-deletable]{padding-right:5px}[dir=rtl] .choices__list--multiple .choices__item{margin-right:0;margin-left:3.75px}.choices__list--multiple .choices__item.is-highlighted{background-color:#00a5bb;border:1px solid #008fa1}.is-disabled .choices__list--multiple .choices__item{background-color:#aaa;border:1px solid #919191}.choices__list--dropdown{visibility:hidden;z-index:1;position:absolute;width:100%;background-color:#fff;border:1px solid #ddd;top:100%;margin-top:-1px;border-bottom-left-radius:2.5px;border-bottom-right-radius:2.5px;overflow:hidden;word-break:break-all;will-change:visibility}.choices__list--dropdown.is-active{visibility:visible}.is-open .choices__list--dropdown{border-color:#b7b7b7}.is-flipped .choices__list--dropdown{top:auto;bottom:100%;margin-top:0;margin-bottom:-1px;border-radius:.25rem .25rem 0 0}.choices__list--dropdown .choices__list{position:relative;max-height:300px;overflow:auto;-webkit-overflow-scrolling:touch;will-change:scroll-position}.choices__list--dropdown .choices__item{position:relative;padding:10px;font-size:14px}[dir=rtl] .choices__list--dropdown .choices__item{text-align:right}@media (min-width:640px){.choices__list--dropdown .choices__item--selectable{padding-right:100px}.choices__list--dropdown .choices__item--selectable:after{content:attr(data-select-text);font-size:12px;opacity:0;position:absolute;right:10px;top:50%;transform:translateY(-50%)}[dir=rtl] .choices__list--dropdown .choices__item--selectable{text-align:right;padding-left:100px;padding-right:10px}[dir=rtl] .choices__list--dropdown .choices__item--selectable:after{right:auto;left:10px}}.choices__list--dropdown .choices__item--selectable.is-highlighted{background-color:#f2f2f2}.choices__list--dropdown .choices__item--selectable.is-highlighted:after{opacity:.5}.choices__item{cursor:default}.choices__item--selectable{cursor:pointer}.choices__item--disabled{cursor:not-allowed;-webkit-user-select:none;user-select:none;opacity:.5}.choices__heading{font-weight:600;font-size:12px;padding:10px;border-bottom:1px solid #f7f7f7;color:gray}.choices__button{text-indent:-9999px;-webkit-appearance:none;appearance:none;border:0;background-color:transparent;background-repeat:no-repeat;background-position:center;cursor:pointer}.choices__button:focus,.choices__input:focus{outline:0}.choices__input{display:inline-block;vertical-align:baseline;background-color:#f9f9f9;font-size:14px;margin-bottom:5px;border:0;border-radius:0;max-width:100%;padding:4px 0 4px 2px}[dir=rtl] .choices__input{padding-right:2px;padding-left:0}.choices__placeholder{opacity:.5}#bm-overlay,#bm-overlay-telemetry{position:fixed;background-color:#b6b9cae6;color:#000;padding:10px;border-radius:8px;z-index:9000;transition:all .3s ease,transform 0s;max-width:300px;width:auto;will-change:transform;backface-visibility:hidden;-webkit-backface-visibility:hidden;transform-style:preserve-3d;-webkit-transform-style:preserve-3d}#bm-contain-userinfo,#bm-overlay hr,#bm-overlay-telemetry hr,#bm-contain-automation,#bm-contain-buttons-action{transition:opacity .2s ease,height .2s ease}div#bm-overlay,div#bm-overlay-telemetry{font-family:Roboto Mono,Courier New,Monaco,DejaVu Sans Mono,monospace,Arial;letter-spacing:.05em}#bm-bar-drag,#bm-bar-drag-telemetry{margin-bottom:.5em;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="5" height="5"><circle cx="3" cy="3" r="1.5" fill="CornflowerBlue" /></svg>') repeat;cursor:grab;width:100%;height:1em}#bm-bar-drag.dragging,#bm-bar-drag-telemetry.dragging{cursor:grabbing}#bm-overlay:has(#bm-bar-drag.dragging),#bm-overlay-telemetry:has(#bm-bar-drag-telemetry.dragging){pointer-events:none;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}#bm-bar-drag.dragging,#bm-bar-drag-telemetry.dragging{pointer-events:auto}#bm-contain-header,#bm-contain-header-telemetry{margin-bottom:.5em}#bm-contain-header[style*="text-align: center"],#bm-contain-header-telemetry[style*="text-align: center"]{display:flex;flex-direction:column;align-items:center;justify-content:center}#bm-overlay[style*="padding: 5px"],#bm-overlay-telemetry[style*="padding: 5px"]{width:auto!important;max-width:300px;min-width:200px}#bm-overlay img{display:inline-block;height:2.5em;margin-right:1ch;vertical-align:middle;transition:opacity .2s ease}#bm-contain-header[style*="text-align: center"] img{display:block;margin:0 auto}#bm-bar-drag,#bm-bar-drag-telemetry{transition:margin-bottom .2s ease}#bm-overlay h1,#bm-overlay-telemetry h1{display:inline-block;font-size:x-large;font-weight:700;vertical-align:middle}#bm-contain-automation input[type=checkbox]{vertical-align:middle;margin-right:.5ch}#bm-contain-automation label{margin-right:.5ch}.bm-help{border:white 1px solid;height:1.5em;width:1.5em;margin-top:2px;text-align:center;line-height:1em;padding:0!important}#bm-button-coords{vertical-align:middle}#bm-button-coords svg{width:50%;margin:0 auto;fill:#111}div:has(>#bm-button-teleport){display:flex;gap:.5ch}#bm-button-favorite svg,#bm-button-template svg{height:1em;margin:2px auto 0;text-align:center;line-height:1em;vertical-align:bottom}#bm-contain-coords input[type=number]{appearance:auto;-moz-appearance:textfield;width:5.5ch;margin-left:1ch;background-color:#0003;padding:0 .5ch;font-size:small}#bm-contain-coords input[type=number]::-webkit-outer-spin-button,#bm-contain-coords input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}#bm-contain-buttons-template{display:flex;flex-direction:row;flex-wrap:wrap;align-content:center;justify-content:center;align-items:center;gap:1ch}div:has(>#bm-input-file-template)>button{width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#bm-input-file-template,input[type=file][id*=template]{display:none!important;visibility:hidden!important;position:absolute!important;left:-9999px!important;top:-9999px!important;width:0!important;height:0!important;opacity:0!important;z-index:-9999!important;pointer-events:none!important}#bm-output-status{font-size:small;background-color:#0003;padding:0 .5ch;height:5rem;min-height:5rem;width:100%}#bm-contain-buttons-action{display:flex;justify-content:space-between}#bm-overlay small{font-size:x-small;color:#d3d3d3}#bm-contain-userinfo,#bm-contain-automation,#bm-contain-coords,#bm-contain-buttons-template,div:has(>#bm-input-file-template),#bm-output-status{margin-top:.5em}#bm-overlay button,#bm-overlay-telemetry button{background-color:#7fa5eb;border-radius:1em;padding:0 .75ch}#bm-overlay button:hover,#bm-overlay button:focus-visible,#bm-overlay-telemetry button:hover,#bm-overlay-telemetry button:focus-visible{background-color:#7fa5eb}#bm-overlay button:active,#bm-overlay-telemetry button:active #bm-overlay button:disabled,#bm-overlay-telemetry button:disabled{background-color:#7fa5eb}#bm-overlay button:disabled,#bm-overlay-telemetry button:disabled{text-decoration:line-through}#bm-selector-templates{background-color:#7fa5eb}#bm-selector-templates:hover{background-color:#6893e2;cursor:pointer}.choices{font-size:14px}.choices__inner{min-height:auto;padding:4px 8px}.choices__list--dropdown .choices__item--choice{font-size:14px;padding:6px 10px}.choices__list--dropdown .choices__item--choice .choices__item-text{white-space:normal;word-wrap:break-word}
`);var ae=document.createElement("link");ae.href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap";ae.rel="preload";ae.as="style";ae.onload=function(){this.onload=null,this.rel="stylesheet"};document.head?.appendChild(ae);var Yi=new ee,B=new z(Q,oe),zi=new z(Q,oe),R=new ie(Q,oe,B),Mt=new se(R);B.setApiManager(Mt);var di=JSON.parse(GM_getValue("bmTemplates","{}"));R.importJSON(di);var ui=JSON.parse(GM_getValue("bmUserSettings","{}"));if(Object.keys(ui).length==0){let n=crypto.randomUUID();GM.setValue("bmUserSettings",JSON.stringify({uuid:n}))}setInterval(()=>{let n=JSON.parse(GM_getValue("bmUserPixels","{}"));if(Object.keys(n).length==0)return;let e=Date.now()-n.updated,t=Math.ceil((n.cooldownMs*(n.max-n.count)/1e3-e/1e3)/60);t>0?B.updateInnerHTML("bm-user-reload","\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0437\u0430\u0440\u044F\u0434\u043E\u0432 \u0447\u0435\u0440\u0435\u0437: <b>"+t+"</b> \u043C\u0438\u043D "):B.updateInnerHTML("bm-user-reload","\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0437\u0430\u0440\u044F\u0434\u043E\u0432 \u0447\u0435\u0440\u0435\u0437: <b>0</b> \u043C\u0438\u043D ")},5e3);setInterval(()=>{GM.xmlHttpRequest({method:"GET",url:`${de}/wplace-api/online`,onload:n=>{let e=JSON.parse(n.responseText);B.updateInnerHTML("bm-user-online",`\u0412 \u043A\u043B\u0430\u043D\u0435 <b>${e.online_count}</b> \u0447\u0435\u043B\u043E\u0432\u0435\u043A \u043E\u043D\u043B\u0430\u0439\u043D.<br> \u0423 \u043A\u043B\u0430\u043D\u0430 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E <b>${e.count}</b> \u043F\u0438\u043A\u0441\u0435\u043B\u0435\u0439 \u0438\u0437 <b>${e.max}</b> \u043C\u0430\u043A\u0441.`)},onerror:n=>{}})},2e4);pi();B.handleDrag("#bm-overlay","#bm-bar-drag");Mt.spontaneousResponseListener(B);mi();Ye(`%c${Q}%c (${oe}) userscript has loaded!`,"color: cornflowerblue;","");function mi(){new MutationObserver((e,t)=>{let i=document.querySelector("#color-1");if(!i)return;let s=document.querySelector("#bm-button-move");s||(s=document.createElement("button"),s.id="bm-button-move",s.textContent="Move \u2191",s.className="btn btn-soft",s.onclick=function(){let o=this.parentNode.parentNode.parentNode.parentNode,a=this.textContent=="Move \u2191";o.parentNode.className=o.parentNode.className.replace(a?"bottom":"top",a?"top":"bottom"),o.style.borderTopLeftRadius=a?"0px":"var(--radius-box)",o.style.borderTopRightRadius=a?"0px":"var(--radius-box)",o.style.borderBottomLeftRadius=a?"var(--radius-box)":"0px",o.style.borderBottomRightRadius=a?"var(--radius-box)":"0px",this.textContent=a?"Move \u2193":"Move \u2191"},i.parentNode.parentNode.parentNode.parentNode.querySelector("h2").parentNode?.appendChild(s))}).observe(document.body,{childList:!0,subtree:!0})}function pi(){let n=!1,e={};try{e=JSON.parse(GM_getValue("bmCoords","{}"))||{}}catch{e={}}let t=async s=>{let o=await(await fetch(`${Ot}/data.json`)).json();GM.setValue("bmOptions",JSON.stringify(o)),B.handleSelectorStatus(o.images),i(s),B.handleDisplayStatus("\u0421\u043A\u0430\u0447\u0438\u0432\u0430\u0435\u043C \u0448\u0430\u0431\u043B\u043E\u043D! \u041E\u0436\u0438\u0434\u0430\u0439\u0442\u0435...")},i=async s=>{let r=JSON.parse(s.value),a=await(await fetch(`${Ot}${r.path}`)).blob(),l=r.name;R.createTemplate(a,r.id,l,[r.coords.tx,r.coords.ty,r.coords.px,r.coords.py]),B.handleDisplayStatus(`\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0448\u0430\u0431\u043B\u043E\u043D "${l}"! \u041E\u0436\u0438\u0434\u0430\u0439\u0442\u0435...`)};B.addDiv({id:"bm-overlay",style:"top: 10px; right: 75px;"}).addDiv({id:"bm-contain-header"}).addDiv({id:"bm-bar-drag"}).buildElement().addImg({alt:"Blue Marble Icon - Click to minimize/maximize",src:"https://freakland.egorrko.ru/favicon/favicon-96x96.png",style:"cursor: pointer;"},(s,r)=>{r.addEventListener("click",()=>{n=!n;let o=document.querySelector("#bm-overlay"),a=document.querySelector("#bm-contain-header"),l=document.querySelector("#bm-bar-drag"),h=document.querySelector("#bm-contain-coords"),c=document.querySelector("#bm-button-coords"),g=document.querySelector("#bm-button-create"),p=document.querySelector("#bm-button-enable"),m=document.querySelector("#bm-button-disable"),f=document.querySelectorAll("#bm-contain-coords input");n||(o.style.width="auto",o.style.maxWidth="300px",o.style.minWidth="200px",o.style.padding="10px"),["#bm-overlay h1","#bm-contain-userinfo","#bm-overlay hr","#bm-contain-automation > *:not(#bm-contain-coords)","#bm-input-file-template","#bm-contain-buttons-action",`#${s.outputStatusId}`,"#bm-contain-colorfilter"].forEach(u=>{document.querySelectorAll(u).forEach(y=>{y.style.display=n?"none":""})}),n?(h&&(h.style.display="none"),c&&(c.style.display="none"),g&&(g.style.display="none"),p&&(p.style.display="none"),m&&(m.style.display="none"),f.forEach(u=>{u.style.display="none"}),o.style.width="60px",o.style.height="76px",o.style.maxWidth="60px",o.style.minWidth="60px",o.style.padding="8px",r.style.marginLeft="3px",a.style.textAlign="center",a.style.margin="0",a.style.marginBottom="0",l&&(l.style.display="",l.style.marginBottom="0.25em")):(h&&(h.style.display="",h.style.flexDirection="",h.style.justifyContent="",h.style.alignItems="",h.style.gap="",h.style.textAlign="",h.style.margin=""),c&&(c.style.display=""),g&&(g.style.display="",g.style.marginTop=""),p&&(p.style.display="",p.style.marginTop=""),m&&(m.style.display="",m.style.marginTop=""),f.forEach(u=>{u.style.display=""}),r.style.marginLeft="",o.style.padding="10px",a.style.textAlign="",a.style.margin="",a.style.marginBottom="",l&&(l.style.marginBottom="0.5em"),o.style.width="",o.style.height=""),r.alt=n?"Blue Marble Icon - Minimized (Click to maximize)":"Blue Marble Icon - Maximized (Click to minimize)"})}).buildElement().addHeader(1,{textContent:Q}).buildElement().buildElement().addHr().buildElement().addDiv({id:"bm-contain-userinfo"}).addP({id:"bm-user-name",textContent:"\u042E\u0437\u0435\u0440\u043D\u0435\u0439\u043C:"}).buildElement().addP({id:"bm-user-droplets",textContent:"\u041A\u0430\u043F\u0435\u043B\u044C:"}).buildElement().addP({id:"bm-user-nextlevel",textContent:"\u0421\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0439 \u0443\u0440\u043E\u0432\u0435\u043D\u044C \u0447\u0435\u0440\u0435\u0437:"}).buildElement().addP({id:"bm-user-reload",textContent:""}).buildElement().addP({id:"bm-user-online",textContent:""}).buildElement().buildElement().addHr().buildElement().addDiv({id:"bm-contain-automation"}).addDiv({id:"bm-contain-selector-templates",style:"margin-top: 10px;"}).addSelector({id:"bm-selector-templates"},async(s,r)=>{await t(r);let o=new Se(r,{shouldSort:!1,searchEnabled:!1,itemSelectText:""});r.addEventListener("change",async a=>{i(r)})}).buildElement().buildElement().addDiv({id:"bm-contain-colorfilter",style:"max-height: 140px; overflow: auto; border: 1px solid rgba(255,255,255,0.1); padding: 4px; border-radius: 4px; display: none;"}).addDiv({style:"display: flex; gap: 6px; margin-bottom: 6px;"}).addButton({id:"bm-button-colors-enable-all",textContent:"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432\u0441\u0435 \u0446\u0432\u0435\u0442\u0430"},(s,r)=>{r.onclick=()=>{let o=R.templatesArray[0];o?.colorPalette&&(Object.values(o.colorPalette).forEach(a=>a.enabled=!0),buildColorFilterList(),s.handleDisplayStatus("\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432\u0441\u0435 \u0446\u0432\u0435\u0442\u0430"))}}).buildElement().addButton({id:"bm-button-colors-disable-all",textContent:"\u0412\u044B\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432\u0441\u0435 \u0446\u0432\u0435\u0442\u0430"},(s,r)=>{r.onclick=()=>{let o=R.templatesArray[0];o?.colorPalette&&(Object.values(o.colorPalette).forEach(a=>a.enabled=!1),buildColorFilterList(),s.handleDisplayStatus("\u0412\u044B\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432\u0441\u0435 \u0446\u0432\u0435\u0442\u0430"))}}).buildElement().buildElement().addDiv({id:"bm-colorfilter-list"}).buildElement().buildElement().addDiv({id:"bm-contain-buttons-template"}).addButton({id:"bm-button-enable",textContent:"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C"},(s,r)=>{r.onclick=()=>{s.apiManager?.templateManager?.setTemplatesShouldBeDrawn(!0),s.handleDisplayStatus("\u0412\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u0448\u0430\u0431\u043B\u043E\u043D\u0430! \u041E\u0436\u0438\u0434\u0430\u0439\u0442\u0435...")}}).buildElement().addButton({id:"bm-button-disable",textContent:"\u0412\u044B\u043A\u043B\u044E\u0447\u0438\u0442\u044C"},(s,r)=>{r.onclick=()=>{s.apiManager?.templateManager?.setTemplatesShouldBeDrawn(!1),s.handleDisplayStatus("\u0412\u044B\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u0448\u0430\u0431\u043B\u043E\u043D\u0430! \u041E\u0436\u0438\u0434\u0430\u0439\u0442\u0435...")}}).buildElement().buildElement().addTextarea({id:B.outputStatusId,placeholder:`\u0421\u0442\u0430\u0442\u0443\u0441: \u0421\u043F\u0438\u0442...
\u0412\u0435\u0440\u0441\u0438\u044F: ${oe}`,readOnly:!0}).buildElement().addDiv({id:"bm-contain-buttons-action"}).addDiv().addHyperLink({href:"https://t.me/YrodstvoDesinova",target:"_blank",textContent:"\u0413\u0435\u043D\u0435\u0440\u0430\u043B: @MishaDesinov",style:"font-size: 12px;"}).buildElement().addDiv().addHyperLink({href:"https://freakland.egorrko.ru",target:"_blank",textContent:"\u0420\u0430\u0437\u0440\u0430\u0431\u043E\u0442\u0447\u0438\u043A: @Egorrko",style:"font-size: 12px;"}).buildElement().buildElement().buildElement().buildOverlay(document.body),window.buildColorFilterList=function(){let r=document.querySelector("#bm-colorfilter-list"),o=R.templatesArray?.[0];if(!r||!o?.colorPalette){r&&(r.innerHTML="<small>No template colors to display.</small>");return}r.innerHTML="";let a=Object.entries(o.colorPalette).sort((l,h)=>h[1].count-l[1].count);for(let[l,h]of a){let c=document.createElement("div");c.style.display="flex",c.style.alignItems="center",c.style.gap="8px",c.style.margin="4px 0";let g=document.createElement("div");g.style.width="14px",g.style.height="14px",g.style.border="1px solid rgba(255,255,255,0.5)";let p=document.createElement("span");p.style.fontSize="12px";let m=`${h.count.toLocaleString()}`;if(l==="other")g.style.background="#888",m=`Other \u2022 ${m}`;else if(l==="#deface")g.style.background="#deface",m=`Transparent \u2022 ${m}`;else{let[d,u,b]=l.split(",").map(Number);g.style.background=`rgb(${d},${u},${b})`;try{let y=R.templatesArray?.[0]?.rgbToMeta?.get(l);if(y&&typeof y.id=="number"){let v=y?.name||`rgb(${d},${u},${b})`,w=y.premium?"\u2605 ":"";m=`#${y.id} ${w}${v} \u2022 ${m}`}}catch{}}p.textContent=m;let f=document.createElement("input");f.type="checkbox",f.checked=!!h.enabled,f.addEventListener("change",()=>{h.enabled=f.checked,B.handleDisplayStatus(`${f.checked?"Enabled":"Disabled"} ${l}`);try{let d=R.templatesArray?.[0],u=d?.storageKey;d&&u&&R.templatesJSON?.templates?.[u]&&(R.templatesJSON.templates[u].palette=d.colorPalette,GM.setValue("bmTemplates",JSON.stringify(R.templatesJSON)))}catch{}}),c.appendChild(f),c.appendChild(g),c.appendChild(p),r.appendChild(c)}},window.addEventListener("message",s=>{if(s?.data?.bmEvent==="bm-rebuild-color-list")try{buildColorFilterList()}catch{}}),setTimeout(()=>{try{if(R.templatesArray?.length>0){let s=document.querySelector("#bm-contain-colorfilter");s&&(s.style.display=""),buildColorFilterList()}}catch{}},0)}})();
